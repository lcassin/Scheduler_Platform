@page "/admin/users"
@using SchedulerPlatform.UI.Services
@using SchedulerPlatform.UI.Models
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject IUserManagementService UserManagementService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IPermissionService PermissionService
@inject IUserTimeZoneService TimeZoneService

<PageTitle>User Management</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
    <div class="d-flex justify-space-between align-center mb-4">
        <MudText Typo="Typo.h4">User Management</MudText>
        @if (_canCreateUsers)
        {
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.PersonAdd"
                       OnClick="OpenCreateUserDialog">
                Add User
            </MudButton>
        }
    </div>

    <MudPaper Class="pa-4 mb-4">
        <div class="d-flex gap-4 align-center">
            <MudTextField @bind-Value="_searchTerm"
                          Label="Search users"
                          Placeholder="Search by name or email"
                          Adornment="Adornment.End"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          OnKeyUp="@(async (e) => { if (e.Key == "Enter") await SearchUsers(); })"
                          Immediate="false"
                          Style="flex: 1;" />
            <MudSwitch Value="@_showInactiveUsers"
                       ValueChanged="@(async (bool val) => { _showInactiveUsers = val; await SearchUsers(); })"
                       Label="Show Inactive Users"
                       Color="Color.Primary"
                       T="bool" />
        </div>
    </MudPaper>

    <MudTable T="UserListItem"
              @ref="_table"
              ServerData="ServerReload"
              Hover="true"
              Breakpoint="Breakpoint.Sm"
              Loading="@_loading"
              LoadingProgressColor="Color.Info">
        <HeaderContent>
            <MudTh>Email</MudTh>
            <MudTh>Name</MudTh>
            <MudTh>Status</MudTh>
            <MudTh>Role</MudTh>
            <MudTh>Permissions</MudTh>
            <MudTh>Timezone</MudTh>
            <MudTh>Last Login</MudTh>
            <MudTh>Actions</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Email">@context.Email</MudTd>
            <MudTd DataLabel="Name">@context.FullName</MudTd>
            <MudTd DataLabel="Status">
                @if (context.IsActive)
                {
                    <MudChip T="string" Color="Color.Success" Size="Size.Small">Active</MudChip>
                }
                else
                {
                    <MudChip T="string" Color="Color.Default" Size="Size.Small">Inactive</MudChip>
                }
            </MudTd>
            <MudTd DataLabel="Role">
                <MudChip T="string" Color="@GetRoleColor(context.Role)" Size="Size.Small">@context.Role</MudChip>
            </MudTd>
            <MudTd DataLabel="Permissions">@context.PermissionCount</MudTd>
            <MudTd DataLabel="Timezone">
                @if (_canUpdateUsers)
                {
                    <MudSelect T="string" 
                               Value="@context.PreferredTimeZone"
                               ValueChanged="@(async (string tz) => await UpdateUserTimezone(context.Id, context.Email, tz))"
                               Dense="true"
                               Margin="Margin.Dense"
                               Variant="Variant.Text"
                               Style="min-width: 180px;">
                        <MudSelectItem T="string" Value="@((string?)null)">Browser Default</MudSelectItem>
                        @foreach (var tz in _availableTimezones)
                        {
                            <MudSelectItem T="string" Value="@tz.Id">@tz.DisplayName</MudSelectItem>
                        }
                    </MudSelect>
                }
                else
                {
                    @(context.PreferredTimeZone ?? "Browser Default")
                }
            </MudTd>
            <MudTd DataLabel="Last Login">
                @if (context.LastLoginDateTime.HasValue)
                {
                    @GetFormattedLastLogin(context.Id, context.LastLoginDateTime.Value)
                }
                else
                {
                    <MudText Typo="Typo.body2" Color="Color.Default">Never</MudText>
                }
            </MudTd>
            <MudTd DataLabel="Actions">
                <MudButton Variant="Variant.Text"
                           Color="Color.Primary"
                           Size="Size.Small"
                           OnClick="@(() => OpenPermissionsDialog(context.Id))">
                    Manage
                </MudButton>
                @if (_canUpdateUsers && !context.IsSystemAdmin)
                {
                    @if (context.IsActive)
                    {
                        <MudButton Variant="Variant.Text"
                                   Color="Color.Error"
                                   Size="Size.Small"
                                   OnClick="@(() => ToggleUserStatus(context.Id, context.Email, false))">
                            Disable
                        </MudButton>
                    }
                    else
                    {
                        <MudButton Variant="Variant.Text"
                                   Color="Color.Success"
                                   Size="Size.Small"
                                   OnClick="@(() => ToggleUserStatus(context.Id, context.Email, true))">
                            Enable
                        </MudButton>
                    }
                }
            </MudTd>
        </RowTemplate>
        <PagerContent>
            <MudTablePager PageSizeOptions="new int[] { 50, 100, 200 }" />
        </PagerContent>
    </MudTable>
</MudContainer>

@code {
    private MudTable<UserListItem>? _table;
    private string _searchTerm = string.Empty;
    private bool _showInactiveUsers = false;
    private bool _loading = false;
    private bool _canCreateUsers = false;
    private bool _canUpdateUsers = false;
    private Dictionary<int, string> _formattedLastLogins = new();

    private static readonly List<(string Id, string DisplayName)> _availableTimezones = new()
    {
        ("Eastern Standard Time", "Eastern Time (ET)"),
        ("Central Standard Time", "Central Time (CT)"),
        ("Mountain Standard Time", "Mountain Time (MT)"),
        ("US Mountain Standard Time", "Arizona (MST)"),
        ("Pacific Standard Time", "Pacific Time (PT)"),
        ("Alaskan Standard Time", "Alaska Time (AKT)"),
        ("Hawaiian Standard Time", "Hawaii Time (HST)"),
        ("UTC", "UTC")
    };

    protected override async Task OnInitializedAsync()
    {
        _canCreateUsers = await PermissionService.CanCreateAsync("users:manage");
        _canUpdateUsers = await PermissionService.CanUpdateAsync("users:manage");
    }

    private async Task UpdateUserTimezone(int userId, string email, string? timezone)
    {
        try
        {
            await UserManagementService.UpdateUserTimezoneAsync(userId, timezone);
            Snackbar.Add($"Timezone updated for {email}", Severity.Success);
            await _table!.ReloadServerData();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error updating timezone: {ex.Message}", Severity.Error);
        }
    }

    private string GetFormattedLastLogin(int userId, DateTime lastLogin)
    {
        if (_formattedLastLogins.TryGetValue(userId, out var formatted))
            return formatted;

        // Format asynchronously and update the dictionary
        _ = FormatLastLoginAsync(userId, lastLogin);
        return lastLogin.ToString("g"); // Return unformatted initially
    }

    private async Task FormatLastLoginAsync(int userId, DateTime lastLogin)
    {
        try
        {
            var formatted = await TimeZoneService.FormatDateTimeAsync(lastLogin);
            _formattedLastLogins[userId] = formatted;
            await InvokeAsync(StateHasChanged);
        }
        catch
        {
            _formattedLastLogins[userId] = lastLogin.ToString("g");
        }
    }

    private async Task<TableData<UserListItem>> ServerReload(TableState state, CancellationToken cancellationToken)
    {
        _loading = true;
        _formattedLastLogins.Clear(); // Clear cache when reloading
        try
        {
            var result = await UserManagementService.GetUsersAsync(
                string.IsNullOrWhiteSpace(_searchTerm) ? null : _searchTerm,
                state.Page + 1,
                state.PageSize,
                _showInactiveUsers);

            return new TableData<UserListItem>
            {
                Items = result.Items,
                TotalItems = result.TotalCount
            };
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading users: {ex.Message}", Severity.Error);
            return new TableData<UserListItem> { Items = new List<UserListItem>(), TotalItems = 0 };
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task SearchUsers()
    {
        if (_table != null)
        {
            await _table.ReloadServerData();
        }
    }

    private async Task OpenCreateUserDialog()
    {
        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseButton = true
        };

        var dialog = await DialogService.ShowAsync<CreateUserDialog>("Create New User", options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await _table!.ReloadServerData();
        }
    }

    private async Task OpenPermissionsDialog(int userId)
    {
        var parameters = new DialogParameters
        {
            ["UserId"] = userId
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Large,
            FullWidth = true,
            CloseButton = true
        };

        var dialog = await DialogService.ShowAsync<UserPermissionsDialog>("Manage User Permissions", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await _table!.ReloadServerData();
        }
    }

    private async Task ToggleUserStatus(int userId, string email, bool newStatus)
    {
        var action = newStatus ? "enable" : "disable";
        var parameters = new DialogParameters
        {
            ["ContentText"] = $"Are you sure you want to {action} user {email}?",
            ["ButtonText"] = action == "enable" ? "Enable" : "Disable",
            ["Color"] = newStatus ? Color.Success : Color.Error
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small };
        var dialog = await DialogService.ShowAsync<ConfirmDialog>($"{char.ToUpper(action[0])}{action.Substring(1)} User", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            try
            {
                await UserManagementService.UpdateUserStatusAsync(userId, newStatus);
                Snackbar.Add($"User {email} {(newStatus ? "enabled" : "disabled")} successfully", Severity.Success);
                await _table!.ReloadServerData();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error updating user status: {ex.Message}", Severity.Error);
            }
        }
    }

    private Color GetRoleColor(string role)
    {
        return role switch
        {
            "Super Admin" => Color.Error,
            "Admin" => Color.Warning,
            "Editor" => Color.Info,
            "Viewer" => Color.Default,
            "No Access" => Color.Default,
            _ => Color.Secondary
        };
    }
}
