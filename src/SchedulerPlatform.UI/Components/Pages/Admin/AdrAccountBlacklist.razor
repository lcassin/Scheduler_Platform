@page "/admin/adr-blacklist"
@using SchedulerPlatform.UI.Services
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject IHttpClientFactory HttpClientFactory
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IPermissionService PermissionService
@inject IJSRuntime JSRuntime

<PageTitle>ADR Account Blacklist</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <div class="d-flex justify-space-between align-center mb-4">
        <MudText Typo="Typo.h4">ADR Account Blacklist</MudText>
        @if (_hasAccess)
        {
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Primary" 
                       StartIcon="@Icons.Material.Filled.Add"
                       OnClick="OpenAddDialog">
                Add Blacklist Entry
            </MudButton>
        }
    </div>

    @if (!_hasAccess)
    {
                <MudAlert Severity="Severity.Warning">
                    You do not have permission to access this page. Only users with ADR update permissions can manage the ADR blacklist.
                </MudAlert>
    }
    else
    {
        <MudPaper Class="pa-4 mb-4">
            <MudGrid Spacing="2">
                <MudItem xs="12" md="3">
                    <MudTextField @bind-Value="_searchVendorCode" 
                                  Label="Vendor Code" 
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  Immediate="true"
                                  Adornment="Adornment.End"
                                  AdornmentIcon="@Icons.Material.Filled.Search" />
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudTextField @bind-Value="_searchAccountNumber" 
                                  Label="Account Number" 
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  Immediate="true"
                                  Adornment="Adornment.End"
                                  AdornmentIcon="@Icons.Material.Filled.Search" />
                </MudItem>
                <MudItem xs="12" md="2">
                    <MudSelect @bind-Value="_filterStatus" 
                               Label="Status" 
                               Variant="Variant.Outlined"
                               Margin="Margin.Dense">
                        <MudSelectItem Value="@("current")">Current</MudSelectItem>
                        <MudSelectItem Value="@("future")">Future</MudSelectItem>
                        <MudSelectItem Value="@("expired")">Expired</MudSelectItem>
                        <MudSelectItem Value="@("inactive")">Inactive</MudSelectItem>
                        <MudSelectItem Value="@("all")">All</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" md="4" Class="d-flex align-center justify-end gap-2">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadBlacklist" StartIcon="@Icons.Material.Filled.FilterAlt">
                        Apply
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="ClearFilters" StartIcon="@Icons.Material.Filled.Clear">
                        Clear
                    </MudButton>
                    <MudMenu Label="Export" StartIcon="@Icons.Material.Filled.Download" Variant="Variant.Outlined" Color="Color.Primary">
                        <MudMenuItem OnClick="@(() => ExportBlacklist(_filterStatus))">Export Current View</MudMenuItem>
                        <MudMenuItem OnClick="@(() => ExportBlacklist("all"))">Export All</MudMenuItem>
                    </MudMenu>
                </MudItem>
            </MudGrid>
        </MudPaper>

        @if (_loading)
        {
            <MudProgressCircular Indeterminate="true" />
        }
        else
        {
            <MudTable Items="@_blacklistEntries" 
                      Hover="true" 
                      Striped="true"
                      Dense="true"
                      Loading="@_loading"
                      LoadingProgressColor="Color.Primary">
                <HeaderContent>
                    <MudTh>Vendor Code</MudTh>
                    <MudTh>VM Account ID</MudTh>
                    <MudTh>Account Number</MudTh>
                    <MudTh>Credential ID</MudTh>
                    <MudTh>Exclusion Type</MudTh>
                    <MudTh>Reason</MudTh>
                    <MudTh>Status</MudTh>
                    <MudTh>Effective Dates</MudTh>
                    <MudTh>Blacklisted By</MudTh>
                    <MudTh>Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Vendor Code">@context.VendorCode</MudTd>
                    <MudTd DataLabel="VM Account ID">@context.VMAccountId</MudTd>
                    <MudTd DataLabel="Account Number">@context.VMAccountNumber</MudTd>
                    <MudTd DataLabel="Credential ID">@context.CredentialId</MudTd>
                    <MudTd DataLabel="Exclusion Type">
                        <MudChip T="string" Size="Size.Small" Color="@GetExclusionTypeColor(context.ExclusionType)">
                            @context.ExclusionType
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="Reason">
                        <MudTooltip Text="@context.Reason">
                            <MudText Typo="Typo.body2" Style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                @context.Reason
                            </MudText>
                        </MudTooltip>
                    </MudTd>
                    <MudTd DataLabel="Status">
                        @if (context.IsActive)
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Success">Active</MudChip>
                        }
                        else
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Default">Inactive</MudChip>
                        }
                    </MudTd>
                    <MudTd DataLabel="Effective Dates">
                        @if (context.EffectiveStartDate.HasValue || context.EffectiveEndDate.HasValue)
                        {
                            <MudText Typo="Typo.body2">
                                @(context.EffectiveStartDate?.ToString("MM/dd/yyyy") ?? "N/A") - 
                                @(context.EffectiveEndDate?.ToString("MM/dd/yyyy") ?? "N/A")
                            </MudText>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2">Indefinite</MudText>
                        }
                    </MudTd>
                    <MudTd DataLabel="Blacklisted By">
                        <MudText Typo="Typo.body2">@context.BlacklistedBy</MudText>
                        <MudText Typo="Typo.caption">@context.BlacklistedDateTime?.ToLocalTime().ToString("g")</MudText>
                    </MudTd>
                    <MudTd DataLabel="Actions">
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                       Size="Size.Small" 
                                       Color="Color.Primary"
                                       OnClick="@(() => OpenEditDialog(context))" />
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                       Size="Size.Small" 
                                       Color="Color.Error"
                                       OnClick="@(() => DeleteEntry(context))" />
                    </MudTd>
                </RowTemplate>
                <NoRecordsContent>
                    <MudText>No blacklist entries found.</MudText>
                </NoRecordsContent>
            </MudTable>
            
            <div class="d-flex justify-center mt-4">
                <MudPagination Count="@_totalPages" 
                               Selected="@_currentPage" 
                               SelectedChanged="OnPageChanged"
                               Color="Color.Primary" />
            </div>
        }
    }
</MudContainer>

<MudDialog @bind-Visible="_dialogVisible" Options="@(new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true })">
    <TitleContent>
        <MudText Typo="Typo.h6">@(_editingEntry?.Id > 0 ? "Edit" : "Add") Blacklist Entry</MudText>
    </TitleContent>
    <DialogContent>
        @if (_editingEntry != null)
        {
            <MudAlert Severity="Severity.Info" Class="mb-4">
                At least one of the following must be provided: Vendor Code, VM Account ID, Account Number, or Credential ID.
            </MudAlert>
            <MudGrid>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_editingEntry.VendorCode" 
                                  Label="Vendor Code" 
                                  Variant="Variant.Outlined"
                                  HelperText="Match by vendor code" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudNumericField @bind-Value="_editingEntry.VMAccountId" 
                                     Label="VM Account ID" 
                                     Variant="Variant.Outlined"
                                     HelperText="Match by VM account ID" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="_editingEntry.VMAccountNumber" 
                                  Label="Account Number" 
                                  Variant="Variant.Outlined"
                                  HelperText="Match by account number" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudNumericField @bind-Value="_editingEntry.CredentialId" 
                                     Label="Credential ID" 
                                     Variant="Variant.Outlined"
                                     HelperText="Match by credential ID" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudSelect @bind-Value="_editingEntry.ExclusionType" 
                               Label="Exclusion Type" 
                               Variant="Variant.Outlined"
                               Required="true">
                        <MudSelectItem Value="@("All")">All (Block all job types)</MudSelectItem>
                        <MudSelectItem Value="@("CredentialCheck")">Credential Check Only</MudSelectItem>
                        <MudSelectItem Value="@("Download")">Download Only</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudSwitch @bind-Value="_editingEntry.IsActive" 
                               Label="Active" 
                               Color="Color.Primary" />
                </MudItem>
                <MudItem xs="12">
                    <MudTextField @bind-Value="_editingEntry.Reason" 
                                  Label="Reason" 
                                  Variant="Variant.Outlined"
                                  Required="true"
                                  RequiredError="Reason is required"
                                  HelperText="Explain why this entry is blacklisted" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudDatePicker @bind-Date="_editingEntry.EffectiveStartDate" 
                                   Label="Effective Start Date" 
                                   Variant="Variant.Outlined"
                                   Required="true"
                                   RequiredError="Effective Start Date is required"
                                   HelperText="When the blacklist becomes active" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudDatePicker @bind-Date="_editingEntry.EffectiveEndDate" 
                                   Label="Effective End Date" 
                                   Variant="Variant.Outlined"
                                   Required="true"
                                   RequiredError="Effective End Date is required"
                                   HelperText="When the blacklist expires" />
                </MudItem>
                <MudItem xs="12">
                    <MudTextField @bind-Value="_editingEntry.Notes" 
                                  Label="Notes" 
                                  Variant="Variant.Outlined"
                                  Lines="2"
                                  HelperText="Optional additional notes" />
                </MudItem>
            </MudGrid>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseDialog" Color="Color.Default">Cancel</MudButton>
        <MudButton OnClick="SaveEntry" Color="Color.Primary" Variant="Variant.Filled" Disabled="@_saving">
            @if (_saving)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Save
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    private List<BlacklistEntryModel> _blacklistEntries = new();
    private BlacklistEntryModel? _editingEntry;
    private bool _loading = true;
    private bool _saving = false;
    private bool _hasAccess = false;
    private bool _dialogVisible = false;
    
    private string? _searchVendorCode;
    private string? _searchAccountNumber;
    private string _filterStatus = "current";
    private bool _exporting = false;
    
    private int _currentPage = 1;
    private int _totalPages = 1;
    private int _pageSize = 20;

        protected override async Task OnInitializedAsync()
        {
            // Blacklist is accessible to Editors, Admins, and Super Admins
            _hasAccess = await PermissionService.IsSystemAdminAsync() || 
                         await PermissionService.CanUpdateAsync("admin") ||
                         await PermissionService.CanUpdateAsync("adr");
        
            if (_hasAccess)
            {
                await LoadBlacklist();
            }
            else
            {
                _loading = false;
            }
        }

        private HttpClient CreateClient() => HttpClientFactory.CreateClient("SchedulerAPI");

        private async Task LoadBlacklist()
        {
            _loading = true;
            try
            {
                var queryParams = new List<string>
                {
                    $"pageNumber={_currentPage}",
                    $"pageSize={_pageSize}",
                    $"status={_filterStatus}"
                };
            
                if (!string.IsNullOrWhiteSpace(_searchVendorCode))
                    queryParams.Add($"vendorCode={Uri.EscapeDataString(_searchVendorCode)}");
                if (!string.IsNullOrWhiteSpace(_searchAccountNumber))
                    queryParams.Add($"accountNumber={Uri.EscapeDataString(_searchAccountNumber)}");
            
                var url = $"adr/blacklist?{string.Join("&", queryParams)}";
                var client = CreateClient();
                var response = await client.GetFromJsonAsync<BlacklistPagedResponse>(url);
            
                if (response != null)
                {
                    _blacklistEntries = response.Items ?? new List<BlacklistEntryModel>();
                    _totalPages = (int)Math.Ceiling((double)response.TotalCount / _pageSize);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error loading blacklist: {ex.Message}", Severity.Error);
            }
            finally
            {
                _loading = false;
            }
        }

    private async Task ClearFilters()
    {
        _searchVendorCode = null;
        _searchAccountNumber = null;
        _filterStatus = "current";
        _currentPage = 1;
        await LoadBlacklist();
    }

    private async Task ExportBlacklist(string status)
    {
        _exporting = true;
        StateHasChanged();
        try
        {
            var queryParams = new List<string> { $"status={status}" };
            
            if (!string.IsNullOrWhiteSpace(_searchVendorCode))
                queryParams.Add($"vendorCode={Uri.EscapeDataString(_searchVendorCode)}");
            if (!string.IsNullOrWhiteSpace(_searchAccountNumber))
                queryParams.Add($"accountNumber={Uri.EscapeDataString(_searchAccountNumber)}");
            
            var url = $"adr/blacklist/export?{string.Join("&", queryParams)}";
            var client = CreateClient();
            var response = await client.GetAsync(url);
            
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsByteArrayAsync();
                var fileName = response.Content.Headers.ContentDisposition?.FileName?.Trim('"') ?? $"ADR_Blacklist_{DateTime.Now:yyyyMMdd}.xlsx";
                
                // Trigger download via JavaScript
                var base64 = Convert.ToBase64String(content);
                await JSRuntime.InvokeVoidAsync("downloadFile", fileName, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", base64);
                
                Snackbar.Add("Export completed successfully", Severity.Success);
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Export failed: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Export failed: {ex.Message}", Severity.Error);
        }
        finally
        {
            _exporting = false;
            StateHasChanged();
        }
    }

    private async Task OnPageChanged(int page)
    {
        _currentPage = page;
        await LoadBlacklist();
    }

    private void OpenAddDialog()
    {
        _editingEntry = new BlacklistEntryModel
        {
            ExclusionType = "All",
            IsActive = true
        };
        _dialogVisible = true;
    }

    private void OpenEditDialog(BlacklistEntryModel entry)
    {
        _editingEntry = new BlacklistEntryModel
        {
            Id = entry.Id,
            VendorCode = entry.VendorCode,
            VMAccountId = entry.VMAccountId,
            VMAccountNumber = entry.VMAccountNumber,
            CredentialId = entry.CredentialId,
            ExclusionType = entry.ExclusionType,
            Reason = entry.Reason,
            IsActive = entry.IsActive,
            EffectiveStartDate = entry.EffectiveStartDate,
            EffectiveEndDate = entry.EffectiveEndDate,
            Notes = entry.Notes
        };
        _dialogVisible = true;
    }

    private void CloseDialog()
    {
        _dialogVisible = false;
        _editingEntry = null;
    }

        private async Task SaveEntry()
        {
            if (_editingEntry == null) return;
            
            // Validate at least one exclusion criteria is provided
            if (string.IsNullOrWhiteSpace(_editingEntry.VendorCode) && 
                !_editingEntry.VMAccountId.HasValue && 
                string.IsNullOrWhiteSpace(_editingEntry.VMAccountNumber) && 
                !_editingEntry.CredentialId.HasValue)
            {
                Snackbar.Add("At least one of Vendor Code, VM Account ID, Account Number, or Credential ID is required", Severity.Warning);
                return;
            }
            
            if (string.IsNullOrWhiteSpace(_editingEntry.Reason))
            {
                Snackbar.Add("Reason is required", Severity.Warning);
                return;
            }
            
            // Validate effective dates are provided
            if (!_editingEntry.EffectiveStartDate.HasValue)
            {
                Snackbar.Add("Effective Start Date is required", Severity.Warning);
                return;
            }
            
            if (!_editingEntry.EffectiveEndDate.HasValue)
            {
                Snackbar.Add("Effective End Date is required", Severity.Warning);
                return;
            }
            
            if (_editingEntry.EffectiveEndDate.Value < _editingEntry.EffectiveStartDate.Value)
            {
                Snackbar.Add("Effective End Date must be on or after Effective Start Date", Severity.Warning);
                return;
            }
        
            _saving = true;
            try
            {
                var client = CreateClient();
                HttpResponseMessage response;
                if (_editingEntry.Id > 0)
                {
                    response = await client.PutAsJsonAsync($"adr/blacklist/{_editingEntry.Id}", _editingEntry);
                }
                else
                {
                    response = await client.PostAsJsonAsync("adr/blacklist", _editingEntry);
                }
            
                if (response.IsSuccessStatusCode)
                {
                    Snackbar.Add(_editingEntry.Id > 0 ? "Entry updated successfully" : "Entry created successfully", Severity.Success);
                    CloseDialog();
                    await LoadBlacklist();
                }
                else
                {
                    var error = await response.Content.ReadAsStringAsync();
                    Snackbar.Add($"Error saving entry: {error}", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error saving entry: {ex.Message}", Severity.Error);
            }
            finally
            {
                _saving = false;
            }
        }

        private async Task DeleteEntry(BlacklistEntryModel entry)
        {
            var result = await DialogService.ShowMessageBox(
                "Confirm Delete",
                $"Are you sure you want to delete this blacklist entry?",
                yesText: "Delete",
                cancelText: "Cancel");
        
            if (result == true)
            {
                try
                {
                    var client = CreateClient();
                    var response = await client.DeleteAsync($"adr/blacklist/{entry.Id}");
                    if (response.IsSuccessStatusCode)
                    {
                        Snackbar.Add("Entry deleted successfully", Severity.Success);
                        await LoadBlacklist();
                    }
                    else
                    {
                        var error = await response.Content.ReadAsStringAsync();
                        Snackbar.Add($"Error deleting entry: {error}", Severity.Error);
                    }
                }
                catch (Exception ex)
                {
                    Snackbar.Add($"Error deleting entry: {ex.Message}", Severity.Error);
                }
            }
        }

    private Color GetExclusionTypeColor(string? exclusionType)
    {
        return exclusionType switch
        {
            "All" => Color.Error,
            "CredentialCheck" => Color.Warning,
            "Download" => Color.Info,
            _ => Color.Default
        };
    }

    private class BlacklistEntryModel
    {
        public int Id { get; set; }
        public string? VendorCode { get; set; }
        public long? VMAccountId { get; set; }
        public string? VMAccountNumber { get; set; }
        public int? CredentialId { get; set; }
        public string? ExclusionType { get; set; } = "All";
        public string Reason { get; set; } = string.Empty;
        public bool IsActive { get; set; } = true;
        public DateTime? EffectiveStartDate { get; set; }
        public DateTime? EffectiveEndDate { get; set; }
        public string? BlacklistedBy { get; set; }
        public DateTime? BlacklistedDateTime { get; set; }
        public string? Notes { get; set; }
    }

    private class BlacklistPagedResponse
    {
        public List<BlacklistEntryModel>? Items { get; set; }
        public int TotalCount { get; set; }
        public int Page { get; set; }
        public int PageSize { get; set; }
    }
}
