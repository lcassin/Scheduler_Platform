@page "/admin/adr-configuration"
@using SchedulerPlatform.UI.Services
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject AuthenticatedHttpClientService HttpClient
@inject ISnackbar Snackbar
@inject IPermissionService PermissionService

<PageTitle>ADR Configuration</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <div class="d-flex justify-space-between align-center mb-4">
        <MudText Typo="Typo.h4">ADR Configuration</MudText>
    </div>

    @if (!_hasAccess)
    {
        <MudAlert Severity="Severity.Warning">
            You do not have permission to access this page. Only Admin and Super Admin users can manage ADR configuration.
        </MudAlert>
    }
    else if (_loading)
    {
        <MudProgressCircular Indeterminate="true" />
    }
    else if (_config != null)
    {
        @if (_config.TestModeEnabled)
        {
            <MudAlert Severity="Severity.Warning" Class="mb-4" Icon="@Icons.Material.Filled.Warning">
                <strong>TEST MODE IS ENABLED</strong> - ADR requests and credential checks are limited to @_config.TestModeMaxScrapingJobs and @_config.TestModeMaxCredentialChecks jobs respectively. 
                Status checks are not limited. Disable test mode before going to production.
            </MudAlert>
        }
        
        <MudPaper Class="pa-4">
            <MudForm @ref="_form">
                <MudGrid>
                    <MudItem xs="12">
                        <MudText Typo="Typo.h6" Class="mb-2">Orchestration Settings</MudText>
                    </MudItem>
                    
                    <MudItem xs="12" sm="6" md="4">
                        <MudSwitch @bind-Value="_config.IsOrchestrationEnabled" 
                                   Label="Orchestration Enabled" 
                                   Color="Color.Primary" />
                    </MudItem>
                    
                    <MudItem xs="12">
                        <MudDivider Class="my-4" />
                        <MudText Typo="Typo.h6" Class="mb-2">Timing Settings</MudText>
                    </MudItem>
                    
                    <MudItem xs="12" sm="6" md="4">
                        <MudNumericField @bind-Value="_config.CredentialCheckLeadDays" 
                                         Label="Credential Check Lead Days" 
                                         Variant="Variant.Outlined"
                                         Min="1" Max="30"
                                         HelperText="Days before NextRunDate to verify credentials" />
                    </MudItem>
                    
                    <MudItem xs="12" sm="6" md="4">
                        <MudNumericField @bind-Value="_config.MaxRetries"
                                         Label="Max Retries" 
                                         Variant="Variant.Outlined"
                                         Min="1" Max="20"
                                         HelperText="Maximum retry attempts per job" />
                    </MudItem>
                    
                    <MudItem xs="12" sm="6" md="4">
                        <MudNumericField @bind-Value="_config.DailyStatusCheckDelayDays" 
                                         Label="Daily Status Check Delay (Days)" 
                                         Variant="Variant.Outlined"
                                         Min="1" Max="7"
                                         HelperText="Days after ADR request to check status" />
                    </MudItem>
                    
                    <MudItem xs="12" sm="6" md="4">
                        <MudNumericField @bind-Value="_config.FinalStatusCheckDelayDays" 
                                         Label="Final Status Check Delay (Days)" 
                                         Variant="Variant.Outlined"
                                         Min="1" Max="14"
                                         HelperText="Days after billing window to do final check" />
                    </MudItem>
                    
                    <MudItem xs="12">
                        <MudDivider Class="my-4" />
                        <MudText Typo="Typo.h6" Class="mb-2">Invoice Window Settings</MudText>
                    </MudItem>
                    
                    <MudItem xs="12" sm="6" md="4">
                        <MudNumericField @bind-Value="_config.DefaultWindowDaysBefore" 
                                         Label="Default Window Days Before" 
                                         Variant="Variant.Outlined"
                                         Min="0" Max="30"
                                         HelperText="Days before expected date to search" />
                    </MudItem>
                    
                    <MudItem xs="12" sm="6" md="4">
                        <MudNumericField @bind-Value="_config.DefaultWindowDaysAfter" 
                                         Label="Default Window Days After" 
                                         Variant="Variant.Outlined"
                                         Min="0" Max="30"
                                         HelperText="Days after expected date to search" />
                    </MudItem>
                    
                    <MudItem xs="12">
                        <MudDivider Class="my-4" />
                        <MudText Typo="Typo.h6" Class="mb-2">Performance Settings</MudText>
                    </MudItem>
                    
                    <MudItem xs="12" sm="6" md="4">
                        <MudNumericField @bind-Value="_config.MaxParallelRequests" 
                                         Label="Max Parallel Requests" 
                                         Variant="Variant.Outlined"
                                         Min="1" Max="50"
                                         HelperText="Maximum concurrent API requests" />
                    </MudItem>
                    
                    <MudItem xs="12" sm="6" md="4">
                        <MudNumericField @bind-Value="_config.BatchSize" 
                                         Label="Batch Size" 
                                         Variant="Variant.Outlined"
                                         Min="100" Max="10000"
                                         HelperText="Records to process per batch" />
                    </MudItem>
                    
                    <MudItem xs="12" sm="6" md="4">
                        <MudNumericField @bind-Value="_config.MaxOrchestrationDurationMinutes" 
                                         Label="Max Orchestration Duration (Minutes)" 
                                         Variant="Variant.Outlined"
                                         Min="30" Max="720"
                                         HelperText="Max time before orchestration is marked as failed" />
                    </MudItem>
                    
                    <MudItem xs="12" sm="6" md="4">
                        <MudNumericField @bind-Value="_config.DatabaseCommandTimeoutSeconds" 
                                         Label="Database Command Timeout (Seconds)" 
                                         Variant="Variant.Outlined"
                                         Min="30" Max="1800"
                                         HelperText="Timeout for long-running database operations" />
                    </MudItem>
                    
                    <MudItem xs="12">
                        <MudDivider Class="my-4" />
                        <MudText Typo="Typo.h6" Class="mb-2">Feature Flags</MudText>
                    </MudItem>
                    
                    <MudItem xs="12" sm="6" md="4">
                        <MudSwitch @bind-Value="_config.AutoCreateTestLoginRules" 
                                   Label="Auto Create Test Login Rules" 
                                   Color="Color.Primary" />
                    </MudItem>
                    
                    <MudItem xs="12" sm="6" md="4">
                        <MudSwitch @bind-Value="_config.AutoCreateMissingInvoiceAlerts" 
                                   Label="Auto Create Missing Invoice Alerts" 
                                   Color="Color.Primary" />
                    </MudItem>
                    
                    <MudItem xs="12" sm="6" md="4">
                        <MudTextField @bind-Value="_config.MissingInvoiceAlertEmail" 
                                      Label="Missing Invoice Alert Email" 
                                      Variant="Variant.Outlined"
                                      HelperText="Email for missing invoice notifications" />
                    </MudItem>
                    
                    <MudItem xs="12">
                        <MudDivider Class="my-4" />
                        <MudText Typo="Typo.h6" Class="mb-2" Color="@(_config.TestModeEnabled ? Color.Warning : Color.Default)">
                            Test Mode Settings @(_config.TestModeEnabled ? "(ENABLED)" : "")
                        </MudText>
                        <MudText Typo="Typo.body2" Class="mb-2">
                            Use test mode to limit the number of ADR requests and credential checks during testing phases. 
                            This reduces API costs while still processing real jobs through the full workflow.
                        </MudText>
                    </MudItem>
                    
                    <MudItem xs="12" sm="6" md="4">
                        <MudSwitch @bind-Value="_config.TestModeEnabled" 
                                   Label="Test Mode Enabled" 
                                   Color="Color.Warning" />
                    </MudItem>
                    
                    <MudItem xs="12" sm="6" md="4">
                        <MudNumericField @bind-Value="_config.TestModeMaxScrapingJobs" 
                                         Label="Max ADR Requests (Test Mode)" 
                                         Variant="Variant.Outlined"
                                         Min="0" Max="1000"
                                         Disabled="@(!_config.TestModeEnabled)"
                                         HelperText="Max ADR requests per run (0 = unlimited)" />
                    </MudItem>
                    
                    <MudItem xs="12" sm="6" md="4">
                        <MudNumericField @bind-Value="_config.TestModeMaxCredentialChecks" 
                                         Label="Max Credential Checks (Test Mode)" 
                                         Variant="Variant.Outlined"
                                         Min="0" Max="1000"
                                         Disabled="@(!_config.TestModeEnabled)"
                                         HelperText="Max credential checks per run (0 = unlimited)" />
                    </MudItem>
                    
                    <MudItem xs="12">
                        <MudDivider Class="my-4" />
                        <MudText Typo="Typo.h6" Class="mb-2">Data Retention Settings</MudText>
                    </MudItem>
                    
                    <MudItem xs="12" sm="6" md="4">
                        <MudSwitch @bind-Value="_config.IsArchivalEnabled" 
                                   Label="Data Archival Enabled" 
                                   Color="Color.Primary" />
                    </MudItem>
                    
                    <MudItem xs="12" sm="6" md="4">
                        <MudNumericField @bind-Value="_config.JobRetentionMonths" 
                                         Label="Job Retention (Months)" 
                                         Variant="Variant.Outlined"
                                         Min="1" Max="60"
                                         HelperText="Months to keep ADR jobs before archiving" />
                    </MudItem>
                    
                    <MudItem xs="12" sm="6" md="4">
                        <MudNumericField @bind-Value="_config.JobExecutionRetentionMonths" 
                                         Label="Execution Retention (Months)" 
                                         Variant="Variant.Outlined"
                                         Min="1" Max="60"
                                         HelperText="Months to keep job executions before archiving" />
                    </MudItem>
                    
                    <MudItem xs="12" sm="6" md="4">
                        <MudNumericField @bind-Value="_config.AuditLogRetentionDays" 
                                         Label="Audit Log Retention (Days)" 
                                         Variant="Variant.Outlined"
                                         Min="30" Max="365"
                                         HelperText="Days to keep audit logs before archiving" />
                    </MudItem>
                    
                    <MudItem xs="12" sm="6" md="4">
                        <MudNumericField @bind-Value="_config.ArchiveRetentionYears" 
                                         Label="Archive Retention (Years)" 
                                         Variant="Variant.Outlined"
                                         Min="1" Max="10"
                                         HelperText="Years to keep archived records before deletion" />
                    </MudItem>
                    
                    <MudItem xs="12" sm="6" md="4">
                        <MudNumericField @bind-Value="_config.LogRetentionDays" 
                                         Label="Log File Retention (Days)" 
                                         Variant="Variant.Outlined"
                                         Min="1" Max="365"
                                         HelperText="Days to keep log files before deletion" />
                    </MudItem>
                    
                    <MudItem xs="12" sm="6" md="4">
                        <MudNumericField @bind-Value="_config.ArchivalBatchSize" 
                                         Label="Archival Batch Size" 
                                         Variant="Variant.Outlined"
                                         Min="100" Max="10000"
                                         HelperText="Records to archive per batch" />
                    </MudItem>
                    
                    <MudItem xs="12">
                        <MudDivider Class="my-4" />
                        <MudText Typo="Typo.h6" Class="mb-2">Notes</MudText>
                    </MudItem>
                    
                    <MudItem xs="12">
                        <MudTextField @bind-Value="_config.Notes" 
                                      Label="Notes" 
                                      Variant="Variant.Outlined"
                                      Lines="3"
                                      HelperText="Optional notes about configuration changes" />
                    </MudItem>
                    
                    <MudItem xs="12" Class="d-flex justify-end gap-2 mt-4">
                        <MudButton Variant="Variant.Outlined" 
                                   Color="Color.Default" 
                                   OnClick="LoadConfiguration">
                            Reset
                        </MudButton>
                        <MudButton Variant="Variant.Filled" 
                                   Color="Color.Primary" 
                                   OnClick="SaveConfiguration"
                                   Disabled="@_saving">
                            @if (_saving)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            }
                            Save Configuration
                        </MudButton>
                    </MudItem>
                </MudGrid>
            </MudForm>
        </MudPaper>
        
        @if (_config.Id > 0)
        {
            <MudPaper Class="pa-4 mt-4">
                <MudText Typo="Typo.body2" Color="Color.Default">
                    Last modified by @_config.ModifiedBy on @_config.ModifiedDateTime?.ToLocalTime().ToString("g")
                </MudText>
            </MudPaper>
        }
    }
</MudContainer>

@code {
    private MudForm? _form;
    private AdrConfigurationModel? _config;
    private bool _loading = true;
    private bool _saving = false;
    private bool _hasAccess = false;

        protected override async Task OnInitializedAsync()
        {
            // Check if user has admin access (Admin or Super Admin only)
            _hasAccess = await PermissionService.IsSystemAdminAsync() || 
                         await PermissionService.CanUpdateAsync("admin");
        
            if (_hasAccess)
            {
                await LoadConfiguration();
            }
            else
            {
                _loading = false;
            }
        }

        private async Task LoadConfiguration()
        {
            _loading = true;
            try
            {
                var response = await HttpClient.GetAsync("adr/configuration");
                response.EnsureSuccessStatusCode();
                _config = await response.Content.ReadFromJsonAsync<AdrConfigurationModel>();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error loading configuration: {ex.Message}", Severity.Error);
                _config = new AdrConfigurationModel();
            }
            finally
            {
                _loading = false;
            }
        }

        private async Task SaveConfiguration()
        {
            if (_config == null) return;
        
            _saving = true;
            try
            {
                var response = await HttpClient.PutAsJsonAsync("adr/configuration", _config);
                if (response.IsSuccessStatusCode)
                {
                    _config = await response.Content.ReadFromJsonAsync<AdrConfigurationModel>();
                    Snackbar.Add("Configuration saved successfully", Severity.Success);
                }
                else
                {
                    var error = await response.Content.ReadAsStringAsync();
                    Snackbar.Add($"Error saving configuration: {error}", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error saving configuration: {ex.Message}", Severity.Error);
            }
            finally
            {
                _saving = false;
            }
        }

    private class AdrConfigurationModel
    {
        public int Id { get; set; }
        public int CredentialCheckLeadDays { get; set; } = 7;
        public int ScrapeRetryDays { get; set; } = 5;
        public int MaxRetries { get; set; } = 5;
        public int FinalStatusCheckDelayDays { get; set; } = 5;
        public int DailyStatusCheckDelayDays { get; set; } = 1;
        public int MaxParallelRequests { get; set; } = 8;
        public int BatchSize { get; set; } = 1000;
        public int DefaultWindowDaysBefore { get; set; } = 5;
        public int DefaultWindowDaysAfter { get; set; } = 5;
        public bool AutoCreateTestLoginRules { get; set; } = true;
        public bool AutoCreateMissingInvoiceAlerts { get; set; } = true;
        public string? MissingInvoiceAlertEmail { get; set; }
        public bool IsOrchestrationEnabled { get; set; } = true;
        public string? Notes { get; set; }
        // Data Retention Settings
        public int JobRetentionMonths { get; set; } = 12;
        public int JobExecutionRetentionMonths { get; set; } = 12;
        public int AuditLogRetentionDays { get; set; } = 90;
        public bool IsArchivalEnabled { get; set; } = true;
        public int ArchivalBatchSize { get; set; } = 5000;
        public int ArchiveRetentionYears { get; set; } = 7;
        public int LogRetentionDays { get; set; } = 30;
        // Orchestration Performance Settings
        public int MaxOrchestrationDurationMinutes { get; set; } = 240;
        public int DatabaseCommandTimeoutSeconds { get; set; } = 600;
        // Test Mode Settings
        public bool TestModeEnabled { get; set; } = false;
        public int TestModeMaxScrapingJobs { get; set; } = 50;
        public int TestModeMaxCredentialChecks { get; set; } = 50;
        public string? ModifiedBy { get; set; }
        public DateTime? ModifiedDateTime { get; set; }
    }
}
