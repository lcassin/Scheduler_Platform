@page "/admin/adr-job-types"
@using SchedulerPlatform.UI.Services
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject AuthenticatedHttpClientService HttpClient
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IPermissionService PermissionService

<PageTitle>ADR Job Types</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <div class="d-flex justify-space-between align-center mb-4">
        <MudText Typo="Typo.h4">ADR Job Types</MudText>
        @if (_hasAccess)
        {
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Primary" 
                       StartIcon="@Icons.Material.Filled.Add"
                       OnClick="OpenCreateDialog">
                Add Job Type
            </MudButton>
        }
    </div>

    @if (!_hasAccess)
    {
        <MudAlert Severity="Severity.Warning">
            You do not have permission to access this page. Only Admin and Super Admin users can manage ADR job types.
        </MudAlert>
    }
    else if (_loading)
    {
        <MudProgressCircular Indeterminate="true" />
    }
    else
    {
        <MudPaper Class="pa-4">
                        <MudSwitch Value="_includeInactive" 
                                   ValueChanged="@(async (bool val) => { _includeInactive = val; await LoadJobTypes(); })"
                                   Label="Show Inactive Job Types" 
                                   Color="Color.Primary"
                                   Class="mb-4"
                                   T="bool" />
            
            <MudTable Items="@_jobTypes" Hover="true" Striped="true" Dense="true">
                <HeaderContent>
                    <MudTh>Code</MudTh>
                    <MudTh>Name</MudTh>
                    <MudTh>Description</MudTh>
                    <MudTh>ADR Request Type ID</MudTh>
                    <MudTh>Display Order</MudTh>
                    <MudTh>Active</MudTh>
                    <MudTh>Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Code">
                        <MudChip T="string" Size="Size.Small" Color="Color.Primary">@context.Code</MudChip>
                    </MudTd>
                    <MudTd DataLabel="Name">@context.Name</MudTd>
                    <MudTd DataLabel="Description">
                        <MudTooltip Text="@context.Description">
                            <MudText Typo="Typo.body2" Class="text-truncate" Style="max-width: 300px;">
                                @(context.Description?.Length > 50 ? context.Description.Substring(0, 50) + "..." : context.Description)
                            </MudText>
                        </MudTooltip>
                    </MudTd>
                    <MudTd DataLabel="ADR Request Type ID">@context.AdrRequestTypeId</MudTd>
                    <MudTd DataLabel="Display Order">@context.DisplayOrder</MudTd>
                    <MudTd DataLabel="Active">
                        @if (context.IsActive)
                        {
                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small" />
                        }
                        else
                        {
                            <MudIcon Icon="@Icons.Material.Filled.Cancel" Color="Color.Error" Size="Size.Small" />
                        }
                    </MudTd>
                    <MudTd DataLabel="Actions">
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                       Size="Size.Small" 
                                       Color="Color.Primary"
                                       OnClick="@(() => OpenEditDialog(context))" />
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                       Size="Size.Small" 
                                       Color="Color.Error"
                                       OnClick="@(() => DeleteJobType(context))" />
                    </MudTd>
                </RowTemplate>
                <NoRecordsContent>
                    <MudText>No job types found.</MudText>
                </NoRecordsContent>
            </MudTable>
        </MudPaper>
    }
</MudContainer>

<MudDialog @bind-Visible="_dialogVisible" Options="@(new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true })">
    <TitleContent>
        <MudText Typo="Typo.h6">@(_editingJobType?.Id > 0 ? "Edit Job Type" : "Create Job Type")</MudText>
    </TitleContent>
    <DialogContent>
        @if (_editingJobType != null)
        {
            <MudForm @ref="_form">
                <MudGrid>
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_editingJobType.Code" 
                                      Label="Code" 
                                      Variant="Variant.Outlined"
                                      Required="true"
                                      RequiredError="Code is required"
                                      HelperText="Unique identifier (e.g., CREDENTIAL_CHECK)" />
                    </MudItem>
                    
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_editingJobType.Name" 
                                      Label="Name" 
                                      Variant="Variant.Outlined"
                                      Required="true"
                                      RequiredError="Name is required"
                                      HelperText="Display name for the job type" />
                    </MudItem>
                    
                    <MudItem xs="12">
                        <MudTextField @bind-Value="_editingJobType.Description" 
                                      Label="Description" 
                                      Variant="Variant.Outlined"
                                      Lines="2"
                                      HelperText="Detailed description of what this job type does" />
                    </MudItem>
                    
                    <MudItem xs="12" sm="6">
                        <MudNumericField @bind-Value="_editingJobType.AdrRequestTypeId" 
                                         Label="ADR Request Type ID" 
                                         Variant="Variant.Outlined"
                                         Min="1" Max="10"
                                         Required="true"
                                         HelperText="1 = Credential Check, 2 = Download Invoice, 3 = Rebill" />
                    </MudItem>
                    
                    <MudItem xs="12" sm="6">
                        <MudNumericField @bind-Value="_editingJobType.DisplayOrder" 
                                         Label="Display Order" 
                                         Variant="Variant.Outlined"
                                         Min="0" Max="100"
                                         HelperText="Order in which job types are displayed" />
                    </MudItem>
                    
                    <MudItem xs="12">
                        <MudTextField @bind-Value="_editingJobType.EndpointUrl" 
                                      Label="Endpoint URL (Optional)" 
                                      Variant="Variant.Outlined"
                                      HelperText="Custom endpoint URL for this job type (leave blank to use default)" />
                    </MudItem>
                    
                    <MudItem xs="12" sm="6">
                        <MudSwitch @bind-Value="_editingJobType.IsActive" 
                                   Label="Active" 
                                   Color="Color.Primary" />
                    </MudItem>
                    
                    <MudItem xs="12">
                        <MudTextField @bind-Value="_editingJobType.Notes" 
                                      Label="Notes" 
                                      Variant="Variant.Outlined"
                                      Lines="2"
                                      HelperText="Optional notes about this job type" />
                    </MudItem>
                </MudGrid>
            </MudForm>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseDialog">Cancel</MudButton>
        <MudButton Variant="Variant.Filled" 
                   Color="Color.Primary" 
                   OnClick="SaveJobType"
                   Disabled="@_saving">
            @if (_saving)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Save
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    private MudForm? _form;
    private List<JobTypeModel> _jobTypes = new();
    private JobTypeModel? _editingJobType;
    private bool _loading = true;
    private bool _saving = false;
    private bool _hasAccess = false;
    private bool _includeInactive = false;
    private bool _dialogVisible = false;

    protected override async Task OnInitializedAsync()
    {
        // Check if user has admin access (Admin or Super Admin only)
        _hasAccess = await PermissionService.IsSystemAdminAsync() || 
                     await PermissionService.CanUpdateAsync("admin");
        
        if (_hasAccess)
        {
            await LoadJobTypes();
        }
        else
        {
            _loading = false;
        }
    }

        private async Task LoadJobTypes()
        {
            _loading = true;
            try
            {
                var url = $"adr/job-types?includeInactive={_includeInactive}";
                var response = await HttpClient.GetAsync(url);
                response.EnsureSuccessStatusCode();
                _jobTypes = await response.Content.ReadFromJsonAsync<List<JobTypeModel>>() ?? new();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error loading job types: {ex.Message}", Severity.Error);
                _jobTypes = new();
            }
            finally
            {
                _loading = false;
            }
        }

    private void OpenCreateDialog()
    {
        _editingJobType = new JobTypeModel
        {
            IsActive = true,
            AdrRequestTypeId = 2, // Default to Download Invoice
            DisplayOrder = _jobTypes.Count > 0 ? _jobTypes.Max(jt => jt.DisplayOrder) + 1 : 1
        };
        _dialogVisible = true;
    }

    private void OpenEditDialog(JobTypeModel jobType)
    {
        _editingJobType = new JobTypeModel
        {
            Id = jobType.Id,
            Code = jobType.Code,
            Name = jobType.Name,
            Description = jobType.Description,
            EndpointUrl = jobType.EndpointUrl,
            AdrRequestTypeId = jobType.AdrRequestTypeId,
            IsActive = jobType.IsActive,
            DisplayOrder = jobType.DisplayOrder,
            Notes = jobType.Notes
        };
        _dialogVisible = true;
    }

    private void CloseDialog()
    {
        _dialogVisible = false;
        _editingJobType = null;
    }

        private async Task SaveJobType()
        {
            if (_editingJobType == null) return;
        
            if (string.IsNullOrWhiteSpace(_editingJobType.Code) || string.IsNullOrWhiteSpace(_editingJobType.Name))
            {
                Snackbar.Add("Code and Name are required", Severity.Warning);
                return;
            }
        
            _saving = true;
            try
            {
                HttpResponseMessage response;
            
                if (_editingJobType.Id > 0)
                {
                    // Update existing
                    response = await HttpClient.PutAsJsonAsync($"adr/job-types/{_editingJobType.Id}", _editingJobType);
                }
                else
                {
                    // Create new
                    response = await HttpClient.PostAsJsonAsync("adr/job-types", _editingJobType);
                }
            
                if (response.IsSuccessStatusCode)
                {
                    Snackbar.Add(_editingJobType.Id > 0 ? "Job type updated successfully" : "Job type created successfully", Severity.Success);
                    CloseDialog();
                    await LoadJobTypes();
                }
                else
                {
                    var error = await response.Content.ReadAsStringAsync();
                    Snackbar.Add($"Error saving job type: {error}", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error saving job type: {ex.Message}", Severity.Error);
            }
            finally
            {
                _saving = false;
            }
        }

        private async Task DeleteJobType(JobTypeModel jobType)
        {
            var result = await DialogService.ShowMessageBox(
                "Delete Job Type",
                $"Are you sure you want to delete the job type '{jobType.Name}'? This action cannot be undone.",
                yesText: "Delete",
                cancelText: "Cancel");
        
            if (result == true)
            {
                try
                {
                    var response = await HttpClient.DeleteAsync($"adr/job-types/{jobType.Id}");
                
                    if (response.IsSuccessStatusCode)
                    {
                        Snackbar.Add("Job type deleted successfully", Severity.Success);
                        await LoadJobTypes();
                    }
                    else
                    {
                        var error = await response.Content.ReadAsStringAsync();
                        Snackbar.Add($"Error deleting job type: {error}", Severity.Error);
                    }
                }
                catch (Exception ex)
                {
                    Snackbar.Add($"Error deleting job type: {ex.Message}", Severity.Error);
                }
            }
        }

    private class JobTypeModel
    {
        public int Id { get; set; }
        public string Code { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public string? Description { get; set; }
        public string? EndpointUrl { get; set; }
        public int AdrRequestTypeId { get; set; }
        public bool IsActive { get; set; } = true;
        public int DisplayOrder { get; set; }
        public string? Notes { get; set; }
    }
}
