@page "/schedules"
@rendermode InteractiveServer
@attribute [Authorize]
@using SchedulerPlatform.Core.Domain.Enums
@using SchedulerPlatform.UI.Services
@inject IScheduleService ScheduleService
@inject IClientService ClientService
@inject IUserTimeZoneService TimeZoneService
@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime
@inject IPermissionService PermissionService
@inject AuthenticationStateProvider AuthenticationStateProvider
@implements IDisposable

<PageTitle>Schedules</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Schedules</MudText>

<MudPaper Class="pa-4">
    @if (_canCreate)
    {
        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" OnClick="CreateSchedule" Class="mb-4">
            Add New Schedule
        </MudButton>
    }

    <MudGrid Class="mb-4" Spacing="2">
        <MudItem xs="12" md="2">
            <MudTextField @bind-Value="_searchTerm" Label="Search by Name" Placeholder="e.g. Vendor_Account" 
                          Variant="Variant.Outlined" Margin="Margin.Dense" Clearable="true" />
        </MudItem>
        <MudItem xs="12" md="2">
            <MudAutocomplete T="Client" 
                             Label="Filter by Client" 
                             @bind-Value="_selectedClient"
                             SearchFunc="SearchClients"
                             ToStringFunc="@(c => c?.ClientName ?? "All Clients")"
                             Variant="Variant.Outlined" 
                             Margin="Margin.Dense" 
                             Clearable="true"
                             ResetValueOnEmptyText="true"
                             CoerceText="false"
                             AdornmentIcon="@Icons.Material.Filled.Search"
                             AdornmentColor="Color.Primary" />
        </MudItem>
        <MudItem xs="12" md="2">
            <MudSelect T="string" @bind-Value="_selectedStatus" Label="Status" Variant="Variant.Outlined" Margin="Margin.Dense" Clearable="true">
                <MudSelectItem Value="@("Both")">Both</MudSelectItem>
                <MudSelectItem Value="@("Enabled")">Enabled</MudSelectItem>
                <MudSelectItem Value="@("Disabled")">Disabled</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" md="2">
            <MudSelect T="string" @bind-Value="_selectedLastRunStatus" Label="Last Run Status" Variant="Variant.Outlined" Margin="Margin.Dense" Clearable="true">
                <MudSelectItem Value="@("All")">All</MudSelectItem>
                <MudSelectItem Value="@("Failed")">Failed</MudSelectItem>
                <MudSelectItem Value="@("Completed")">Completed</MudSelectItem>
                <MudSelectItem Value="@("Running")">Running</MudSelectItem>
                <MudSelectItem Value="@("Cancelled")">Cancelled</MudSelectItem>
                <MudSelectItem Value="@("Retrying")">Retrying</MudSelectItem>
                <MudSelectItem Value="@("Never")">Never Run</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" md="2">
            <MudDatePicker @bind-Date="_selectedDate" 
                           Label="Filter by Date" 
                           Variant="Variant.Outlined" 
                           Margin="Margin.Dense" 
                           Clearable="true"
                           Placeholder="Select a date" />
        </MudItem>
        <MudItem xs="12" md="2" Class="d-flex align-center justify-end gap-2">
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ApplyFilters" StartIcon="@Icons.Material.Filled.FilterAlt">
                            Apply
                        </MudButton>
            @if (_isExporting)
            {
                <MudButton Variant="Variant.Outlined" Color="Color.Primary" Disabled="true">
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    Exporting...
                </MudButton>
            }
            else
            {
                <MudMenu AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.TopLeft">
                    <ActivatorContent>
                        <MudButton Variant="Variant.Outlined" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Download">
                            Export
                        </MudButton>
                    </ActivatorContent>
                    <ChildContent>
                        <MudMenuItem OnClick="@(() => ExportSchedules("excel"))">Excel</MudMenuItem>
                        <MudMenuItem OnClick="@(() => ExportSchedules("csv"))">CSV</MudMenuItem>
                    </ChildContent>
                </MudMenu>
            }
        </MudItem>
    </MudGrid>
    
    @if (_selectedIds.Any())
    {
        <MudGrid Class="mb-4">
            <MudItem xs="12" Class="d-flex align-center gap-2">
                <MudButton Variant="Variant.Filled" Color="Color.Warning" OnClick="BulkTriggerSelected" Disabled="@_isBulkTriggering">
                    @if (_isBulkTriggering)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                        <text>Triggering...</text>
                    }
                    else
                    {
                        <text>Re-run Selected (@_selectedIds.Count)</text>
                    }
                </MudButton>
                <MudNumericField T="int" @bind-Value="_delayMs" Label="Delay (ms)" Variant="Variant.Outlined" Margin="Margin.Dense" Min="0" Max="10000" Style="width: 120px;" />
            </MudItem>
        </MudGrid>
    }
    
    @if (_filterDate.HasValue)
    {
        <MudAlert Severity="Severity.Info" Class="mb-2" CloseIconClicked="ClearDateFilter" ShowCloseIcon="true">
            Showing schedules for <strong>@_filterDate?.ToString("MMMM dd, yyyy")</strong>
        </MudAlert>
    }

    @if (_loading)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    }
    else
    {
        <MudTable T="Schedule" ServerData="@ServerReload" 
                  @ref="_table" Hover="true" Breakpoint="Breakpoint.Sm" Dense="true">
            <HeaderContent>
                <MudTh Style="width: 50px;">
                    <MudCheckBox T="bool" Value="@_selectAll" ValueChanged="@((bool value) => SelectAllVisible(value))" />
                </MudTh>
                <MudTh><MudTableSortLabel SortLabel="Name" T="Schedule">Name</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortLabel="JobType" T="Schedule">Type</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortLabel="Frequency" T="Schedule">Frequency</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortLabel="NextRunDateTime" T="Schedule" InitialDirection="SortDirection.Ascending">Next Run</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortLabel="LastRunDateTime" T="Schedule">Last Run Status</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortLabel="IsEnabled" T="Schedule">Status</MudTableSortLabel></MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>
                    <MudCheckBox T="bool" Value="@_selectedIds.Contains(context.Id)" 
                                 ValueChanged="@((bool value) => ToggleSelection(context.Id, value))" />
                </MudTd>
                <MudTd DataLabel="Name">
                    <MudText Typo="Typo.body1"><strong>@context.Name</strong></MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">@context.Description</MudText>
                </MudTd>
                <MudTd DataLabel="Type">
                    <MudChip T="string" Size="Size.Small">@context.JobType.ToString()</MudChip>
                </MudTd>
                <MudTd DataLabel="Frequency">@context.Frequency.ToString()</MudTd>
                                                <MudTd DataLabel="Next Run">
                                                    @if (context.NextRunDateTime.HasValue)
                                                    {
                                                        var localTime = ConvertToUserTime(context.NextRunDateTime.Value);
                                                        var hoursLate = (DateTime.UtcNow - context.NextRunDateTime.Value).TotalHours;
                                                        @if (context.IsEnabled && hoursLate > 24)
                                                        {
                                                            <MudTooltip Text="@($"Missed by {Math.Floor(hoursLate / 24)} day(s) - requires manual trigger")">
                                                                <MudIcon Icon="@Icons.Material.Filled.Warning" Color="Color.Warning" Size="Size.Small" Class="mr-1" />
                                                            </MudTooltip>
                                                        }
                                                        <text>@localTime.ToString("g") @(!string.IsNullOrEmpty(_userTimeZoneAbbr) ? $"({_userTimeZoneAbbr})" : "")</text>
                                                    }
                                                    else
                                                    {
                                                        <text>N/A</text>
                                                    }
                                                </MudTd>
                                <MudTd DataLabel="Last Run Status">
                                    @if (context.LastRunStatus.HasValue)
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context.LastRunStatus.Value)">
                                            @context.LastRunStatus.Value.ToString()
                                        </MudChip>
                                    }
                                    else
                                    {
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">N/A</MudText>
                                    }
                                    @if (context.LastRunDateTime.HasValue)
                                    {
                                        var localTime = ConvertToUserTime(context.LastRunDateTime.Value);
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                            @localTime.ToString("g") @(!string.IsNullOrEmpty(_userTimeZoneAbbr) ? $"({_userTimeZoneAbbr})" : "")
                                        </MudText>
                                    }
                                </MudTd>
                <MudTd DataLabel="Status">
                    @if (!context.IsEnabled)
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Warning" Class="mr-2">Paused</MudChip>
                    }
                    <MudSwitch T="bool" Value="context.IsEnabled" ValueChanged="@((bool value) => HandleToggleSchedule(context, value))" Color="Color.Primary" Disabled="@(!_canUpdate || (context.IsSystemSchedule && !_isSystemAdmin))" />
                </MudTd>
                <MudTd DataLabel="Actions">
                    <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small">
                        <MudMenuItem Icon="@Icons.Material.Filled.Visibility" OnClick="() => ViewScheduleDetails(context)">View Details</MudMenuItem>
                        @if (_canUpdate && !context.IsSystemSchedule)
                        {
                            <MudMenuItem Icon="@Icons.Material.Filled.Edit" OnClick="() => EditSchedule(context.Id)">Edit</MudMenuItem>
                        }
                        <MudMenuItem Icon="@Icons.Material.Filled.History" OnClick="() => ViewExecutions(context.Id)">View History</MudMenuItem>
                        @if (_canExecute)
                        {
                            <MudMenuItem Icon="@Icons.Material.Filled.PlayArrow" OnClick="() => TriggerSchedule(context)">Trigger Now</MudMenuItem>
                        }
                        @if (_canUpdate && (!context.IsSystemSchedule || _isSystemAdmin))
                        {
                            @if (context.IsEnabled)
                            {
                                <MudMenuItem Icon="@Icons.Material.Filled.Pause" OnClick="() => HandleToggleSchedule(context, false)">Pause Schedule</MudMenuItem>
                            }
                            else
                            {
                                <MudMenuItem Icon="@Icons.Material.Filled.PlayCircle" OnClick="() => HandleToggleSchedule(context, true)">Resume Schedule</MudMenuItem>
                            }
                        }
                        @if (_canDelete && !context.IsSystemSchedule)
                        {
                            <MudMenuItem Icon="@Icons.Material.Filled.Delete" OnClick="() => DeleteSchedule(context)">Delete</MudMenuItem>
                        }
                        @if (context.IsSystemSchedule && !_isSystemAdmin)
                        {
                            <MudMenuItem Icon="@Icons.Material.Filled.Lock" Disabled="true">System Schedule (Protected)</MudMenuItem>
                        }
                    </MudMenu>
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText Align="Align.Center" Class="my-8">
                    <MudIcon Icon="@Icons.Material.Filled.EventNote" Size="Size.Large" Class="mb-2" />
                    <MudText Typo="Typo.h6">No schedules found</MudText>
                    <MudText Typo="Typo.body2" Class="mb-4">
                        @if (!string.IsNullOrWhiteSpace(_searchTerm) || _selectedClientId.HasValue)
                        {
                            <span>Try adjusting your filters or create a new schedule.</span>
                        }
                        else
                        {
                            <span>Create your first schedule to get started.</span>
                        }
                    </MudText>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="CreateSchedule">Create Schedule</MudButton>
                </MudText>
            </NoRecordsContent>
            <PagerContent>
                <MudTablePager PageSizeOptions="new int[] { 20, 50, 100 }" />
            </PagerContent>
        </MudTable>
        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">
            Auto-refresh every @(_refreshInterval) seconds
        </MudText>
    }
</MudPaper>

@code {
	private MudTable<Schedule> _table = null!;
	private List<Client> _clients = new();
	private bool _loading = true;
	private string? _searchTerm;
	private Client? _selectedClient;
	private int? _selectedClientId => _selectedClient?.Id;
	private DateTime? _selectedDate;
	private DateTime? _filterDate;
	private string _selectedStatus = "Both";
	private string _selectedLastRunStatus = "All";
	private bool? _filterIsEnabled => _selectedStatus switch
	{
		"Enabled" => true,
		"Disabled" => false,
		_ => null
	};
	private bool _canCreate = false;
	private bool _canUpdate = false;
	private bool _canDelete = false;
	private bool _canExecute = false;
	private bool _isSystemAdmin = false;
	
	// Bulk selection state
	private HashSet<int> _selectedIds = new();
	private bool _selectAll = false;
	private bool _isBulkTriggering = false;
	private bool _isExporting = false;
	private int _delayMs = 1000;
	private List<Schedule> _currentPageItems = new();
	
	// Auto-refresh
	private int _refreshInterval = 60;
	private PeriodicTimer? _timer;
	private CancellationTokenSource? _timerCts;
	
	// Cached timezone info for display
	private string _userTimeZoneAbbr = "";
	private string _userTimeZoneId = "";

	[Parameter]
	[SupplyParameterFromQuery(Name = "date")]
	public string? DateParam { get; set; }

	protected override async Task OnInitializedAsync()
	{
		// Initialize timezone info
		_userTimeZoneId = await TimeZoneService.GetUserTimeZoneIdAsync();
		_userTimeZoneAbbr = await TimeZoneService.GetUserTimeZoneAbbreviationAsync();
		
		if (!string.IsNullOrWhiteSpace(DateParam) && DateTime.TryParse(DateParam, out var parsedDate))
		{
			_selectedDate = parsedDate;
			_filterDate = parsedDate;
		}

		await LoadPermissionsAsync();

		// DEBUG: Log what permissions we got
		var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
		var user = authState.User;
		Console.WriteLine($"User: {user.Identity?.Name}, IsAuthenticated: {user.Identity?.IsAuthenticated}");
		Console.WriteLine($"Claims count: {user.Claims.Count()}");
		foreach (var claim in user.Claims)
		{
			Console.WriteLine($"  Claim: {claim.Type} = {claim.Value}");
		}
		Console.WriteLine($"Permissions: Create={_canCreate}, Update={_canUpdate}, Delete={_canDelete}, Execute={_canExecute}");


			AuthenticationStateProvider.AuthenticationStateChanged += OnAuthenticationStateChanged;

			try
			{
				_clients = await ClientService.GetClientsAsync();
			}
			catch (Exception ex)
			{
				Snackbar.Add($"Error loading clients: {ex.Message}", Severity.Error);
			}
			finally
			{
				_loading = false;
			}
		
			StartAutoRefresh();
		}
	
		private void StartAutoRefresh()
			{
				_timerCts = new CancellationTokenSource();
				_timer = new PeriodicTimer(TimeSpan.FromSeconds(_refreshInterval));
				_ = Task.Run(async () =>
				{
					try
					{
						while (await _timer.WaitForNextTickAsync(_timerCts.Token))
						{
							await InvokeAsync(async () =>
							{
								if (_table != null && !_loading)
								{
									await _table.ReloadServerData();
								}
							});
						}
					}
					catch (SessionExpiredException)
					{
						await InvokeAsync(() =>
						{
							Snackbar.Add("Your session has expired. Redirecting to login...", Severity.Warning);
							Navigation.NavigateTo("/Account/Login", forceLoad: true);
							return Task.CompletedTask;
						});
					}
					catch (OperationCanceledException)
					{
						// Timer was cancelled, this is expected on dispose
					}
					catch
					{
						// Ignore other errors during auto-refresh
					}
				});
			}

	private async Task LoadPermissionsAsync()
	{
		_canCreate = await PermissionService.CanCreateAsync("schedules");
		_canUpdate = await PermissionService.CanUpdateAsync("schedules");
		_canDelete = await PermissionService.CanDeleteAsync("schedules");
		_canExecute = await PermissionService.CanExecuteAsync("schedules");
		_isSystemAdmin = await PermissionService.IsSystemAdminAsync();
	}

	private async void OnAuthenticationStateChanged(Task<AuthenticationState> task)
	{
		await LoadPermissionsAsync();
		await InvokeAsync(StateHasChanged);
	}

	public void Dispose()
		{
			AuthenticationStateProvider.AuthenticationStateChanged -= OnAuthenticationStateChanged;
			_timerCts?.Cancel();
			_timerCts?.Dispose();
			_timer?.Dispose();
		}

	private async Task<TableData<Schedule>> ServerReload(TableState state, CancellationToken cancellationToken)
	{
		_loading = true;
		try
		{
			var pageNumber = state.Page + 1;
			var pageSize = state.PageSize;

			var result = await ScheduleService.GetSchedulesPagedAsync(
				pageNumber,
				pageSize,
				_selectedClientId,
				_searchTerm,
				_filterIsEnabled);

			var items = result.Items;

			if (_filterDate.HasValue)
			{
				items = items.Where(s => s.NextRunDateTime.HasValue &&
										s.NextRunDateTime.Value.Date == _filterDate.Value.Date).ToList();
			}

			// Filter by Last Run Status
			if (_selectedLastRunStatus != "All")
			{
				items = _selectedLastRunStatus switch
				{
					"Never" => items.Where(s => !s.LastRunStatus.HasValue).ToList(),
					"Failed" => items.Where(s => s.LastRunStatus == JobStatus.Failed).ToList(),
					"Completed" => items.Where(s => s.LastRunStatus == JobStatus.Completed).ToList(),
					"Running" => items.Where(s => s.LastRunStatus == JobStatus.Running).ToList(),
					"Cancelled" => items.Where(s => s.LastRunStatus == JobStatus.Cancelled).ToList(),
					"Retrying" => items.Where(s => s.LastRunStatus == JobStatus.Retrying).ToList(),
					_ => items
				};
			}

			// Apply sorting
			items = ApplySorting(items, state.SortLabel, state.SortDirection);

			// Store current page items for select all functionality
			_currentPageItems = items.ToList();
			_selectAll = _currentPageItems.Any() && _currentPageItems.All(s => _selectedIds.Contains(s.Id));

			return new TableData<Schedule>
			{
				Items = items,
				TotalItems = (_filterDate.HasValue || _selectedLastRunStatus != "All") ? items.Count : result.TotalCount
			};
		}
		catch (Exception ex)
		{
			Snackbar.Add($"Error loading schedules: {ex.Message}", Severity.Error);
			return new TableData<Schedule> { Items = new List<Schedule>(), TotalItems = 0 };
		}
		finally
		{
			_loading = false;
		}
	}

	private List<Schedule> ApplySorting(IList<Schedule> items, string? sortLabel, SortDirection sortDirection)
	{
		if (string.IsNullOrEmpty(sortLabel))
		{
			// Default sort: Next Run ascending (soonest first)
			return items.OrderBy(s => s.NextRunDateTime ?? DateTime.MaxValue).ToList();
		}

		var isDescending = sortDirection == SortDirection.Descending;

		return sortLabel switch
		{
			"Name" => isDescending 
				? items.OrderByDescending(s => s.Name).ToList() 
				: items.OrderBy(s => s.Name).ToList(),
			"JobType" => isDescending 
				? items.OrderByDescending(s => s.JobType).ToList() 
				: items.OrderBy(s => s.JobType).ToList(),
			"Frequency" => isDescending 
				? items.OrderByDescending(s => s.Frequency).ToList() 
				: items.OrderBy(s => s.Frequency).ToList(),
			"NextRunDateTime" => isDescending 
				? items.OrderByDescending(s => s.NextRunDateTime ?? DateTime.MaxValue).ToList() 
				: items.OrderBy(s => s.NextRunDateTime ?? DateTime.MaxValue).ToList(),
			"LastRunDateTime" => isDescending 
				? items.OrderByDescending(s => s.LastRunDateTime ?? DateTime.MinValue).ToList() 
				: items.OrderBy(s => s.LastRunDateTime ?? DateTime.MinValue).ToList(),
			"IsEnabled" => isDescending 
				? items.OrderByDescending(s => s.IsEnabled).ToList() 
				: items.OrderBy(s => s.IsEnabled).ToList(),
			_ => items.OrderBy(s => s.NextRunDateTime ?? DateTime.MaxValue).ToList()
		};
	}

	private async Task<IEnumerable<Client>> SearchClients(string value, CancellationToken cancellationToken)
	{
		if (string.IsNullOrEmpty(value))
			return _clients;

		return _clients.Where(c => c.ClientName.Contains(value, StringComparison.OrdinalIgnoreCase));
	}

	private void ClearDateFilter()
	{
		_selectedDate = null;
		_filterDate = null;
		Navigation.NavigateTo("/schedules");
	}

	private async Task ApplyFilters()
	{
		_filterDate = _selectedDate;
		_selectedIds.Clear();
		_selectAll = false;
		await _table.ReloadServerData();
	}

	private void SelectAllVisible(bool selected)
	{
		_selectAll = selected;
		if (selected)
		{
			foreach (var item in _currentPageItems)
			{
				_selectedIds.Add(item.Id);
			}
		}
		else
		{
			foreach (var item in _currentPageItems)
			{
				_selectedIds.Remove(item.Id);
			}
		}
	}

	private void ToggleSelection(int id, bool selected)
	{
		if (selected)
		{
			_selectedIds.Add(id);
		}
		else
		{
			_selectedIds.Remove(id);
		}
		_selectAll = _currentPageItems.Any() && _currentPageItems.All(s => _selectedIds.Contains(s.Id));
	}

	private async Task BulkTriggerSelected()
	{
		if (!_selectedIds.Any()) return;

		var confirmed = await DialogService.ShowMessageBox(
			"Re-run Selected Schedules",
			$"Are you sure you want to re-run {_selectedIds.Count} schedule(s)? They will be executed with a {_delayMs}ms delay between each.",
			yesText: "Re-run All", cancelText: "Cancel");

		if (confirmed != true) return;

		_isBulkTriggering = true;
		StateHasChanged();

		try
		{
			var result = await ScheduleService.BulkTriggerMissedSchedulesAsync(_selectedIds.ToList(), _delayMs);
			
			if (result.FailureCount == 0)
			{
				Snackbar.Add($"Successfully triggered {result.SuccessCount} schedule(s)", Severity.Success);
			}
			else
			{
				Snackbar.Add($"Triggered {result.SuccessCount} schedule(s), {result.FailureCount} failed", Severity.Warning);
			}

			_selectedIds.Clear();
			_selectAll = false;
			await _table.ReloadServerData();
		}
		catch (Exception ex)
		{
			Snackbar.Add($"Error triggering schedules: {ex.Message}", Severity.Error);
		}
		finally
		{
			_isBulkTriggering = false;
		}
	}

	private async Task ExportSchedules(string format)
	{
		_isExporting = true;
		StateHasChanged();
		try
		{
			var startDate = _filterDate?.Date;
			var endDate = _filterDate?.Date.AddDays(1).AddTicks(-1);

			var bytes = await ScheduleService.DownloadSchedulesExportAsync(
				_selectedClientId,
				_searchTerm,
				startDate,
				endDate,
				format);

			var contentType = format.Equals("excel", StringComparison.OrdinalIgnoreCase)
				? "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
				: "text/csv";

			var filename = $"schedules_{DateTime.UtcNow:yyyyMMddHHmmss}.{(format.Equals("excel", StringComparison.OrdinalIgnoreCase) ? "xlsx" : "csv")}";

			var base64 = Convert.ToBase64String(bytes);
			await JSRuntime.InvokeVoidAsync("downloadFile", filename, contentType, base64);

			Snackbar.Add($"Export downloaded: {filename}", Severity.Success);
		}
		catch (Exception ex)
		{
			Snackbar.Add($"Export failed: {ex.Message}", Severity.Error);
		}
		finally
		{
			_isExporting = false;
		}
	}

	private void CreateSchedule()
	{
		Navigation.NavigateTo("/schedules/create");
	}

	private void EditSchedule(int id)
	{
		Navigation.NavigateTo($"/schedules/edit/{id}");
	}

	private void ViewExecutions(int id)
	{
		Navigation.NavigateTo($"/executions?scheduleId={id}");
	}

	private async Task ViewScheduleDetails(Schedule schedule)
	{
		var parameters = new DialogParameters
		{
			{ "Schedule", schedule }
		};

		var options = new DialogOptions
		{
			MaxWidth = MaxWidth.Large,
			FullWidth = true
		};

		await DialogService.ShowAsync<ScheduleDetailsDialog>("Schedule Details", parameters, options);
	}

	private async Task HandleToggleSchedule(Schedule schedule, bool newValue)
	{
		try
		{
			schedule.IsEnabled = newValue;

			if (schedule.IsEnabled)
			{
				await ScheduleService.ResumeScheduleAsync(schedule.Id);
				Snackbar.Add($"Schedule '{schedule.Name}' enabled", Severity.Success);
			}
			else
			{
				await ScheduleService.PauseScheduleAsync(schedule.Id);
				Snackbar.Add($"Schedule '{schedule.Name}' paused", Severity.Success);
			}
		}
		catch (Exception ex)
		{
			Snackbar.Add($"Error toggling schedule: {ex.Message}", Severity.Error);
			schedule.IsEnabled = !schedule.IsEnabled;
		}
	}

	private async Task TriggerSchedule(Schedule schedule)
	{
		var confirmed = await DialogService.ShowMessageBox(
			"Trigger Schedule",
			$"Are you sure you want to trigger '{schedule.Name}' now?",
			yesText: "Trigger", cancelText: "Cancel");

		if (confirmed == true)
		{
			try
			{
				await ScheduleService.TriggerScheduleAsync(schedule.Id);
				Snackbar.Add($"Schedule '{schedule.Name}' triggered", Severity.Success);
			}
			catch (Exception ex)
			{
				Snackbar.Add($"Error triggering schedule: {ex.Message}", Severity.Error);
			}
		}
	}

	private async Task DeleteSchedule(Schedule schedule)
	{
		var confirmed = await DialogService.ShowMessageBox(
			"Delete Schedule",
			$"Are you sure you want to delete '{schedule.Name}'? This action cannot be undone.",
			yesText: "Delete", cancelText: "Cancel");

		if (confirmed == true)
		{
			try
			{
				await ScheduleService.DeleteScheduleAsync(schedule.Id);
				Snackbar.Add($"Schedule '{schedule.Name}' deleted", Severity.Success);
				await _table.ReloadServerData();
			}
			catch (Exception ex)
			{
				Snackbar.Add($"Error deleting schedule: {ex.Message}", Severity.Error);
			}
		}
	}

	private Color GetStatusColor(JobStatus status)
	{
		return status switch
		{
			JobStatus.Completed => Color.Success,
			JobStatus.Failed => Color.Error,
			JobStatus.Running => Color.Info,
			JobStatus.Retrying => Color.Warning,
			JobStatus.Cancelled => Color.Default,
			_ => Color.Default
		};
	}

	/// <summary>
	/// Converts a UTC DateTime to the user's preferred timezone.
	/// Uses the cached timezone ID from initialization.
	/// </summary>
	private DateTime ConvertToUserTime(DateTime utcDateTime)
	{
		if (string.IsNullOrEmpty(_userTimeZoneId))
			return utcDateTime;
		
		try
		{
			// Handle Unspecified kind by treating it as UTC
			if (utcDateTime.Kind == DateTimeKind.Unspecified)
				utcDateTime = DateTime.SpecifyKind(utcDateTime, DateTimeKind.Utc);
			
			var tz = TimeZoneInfo.FindSystemTimeZoneById(_userTimeZoneId);
			return TimeZoneInfo.ConvertTimeFromUtc(utcDateTime, tz);
		}
		catch
		{
			return utcDateTime;
		}
	}
}
