@page "/"
@page "/dashboard"
@rendermode InteractiveServer
@attribute [Authorize]
@using SchedulerPlatform.Core.Domain.Enums
@using SchedulerPlatform.UI.Services
@inject IDashboardService DashboardService
@inject IClientService ClientService
@inject IScheduleService ScheduleService
@inject IAdrService AdrService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@implements IDisposable

<PageTitle>Dashboard</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Dashboard</MudText>

<MudText Typo="Typo.h5" Class="mb-2">ADR (Automated Document Retrieval)</MudText>
<MudGrid Class="mb-4" Spacing="2">
    <MudItem xs="6" md="2" lg="2">
        <MudCard Style="cursor: pointer;" @onclick="@(() => NavigationManager.NavigateTo("/adr/accounts"))">
            <MudCardContent>
                <MudText Typo="Typo.h6" Color="Color.Primary">Total Accounts</MudText>
                @if (_adrLoading && _adrStats == null)
                {
                    <MudProgressCircular Color="Color.Primary" Size="Size.Small" Indeterminate="true" />
                }
                else if (_adrStats != null)
                {
                    <MudText Typo="Typo.h3">@FormatNumber(_adrStats.TotalAccounts)</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        ADR-enabled accounts
                    </MudText>
                    <MudText Typo="Typo.caption" Color="Color.Primary">(click to view)</MudText>
                }
            </MudCardContent>
        </MudCard>
    </MudItem>

    <MudItem xs="6" md="2" lg="2">
        <MudCard Style="cursor: pointer;" @onclick="@(() => NavigationManager.NavigateTo("/adr/accounts?nextRunStatus=Run%20Now"))">
            <MudCardContent>
                <MudText Typo="Typo.h6" Color="Color.Error">Run Now</MudText>
                @if (_adrLoading && _adrStats == null)
                {
                    <MudProgressCircular Color="Color.Error" Size="Size.Small" Indeterminate="true" />
                }
                else if (_adrStats != null)
                {
                    <MudText Typo="Typo.h3" Color="@(_adrStats.RunNowCount > 0 ? Color.Error : Color.Default)">@FormatNumber(_adrStats.RunNowCount)</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        Ready to process
                    </MudText>
                    <MudText Typo="Typo.caption" Color="Color.Error">(click to view)</MudText>
                }
            </MudCardContent>
        </MudCard>
    </MudItem>

    <MudItem xs="6" md="2" lg="2">
        <MudCard Style="cursor: pointer;" @onclick="@(() => NavigationManager.NavigateTo("/adr/accounts?nextRunStatus=Due%20Soon"))">
            <MudCardContent>
                <MudText Typo="Typo.h6" Color="Color.Warning">Due Soon</MudText>
                @if (_adrLoading && _adrStats == null)
                {
                    <MudProgressCircular Color="Color.Warning" Size="Size.Small" Indeterminate="true" />
                }
                else if (_adrStats != null)
                {
                    <MudText Typo="Typo.h3" Color="@(_adrStats.DueSoonCount > 0 ? Color.Warning : Color.Default)">@FormatNumber(_adrStats.DueSoonCount)</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        Within 7 days
                    </MudText>
                    <MudText Typo="Typo.caption" Color="Color.Warning">(click to view)</MudText>
                }
            </MudCardContent>
        </MudCard>
    </MudItem>

    <MudItem xs="6" md="2" lg="2">
        <MudCard Style="cursor: pointer;" @onclick="@(() => NavigationManager.NavigateTo("/adr/missing-accounts"))">
            <MudCardContent>
                <MudText Typo="Typo.h6" Color="Color.Error">Missing Invoices</MudText>
                @if (_adrLoading && _adrStats == null)
                {
                    <MudProgressCircular Color="Color.Error" Size="Size.Small" Indeterminate="true" />
                }
                else if (_adrStats != null)
                {
                    <MudText Typo="Typo.h3" Color="@(_adrStats.MissingCount > 0 ? Color.Error : Color.Default)">@FormatNumber(_adrStats.MissingCount)</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        Accounts with missing invoices
                    </MudText>
                    <MudText Typo="Typo.caption" Color="Color.Error">(click to view)</MudText>
                }
            </MudCardContent>
        </MudCard>
    </MudItem>

    <MudItem xs="6" md="2" lg="2">
        <MudCard Style="cursor: pointer;" @onclick="@(() => NavigationManager.NavigateTo("/adr/jobs"))">
            <MudCardContent>
                <MudText Typo="Typo.h6" Color="Color.Info">Active Jobs</MudText>
                @if (_adrLoading && _adrStats == null)
                {
                    <MudProgressCircular Color="Color.Info" Size="Size.Small" Indeterminate="true" />
                }
                else if (_adrStats != null)
                {
                    <MudText Typo="Typo.h3">@FormatNumber(_adrStats.ActiveJobsCount)</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        Jobs in progress
                    </MudText>
                    <MudText Typo="Typo.caption" Color="Color.Info">(click to view)</MudText>
                }
            </MudCardContent>
        </MudCard>
    </MudItem>

    <MudItem xs="6" md="2" lg="2">
        <MudCard Style="cursor: pointer;" @onclick="@(() => NavigationManager.NavigateTo("/adr/monitor"))">
            <MudCardContent>
                <MudText Typo="Typo.h6" Color="@GetOrchestrationStatusColor()">Orchestration</MudText>
                @if (_orchestrationLoading && _orchestrationStatus == null)
                {
                    <MudProgressCircular Color="Color.Primary" Size="Size.Small" Indeterminate="true" />
                }
                else if (_orchestrationStatus != null)
                {
                    @if (_orchestrationStatus.IsRunning && _orchestrationStatus.Status != null)
                    {
                        <MudText Typo="Typo.h5" Color="Color.Info">Running</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            @(_orchestrationStatus.Status.CurrentStep ?? "Processing...")
                        </MudText>
                    }
                    else
                    {
                        <MudText Typo="Typo.h5" Color="Color.Success">Idle</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            Ready to run
                        </MudText>
                    }
                    <MudText Typo="Typo.caption" Color="@GetOrchestrationStatusColor()">(click to monitor)</MudText>
                }
            </MudCardContent>
        </MudCard>
    </MudItem>
</MudGrid>

<MudGrid Class="mt-2 mb-4" Spacing="2">
    <MudItem xs="12" md="6" Class="d-flex">
        <MudPaper Class="pa-4 d-flex flex-column flex-grow-1">
            <MudText Typo="Typo.h6" Class="mb-4">ADR Account Status</MudText>
            @if (_adrLoading && _adrStats == null)
            {
                <div class="d-flex justify-center py-8">
                    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                </div>
            }
            else if (_adrStats != null && _adrAccountChartData.Any())
            {
                                <MudChart ChartType="ChartType.Donut" 
                                         InputData="@_adrAccountChartData" 
                                         InputLabels="@_adrAccountChartLabels"
                                         ChartOptions="@_adrAccountChartOptions"
                                         Width="100%" 
                                         Height="300px">
                                </MudChart>
                <MudGrid Class="mt-2">
                    <MudItem xs="6">
                        <MudText Typo="Typo.body2"><strong>Run Now:</strong> @FormatNumber(_adrStats.RunNowCount)</MudText>
                    </MudItem>
                    <MudItem xs="6">
                        <MudText Typo="Typo.body2"><strong>Due Soon:</strong> @FormatNumber(_adrStats.DueSoonCount)</MudText>
                    </MudItem>
                    <MudItem xs="6">
                        <MudText Typo="Typo.body2"><strong>Upcoming:</strong> @FormatNumber(_adrStats.UpcomingCount)</MudText>
                    </MudItem>
                    <MudItem xs="6">
                        <MudText Typo="Typo.body2"><strong>Future:</strong> @FormatNumber(_adrStats.FutureCount)</MudText>
                    </MudItem>
                    <MudItem xs="6">
                        <MudText Typo="Typo.body2"><strong>Missing:</strong> @FormatNumber(_adrStats.MissingCount)</MudText>
                    </MudItem>
                </MudGrid>
            }
            else
            {
                <MudText Typo="Typo.body1" Color="Color.Secondary">No ADR account data available</MudText>
            }
        </MudPaper>
    </MudItem>

    <MudItem xs="12" md="6" Class="d-flex">
        <MudPaper Class="pa-4 d-flex flex-column flex-grow-1">
            <MudText Typo="Typo.h6" Class="mb-4">ADR Job Status</MudText>
            @if (_adrJobStatsLoading && _adrJobStats == null)
            {
                <div class="d-flex justify-center py-8">
                    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                </div>
            }
            else if (_adrJobStats != null)
            {
                <MudGrid Spacing="2" Class="mb-4">
                    <MudItem xs="4">
                        <MudPaper Class="pa-3 d-flex flex-column align-center" Style="background-color: rgba(158, 158, 158, 0.1); border-left: 4px solid #9e9e9e;">
                            <MudText Typo="Typo.h5" Style="color: #9e9e9e;">@FormatNumber(_adrJobStats.PendingCount)</MudText>
                            <MudText Typo="Typo.caption">Pending</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="4">
                        <MudPaper Class="pa-3 d-flex flex-column align-center" Style="background-color: rgba(66, 165, 245, 0.1); border-left: 4px solid #42a5f5;">
                            <MudText Typo="Typo.h5" Style="color: #42a5f5;">@FormatNumber(_adrJobStats.CredentialVerifiedCount)</MudText>
                            <MudText Typo="Typo.caption">Credential Verified</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="4">
                        <MudPaper Class="pa-3 d-flex flex-column align-center" Style="background-color: rgba(126, 87, 194, 0.1); border-left: 4px solid #7e57c2;">
                            <MudText Typo="Typo.h5" Style="color: #7e57c2;">@FormatNumber(_adrJobStats.ScrapeRequestedCount)</MudText>
                            <MudText Typo="Typo.caption">ADR Request Sent</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="4">
                        <MudPaper Class="pa-3 d-flex flex-column align-center" Style="background-color: rgba(102, 187, 106, 0.1); border-left: 4px solid #66bb6a;">
                            <MudText Typo="Typo.h5" Style="color: #66bb6a;">@FormatNumber(_adrJobStats.CompletedCount)</MudText>
                            <MudText Typo="Typo.caption">Completed</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="4">
                        <MudPaper Class="pa-3 d-flex flex-column align-center" Style="background-color: rgba(244, 67, 54, 0.1); border-left: 4px solid #f44336;">
                            <MudText Typo="Typo.h5" Style="color: #f44336;">@FormatNumber(_adrJobStats.FailedCount)</MudText>
                            <MudText Typo="Typo.caption">Failed</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="4">
                        <MudPaper Class="pa-3 d-flex flex-column align-center" Style="background-color: rgba(255, 167, 38, 0.1); border-left: 4px solid #ffa726;">
                            <MudText Typo="Typo.h5" Style="color: #ffa726;">@FormatNumber(_adrJobStats.NeedsReviewCount)</MudText>
                            <MudText Typo="Typo.caption">Needs Review</MudText>
                        </MudPaper>
                    </MudItem>
                </MudGrid>
                @if (_adrJobChartData.Any(d => d > 0))
                {
                    <PlotlyPieChart Values="@_adrJobChartData"
                                    Labels="@_adrJobChartLabels"
                                    Colors="@_adrJobChartColors"
                                    Height="220px"
                                    ShowLegend="true" />
                }
            }
            else
            {
                <MudText Typo="Typo.body1" Color="Color.Secondary">No ADR job data available</MudText>
            }
        </MudPaper>
    </MudItem>
</MudGrid>

<MudGrid Class="mt-2 mb-4" Spacing="2">
    <MudItem xs="12">
        <MudPaper Class="pa-4">
            <div class="d-flex justify-space-between align-center mb-4">
                <MudText Typo="Typo.h6">Recent Orchestration Runs</MudText>
                <MudButton Variant="Variant.Text" 
                           Color="Color.Primary" 
                           EndIcon="@Icons.Material.Filled.ArrowForward"
                           OnClick="@(() => NavigationManager.NavigateTo("/adr/monitor"))">
                    View All
                </MudButton>
            </div>
            @if (_orchestrationHistoryLoading && _orchestrationHistory == null)
            {
                <div class="d-flex justify-center py-4">
                    <MudProgressCircular Color="Color.Primary" Size="Size.Small" Indeterminate="true" />
                </div>
            }
            else if (_orchestrationHistory == null || !_orchestrationHistory.Any())
            {
                <MudText Typo="Typo.body2" Color="Color.Secondary" Align="Align.Center">
                    No orchestration history available
                </MudText>
            }
            else
            {
                <MudTable Items="_orchestrationHistory" Hover="true" Dense="true" Breakpoint="Breakpoint.Sm">
                    <HeaderContent>
                        <MudTh>Date</MudTh>
                        <MudTh>Status</MudTh>
                        <MudTh>Duration</MudTh>
                        <MudTh>Accounts Synced</MudTh>
                        <MudTh>Jobs Created</MudTh>
                        <MudTh>Credentials</MudTh>
                        <MudTh>ADR Requests</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Date">@context.RequestedAt.ToString("MM/dd hh:mm tt")</MudTd>
                        <MudTd DataLabel="Status">
                            <MudChip T="string" Size="Size.Small" Color="@GetOrchestrationHistoryStatusColor(context.Status)">@context.Status</MudChip>
                        </MudTd>
                        <MudTd DataLabel="Duration">
                            @if (context.StartedAt.HasValue && context.CompletedAt.HasValue)
                            {
                                var duration = context.CompletedAt.Value - context.StartedAt.Value;
                                <text>@duration.ToString(@"mm\:ss")</text>
                            }
                            else
                            {
                                <text>-</text>
                            }
                        </MudTd>
                        <MudTd DataLabel="Accounts Synced">
                            @if (context.SyncResult != null)
                            {
                                <text>@FormatNumber(context.SyncResult.AccountsInserted + context.SyncResult.AccountsUpdated)</text>
                            }
                            else if (context.Status == "Completed" || context.Status == "Failed")
                            {
                                <text>0</text>
                            }
                            else
                            {
                                <text>-</text>
                            }
                        </MudTd>
                        <MudTd DataLabel="Jobs Created">
                            @if (context.JobCreationResult != null)
                            {
                                <text>@FormatNumber(context.JobCreationResult.JobsCreated)</text>
                            }
                            else if (context.Status == "Completed" || context.Status == "Failed")
                            {
                                <text>0</text>
                            }
                            else
                            {
                                <text>-</text>
                            }
                        </MudTd>
                        <MudTd DataLabel="Credentials">
                            @if (context.CredentialVerificationResult != null)
                            {
                                <MudText Typo="Typo.body2">
                                    <span style="color: var(--mud-palette-success);">@context.CredentialVerificationResult.CredentialsVerified</span>
                                    /
                                    <span style="color: var(--mud-palette-error);">@context.CredentialVerificationResult.CredentialsFailed</span>
                                </MudText>
                            }
                            else if (context.Status == "Completed" || context.Status == "Failed")
                            {
                                <MudText Typo="Typo.body2">0/0</MudText>
                            }
                            else
                            {
                                <text>-</text>
                            }
                        </MudTd>
                        <MudTd DataLabel="ADR Requests">
                            @if (context.ScrapeResult != null)
                            {
                                <text>@FormatNumber(context.ScrapeResult.ScrapesRequested)</text>
                            }
                            else if (context.Status == "Completed" || context.Status == "Failed")
                            {
                                <text>0</text>
                            }
                            else
                            {
                                <text>-</text>
                            }
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            }
        </MudPaper>
    </MudItem>
</MudGrid>

<MudText Typo="Typo.h5" Class="mt-6 mb-2">Scheduler Metrics</MudText>
<MudPaper Class="pa-4 mb-4">
    <MudGrid>
        <MudItem xs="12" md="3">
            <MudSelect Value="_selectedTimeWindow" 
                      Label="Time Window" 
                      Variant="Variant.Outlined" 
                      Margin="Margin.Dense"
                      ValueChanged="@(async (int value) => await OnTimeWindowChanged(value))">
                <MudSelectItem Value="24">Last 24 Hours</MudSelectItem>
                <MudSelectItem Value="168">Last 7 Days</MudSelectItem>
                <MudSelectItem Value="720">Last 30 Days</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" md="3">
            <MudSelect Value="_selectedClientId" 
                      Label="Filter by Client" 
                      Variant="Variant.Outlined" 
                      Margin="Margin.Dense" 
                      Clearable="true"
                      ValueChanged="@(async (int? value) => await OnClientChanged(value))">
                <MudSelectItem Value="@((int?)null)">All Clients</MudSelectItem>
                @foreach (var client in _clients)
                {
                    <MudSelectItem Value="@((int?)client.Id)">@client.ClientName</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="12" md="4">
            <MudSelect T="JobStatus" 
                      @bind-Value="_selectedStatusesValue"
                      @bind-SelectedValues="SelectedStatuses"
                      Label="Filter by Status" 
                      Placeholder="All Statuses"
                      MultiSelectionTextFunc="@(selectedItems => selectedItems.Any() ? $"{selectedItems.Count} selected" : "All Statuses")"
                      Variant="Variant.Outlined" 
                      Margin="Margin.Dense" 
                      Clearable="true"
                      MultiSelection="true">
                <MudSelectItem Value="@JobStatus.Failed">Failed</MudSelectItem>
                <MudSelectItem Value="@JobStatus.Running">Running</MudSelectItem>
                <MudSelectItem Value="@JobStatus.Completed">Completed</MudSelectItem>
                <MudSelectItem Value="@JobStatus.Retrying">Retrying</MudSelectItem>
                <MudSelectItem Value="@JobStatus.Cancelled">Cancelled</MudSelectItem>
                <MudSelectItem Value="@JobStatus.Scheduled">Scheduled</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" md="2" Class="d-flex align-center justify-end">
            <MudIconButton Icon="@Icons.Material.Filled.Refresh" 
                          Color="Color.Primary" 
                          OnClick="RefreshData"
                          Disabled="@(_overviewLoading || _statusLoading || _trendsLoading || _longestLoading || _missedLoading)"
                          Title="Refresh Dashboard">
            </MudIconButton>
        </MudItem>
    </MudGrid>
    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">
        Auto-refresh every @(_refreshInterval) seconds
    </MudText>
</MudPaper>
<MudGrid Class="mb-4" Spacing="2">
    <MudItem xs="6" md="2" lg="2">
        <MudCard Style="cursor: pointer;" @onclick="@(() => NavigateToSchedules())">
            <MudCardContent>
                <MudText Typo="Typo.h6" Color="Color.Primary">Total Schedules</MudText>
                @if (_overviewLoading && _overview == null)
                {
                    <MudProgressCircular Color="Color.Primary" Size="Size.Small" Indeterminate="true" />
                }
                else if (_overview != null)
                {
                    <MudText Typo="Typo.h3">@FormatNumber(_overview.TotalSchedules)</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        @FormatNumber(_overview.EnabledSchedules) enabled, @FormatNumber(_overview.DisabledSchedules) disabled
                    </MudText>
                    <MudText Typo="Typo.caption" Color="Color.Primary">(click to view)</MudText>
                }
            </MudCardContent>
        </MudCard>
    </MudItem>

    <MudItem xs="6" md="2" lg="2">
        <MudCard Style="cursor: pointer;" @onclick="@(() => NavigateToExecutions("Running"))">
            <MudCardContent>
                <MudText Typo="Typo.h6" Color="Color.Info">Running Now</MudText>
                @if (_overviewLoading && _overview == null)
                {
                    <MudProgressCircular Color="Color.Info" Size="Size.Small" Indeterminate="true" />
                }
                else if (_overview != null)
                {
                    <MudText Typo="Typo.h3">@FormatNumber(_overview.RunningExecutions)</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        Peak: @FormatNumber(_overview.PeakConcurrentExecutions) concurrent
                    </MudText>
                    <MudText Typo="Typo.caption" Color="Color.Info">(click to view)</MudText>
                }
            </MudCardContent>
        </MudCard>
    </MudItem>

    <MudItem xs="6" md="2" lg="2">
        <MudCard Style="cursor: pointer;" @onclick="@(() => NavigateToExecutions("Completed"))">
            <MudCardContent>
                <MudText Typo="Typo.h6" Color="Color.Success">Completed Today</MudText>
                @if (_overviewLoading && _overview == null)
                {
                    <MudProgressCircular Color="Color.Success" Size="Size.Small" Indeterminate="true" />
                }
                else if (_overview != null)
                {
                    <MudText Typo="Typo.h3">@FormatNumber(_overview.CompletedToday)</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        Avg: @_overview.AverageDurationSeconds.ToString("F1")s
                    </MudText>
                    <MudText Typo="Typo.caption" Color="Color.Success">(click to view)</MudText>
                }
            </MudCardContent>
        </MudCard>
    </MudItem>

    <MudItem xs="6" md="2" lg="2">
        <MudCard Style="cursor: pointer;" @onclick="@(() => NavigateToExecutions("Failed"))">
            <MudCardContent>
                <MudText Typo="Typo.h6" Color="Color.Error">Failed Today</MudText>
                @if (_overviewLoading && _overview == null)
                {
                    <MudProgressCircular Color="Color.Error" Size="Size.Small" Indeterminate="true" />
                }
                else if (_overview != null)
                {
                    <MudText Typo="Typo.h3">@FormatNumber(_overview.FailedToday)</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        Total in window: @FormatNumber(_overview.TotalExecutionsInWindow)
                    </MudText>
                    <MudText Typo="Typo.caption" Color="Color.Error">(click to view)</MudText>
                }
            </MudCardContent>
        </MudCard>
    </MudItem>

    <MudItem xs="6" md="2" lg="2">
        <MudCard Style="cursor: pointer;" @onclick="NavigateToMissedSchedules">
            <MudCardContent>
                <MudText Typo="Typo.h6" Color="Color.Warning">Missed Schedules</MudText>
                @if (_missedLoading && _missedSchedulesCount == 0)
                {
                    <MudProgressCircular Color="Color.Warning" Size="Size.Small" Indeterminate="true" />
                }
                else
                {
                    <MudText Typo="Typo.h3" Color="@(_missedSchedulesCount > 0 ? Color.Warning : Color.Default)">@FormatNumber(_missedSchedulesCount)</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        In last 24 hours
                    </MudText>
                    <MudText Typo="Typo.caption" Color="Color.Warning">(click to view)</MudText>
                }
            </MudCardContent>
        </MudCard>
    </MudItem>
</MudGrid>

<MudGrid Class="mt-2 mb-4 dashboard-charts-grid">
    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4">
            <MudText Typo="Typo.h6" Class="mb-4">Status Breakdown</MudText>
            @if (_statusLoading && !_statusData.Any())
            {
                <div class="d-flex justify-center py-8">
                    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                </div>
            }
            else if (_statusData.Any())
            {
                <MudChart ChartType="ChartType.Donut" 
                         InputData="@_statusData" 
                         InputLabels="@_statusLabels"
                         Width="100%" 
                         Height="350px">
                </MudChart>
                <MudGrid Class="mt-2">
                    @foreach (var item in _statusSeries)
                    {
                        <MudItem xs="6">
                            <MudText Typo="Typo.body2">
                                <strong>@item.Status:</strong> @FormatNumber(item.Count) (@item.Percentage.ToString("F1")%)
                            </MudText>
                        </MudItem>
                    }
                </MudGrid>
            }
            else
            {
                <MudText Typo="Typo.body1" Color="Color.Secondary">No execution data available</MudText>
            }
        </MudPaper>
    </MudItem>

    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4">
            <MudText Typo="Typo.h6" Class="mb-4">Execution Duration Trends</MudText>
            @if (_trendsLoading && !_durationSeries.Any())
            {
                <div class="d-flex justify-center py-8">
                    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                </div>
            }
            else if (_durationSeries.Any() && _durationLabels.Any())
            {
                <MudChart ChartType="ChartType.Line" 
                         ChartSeries="@_durationSeries" 
                         XAxisLabels="@_durationLabels"
                         ChartOptions="@_lineChartOptions"
                         Width="100%" 
                         Height="350px">
                </MudChart>
            }
            else
            {
                <MudText Typo="Typo.body1" Color="Color.Secondary">No trend data available</MudText>
            }
        </MudPaper>
    </MudItem>

    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4">
            <MudText Typo="Typo.h6" Class="mb-4">Concurrent Executions Over Time</MudText>
            @if (_trendsLoading && !_concurrentSeries.Any())
            {
                <div class="d-flex justify-center py-8">
                    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                </div>
            }
            else if (_concurrentSeries.Any() && _concurrentLabels.Any())
            {
                <MudChart ChartType="ChartType.Line" 
                         ChartSeries="@_concurrentSeries" 
                         XAxisLabels="@_concurrentLabels"
                         ChartOptions="@_lineChartOptions"
                         Width="100%" 
                         Height="350px">
                </MudChart>
            }
            else
            {
                <MudText Typo="Typo.body1" Color="Color.Secondary">No concurrent execution data available</MudText>
            }
        </MudPaper>
    </MudItem>

    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4">
            <MudText Typo="Typo.h6" Class="mb-4">Top 10 Longest Running Schedules</MudText>
            @if (_longestLoading && !_longestSeries.Any())
            {
                <div class="d-flex justify-center py-8">
                    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                </div>
            }
            else if (_longestSeries.Any() && _longestLabels.Any())
            {
                <MudChart ChartType="ChartType.Bar" 
                         ChartSeries="@_longestSeries" 
                         XAxisLabels="@_longestLabels"
                         ChartOptions="@_barChartOptions"
                         Width="100%" 
                         Height="350px">
                </MudChart>
            }
            else
            {
                <MudText Typo="Typo.body1" Color="Color.Secondary">No execution data available</MudText>
            }
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    private DashboardOverview? _overview;
    private List<Client> _clients = new();
    private int _refreshInterval = 60;
    private PeriodicTimer? _timer;

    private int _selectedTimeWindow = 24;
    private int? _selectedClientId;
    private JobStatus _selectedStatusesValue;
        private IEnumerable<JobStatus>? _selectedStatusesBackingField = null;
    
                private bool _overviewLoading;
                private bool _statusLoading;
                private bool _trendsLoading;
                private bool _longestLoading;
                private bool _missedLoading;
                private bool _adrLoading;
                private bool _initialLoadComplete;
                private bool _timezoneLoaded;
    
                private int _missedSchedulesCount;
                private string? _browserTimeZone;
                private AdrAccountStats? _adrStats;
                private AdrJobStats? _adrJobStats;
                private bool _adrJobStatsLoading;
                private OrchestrationCurrentResponse? _orchestrationStatus;
                private bool _orchestrationLoading;
                private List<AdrOrchestrationStatus>? _orchestrationHistory;
                private bool _orchestrationHistoryLoading;
                
                private double[] _adrAccountChartData = Array.Empty<double>();
                private string[] _adrAccountChartLabels = Array.Empty<string>();
                private double[] _adrJobChartData = Array.Empty<double>();
                private string[] _adrJobChartLabels = Array.Empty<string>();
                private string[] _adrJobChartColors = Array.Empty<string>();
                private List<ChartSeries> _adrJobChartSeries = new();
    
        private IEnumerable<JobStatus>? SelectedStatuses
    {
        get => _selectedStatusesBackingField;
        set
        {
            _selectedStatusesBackingField = value?.Any() == true ? value : null;
            _ = InvokeAsync(RefreshData);
        }
    }

    private double[] _statusData = Array.Empty<double>();
    private string[] _statusLabels = Array.Empty<string>();
    private List<StatusBreakdownItem> _statusSeries = new();

    private List<ChartSeries> _durationSeries = new();
    private string[] _durationLabels = Array.Empty<string>();

    private List<ChartSeries> _concurrentSeries = new();
    private string[] _concurrentLabels = Array.Empty<string>();

    private List<ChartSeries> _longestSeries = new();
    private string[] _longestLabels = Array.Empty<string>();

    private ChartOptions _lineChartOptions = new ChartOptions
    {
        YAxisTicks = 10,
        LineStrokeWidth = 2
    };

    private ChartOptions _barChartOptions = new ChartOptions
    {
        YAxisTicks = 10
    };

    // Custom color palette for ADR Account Status chart to match tile colors
    // Order matches: Run Now, Due Soon, Upcoming, Future, Missing
    private ChartOptions _adrAccountChartOptions = new ChartOptions
    {
        ChartPalette = new[]
        {
            "#f44336", // Run Now (Error/Red)
            "#ff9800", // Due Soon (Warning/Orange)
            "#26c6da", // Upcoming (Info/Teal)
            "#66bb6a", // Future (Success/Green)
            "#f44336"  // Missing (Error/Red)
        }
    };

    // Custom color palette for ADR Job Status pie chart
    // Order matches: Pending, Credential Verified, ADR Request Sent, Completed, Failed, Needs Review
    // Colors aligned with Monitor page for consistency
    private ChartOptions _adrJobChartOptions = new ChartOptions
    {
        ChartPalette = new[]
        {
            "#9e9e9e", // Pending (Gray)
            "#42a5f5", // Credential Verified (Blue/Info)
            "#7e57c2", // ADR Request Sent (Purple/Primary)
            "#66bb6a", // Completed (Green/Success)
            "#f44336", // Failed (Red/Error)
            "#ffa726"  // Needs Review (Orange/Warning)
        }
    };

        protected override async Task OnInitializedAsync()
        {
            try
            {
                _clients = await ClientService.GetClientsAsync();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error loading clients: {ex.Message}", Severity.Error);
            }

            StartAutoRefresh();
        }

        protected override async Task OnAfterRenderAsync(bool firstRender)
        {
            if (firstRender && !_timezoneLoaded)
            {
                try
                {
                    _browserTimeZone = await JSRuntime.InvokeAsync<string>("getBrowserTimeZone");
                }
                catch (Exception ex)
                {
                    _browserTimeZone = "Central Standard Time";
                }
                _timezoneLoaded = true;
                RefreshData();
            }
        }

    private void StartAutoRefresh()
    {
        _timer = new PeriodicTimer(TimeSpan.FromSeconds(_refreshInterval));
        _ = Task.Run(async () =>
        {
            try
            {
                while (await _timer.WaitForNextTickAsync())
                {
                    await InvokeAsync(() =>
                    {
                        RefreshData();
                        return Task.CompletedTask;
                    });
                }
            }
            catch (SessionExpiredException)
            {
                await InvokeAsync(() =>
                {
                    Snackbar.Add("Your session has expired. Redirecting to login...", Severity.Warning);
                    NavigationManager.NavigateTo("/Account/Login", forceLoad: true);
                    return Task.CompletedTask;
                });
            }
            catch (OperationCanceledException)
            {
                // Timer was cancelled, this is expected on dispose
            }
            catch
            {
                // Ignore other errors during auto-refresh
            }
        });
    }

    private async Task OnTimeWindowChanged(int value)
    {
        _selectedTimeWindow = value;
        RefreshData();
    }

    private async Task OnClientChanged(int? value)
    {
        _selectedClientId = value;
        RefreshData();
    }

        private void RefreshData()
        {
            _ = LoadOverviewAsync();
            _ = LoadStatusBreakdownAsync();
            _ = LoadTrendsAsync();
            _ = LoadLongestAsync();
            _ = LoadMissedSchedulesAsync();
            _ = LoadAdrStatsAsync();
            _ = LoadAdrJobStatsAsync();
            _ = LoadOrchestrationStatusAsync();
            _ = LoadOrchestrationHistoryAsync();
        }
    
        private async Task LoadOverviewAsync()
        {
            if (_overviewLoading) return;
            _overviewLoading = true;
            try
            {
                _overview = await DashboardService.GetOverviewAsync(_selectedClientId, _selectedTimeWindow, _browserTimeZone);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error loading overview: {ex.Message}", Severity.Error);
            }
            finally
            {
                _overviewLoading = false;
                _initialLoadComplete = true;
                await InvokeAsync(StateHasChanged);
            }
        }
    
    private async Task LoadStatusBreakdownAsync()
    {
        if (_statusLoading) return;
        _statusLoading = true;
        try
        {
            var statusData = await DashboardService.GetStatusBreakdownAsync(_selectedTimeWindow, _selectedClientId);
            _statusSeries = statusData;
            _statusData = statusData.Select(x => (double)x.Count).ToArray();
            _statusLabels = statusData.Select(x => x.Status.ToString()).ToArray();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading status breakdown: {ex.Message}", Severity.Error);
        }
        finally
        {
            _statusLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }
    
    private async Task LoadTrendsAsync()
    {
        if (_trendsLoading) return;
        _trendsLoading = true;
        try
        {
            var statusList = _selectedStatusesBackingField?.ToList();
            var trendsData = await DashboardService.GetExecutionTrendsAsync(_selectedTimeWindow, _selectedClientId, statusList);
            
            _durationSeries = new List<ChartSeries>
            {
                new ChartSeries
                {
                    Name = "Avg Duration (seconds)",
                    Data = trendsData.Select(x => x.AverageDurationSeconds).ToArray()
                }
            };
            _durationLabels = trendsData.Select(x => FormatDateLabel(x.Hour)).ToArray();

            _concurrentSeries = new List<ChartSeries>
            {
                new ChartSeries
                {
                    Name = "Concurrent Executions",
                    Data = trendsData.Select(x => (double)x.ConcurrentCount).ToArray()
                }
            };
            _concurrentLabels = trendsData.Select(x => FormatDateLabel(x.Hour)).ToArray();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading trends: {ex.Message}", Severity.Error);
        }
        finally
        {
            _trendsLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }
    
    private async Task LoadLongestAsync()
    {
        if (_longestLoading) return;
        _longestLoading = true;
        try
        {
            var statusList = _selectedStatusesBackingField?.ToList();
            var longestData = await DashboardService.GetTopLongestExecutionsAsync(10, _selectedTimeWindow, _selectedClientId, statusList);
            
            _longestSeries = new List<ChartSeries>
            {
                new ChartSeries
                {
                    Name = "Duration (seconds)",
                    Data = longestData.Select(x => (double)x.DurationSeconds).ToArray()
                }
            };
            _longestLabels = longestData.Select(x => 
                x.ScheduleName.Length > 30 
                    ? x.ScheduleName.Substring(0, 27) + "..." 
                    : x.ScheduleName
            ).ToArray();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading top longest: {ex.Message}", Severity.Error);
        }
        finally
        {
            _longestLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

        private async Task LoadMissedSchedulesAsync()
        {
            if (_missedLoading) return;
            _missedLoading = true;
            try
            {
                _missedSchedulesCount = await ScheduleService.GetMissedSchedulesCountAsync(1);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error loading missed schedules: {ex.Message}", Severity.Error);
            }
            finally
            {
                _missedLoading = false;
                await InvokeAsync(StateHasChanged);
            }
        }

        private async Task LoadAdrStatsAsync()
        {
            if (_adrLoading) return;
            _adrLoading = true;
            try
            {
                _adrStats = await AdrService.GetAccountStatsAsync();
                
                if (_adrStats != null)
                {
                    _adrAccountChartData = new double[]
                    {
                        _adrStats.RunNowCount,
                        _adrStats.DueSoonCount,
                        _adrStats.UpcomingCount,
                        _adrStats.FutureCount,
                        _adrStats.MissingCount
                    };
                    _adrAccountChartLabels = new string[]
                    {
                        "Run Now",
                        "Due Soon",
                        "Upcoming",
                        "Future",
                        "Missing"
                    };
                }
            }
            catch (Exception ex)
            {
                // ADR stats are optional - don't show error to user if ADR is not configured
                Console.WriteLine($"Error loading ADR stats: {ex.Message}");
            }
            finally
            {
                _adrLoading = false;
                await InvokeAsync(StateHasChanged);
            }
        }

        private async Task LoadAdrJobStatsAsync()
        {
            if (_adrJobStatsLoading) return;
            _adrJobStatsLoading = true;
            try
            {
                _adrJobStats = await AdrService.GetJobStatsAsync();
                
                if (_adrJobStats != null)
                {
                    // Build chart data - only include non-zero values to avoid empty pie slices
                    var dataList = new List<double>();
                    var labelList = new List<string>();
                    var colorList = new List<string>();
                    
                    // Color palette matching the status cards
                    var colorMap = new Dictionary<string, string>
                    {
                        { "Pending", "#42a5f5" },           // Blue
                        { "Credential Verified", "#66bb6a" }, // Green
                        { "ADR Request Sent", "#ffca28" },  // Yellow
                        { "Completed", "#26c6da" },         // Teal
                        { "Failed", "#f44336" },            // Red
                        { "Needs Review", "#ff9800" }       // Orange
                    };
                    
                    if (_adrJobStats.PendingCount > 0)
                    {
                        dataList.Add(_adrJobStats.PendingCount);
                        labelList.Add("Pending");
                        colorList.Add(colorMap["Pending"]);
                    }
                    if (_adrJobStats.CredentialVerifiedCount > 0)
                    {
                        dataList.Add(_adrJobStats.CredentialVerifiedCount);
                        labelList.Add("Credential Verified");
                        colorList.Add(colorMap["Credential Verified"]);
                    }
                    if (_adrJobStats.ScrapeRequestedCount > 0)
                    {
                        dataList.Add(_adrJobStats.ScrapeRequestedCount);
                        labelList.Add("ADR Request Sent");
                        colorList.Add(colorMap["ADR Request Sent"]);
                    }
                    if (_adrJobStats.CompletedCount > 0)
                    {
                        dataList.Add(_adrJobStats.CompletedCount);
                        labelList.Add("Completed");
                        colorList.Add(colorMap["Completed"]);
                    }
                    if (_adrJobStats.FailedCount > 0)
                    {
                        dataList.Add(_adrJobStats.FailedCount);
                        labelList.Add("Failed");
                        colorList.Add(colorMap["Failed"]);
                    }
                    if (_adrJobStats.NeedsReviewCount > 0)
                    {
                        dataList.Add(_adrJobStats.NeedsReviewCount);
                        labelList.Add("Needs Review");
                        colorList.Add(colorMap["Needs Review"]);
                    }
                    
                    _adrJobChartData = dataList.ToArray();
                    _adrJobChartLabels = labelList.ToArray();
                    _adrJobChartColors = colorList.ToArray();
                    
                    // Keep for backward compatibility with other MudCharts
                    _adrJobChartSeries = new List<ChartSeries>
                    {
                        dataList.Add(_adrJobStats.FailedCount);
                        labelList.Add("Failed");
                    }
                    if (_adrJobStats.NeedsReviewCount > 0)
                    {
                        dataList.Add(_adrJobStats.NeedsReviewCount);
                        labelList.Add("Needs Review");
                    }
                    
                    _adrJobChartData = dataList.ToArray();
                    _adrJobChartLabels = labelList.ToArray();
                }
            }
            catch (Exception ex)
            {
                // ADR job stats are optional - don't show error to user if ADR is not configured
                Console.WriteLine($"Error loading ADR job stats: {ex.Message}");
            }
            finally
            {
                _adrJobStatsLoading = false;
                await InvokeAsync(StateHasChanged);
            }
        }

        private async Task LoadOrchestrationStatusAsync()
        {
            if (_orchestrationLoading) return;
            _orchestrationLoading = true;
            try
            {
                _orchestrationStatus = await AdrService.GetCurrentOrchestrationAsync();
            }
            catch (Exception ex)
            {
                // Orchestration status is optional - don't show error to user if ADR is not configured
                Console.WriteLine($"Error loading orchestration status: {ex.Message}");
            }
            finally
            {
                _orchestrationLoading = false;
                await InvokeAsync(StateHasChanged);
            }
        }

        private Color GetOrchestrationStatusColor()
        {
            if (_orchestrationStatus == null) return Color.Default;
            if (_orchestrationStatus.IsRunning) return Color.Info;
            return Color.Success;
        }

        private async Task LoadOrchestrationHistoryAsync()
        {
            if (_orchestrationHistoryLoading) return;
            _orchestrationHistoryLoading = true;
            try
            {
                _orchestrationHistory = await AdrService.GetOrchestrationHistoryAsync(5);
            }
            catch (Exception ex)
            {
                // Orchestration history is optional - don't show error to user if ADR is not configured
                Console.WriteLine($"Error loading orchestration history: {ex.Message}");
            }
            finally
            {
                _orchestrationHistoryLoading = false;
                await InvokeAsync(StateHasChanged);
            }
        }

        private Color GetOrchestrationHistoryStatusColor(string status) => status switch
        {
            "Queued" => Color.Default,
            "Running" => Color.Info,
            "Completed" => Color.Success,
            "Failed" => Color.Error,
            "Cancelled" => Color.Warning,
            _ => Color.Default
        };

        private string FormatDateLabel(DateTime dateTime)
    {
        if (_selectedTimeWindow <= 24)
        {
            return dateTime.ToString("HH:mm");
        }
        else if (_selectedTimeWindow <= 168)
        {
            return dateTime.ToString("MMM dd HH:mm");
        }
        else
        {
            return dateTime.ToString("MMM dd");
        }
    }
    
    private string FormatNumber(int value) => value.ToString("N0");
    
    private void NavigateToMissedSchedules()
    {
        NavigationManager.NavigateTo("/schedules/missed");
    }
    
    private void NavigateToSchedules()
    {
        NavigationManager.NavigateTo("/schedules");
    }
    
    private void NavigateToExecutions(string? status = null)
    {
        var url = "/executions";
        if (!string.IsNullOrEmpty(status))
        {
            url += $"?status={status}";
        }
        NavigationManager.NavigateTo(url);
    }

    public void Dispose()
    {
        _timer?.Dispose();
    }
}
