@page "/adr/accounts"
@rendermode InteractiveServer
@attribute [Authorize]
@inject IAdrService AdrService
@inject IClientService ClientService
@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime
@inject IPermissionService PermissionService

<PageTitle>ADR Accounts</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">ADR Accounts</MudText>

@if (_testModeStatus?.IsEnabled == true)
{
    <MudAlert Severity="Severity.Warning" Class="mb-4" Icon="@Icons.Material.Filled.Warning">
        <strong>TEST MODE IS ENABLED</strong> - ADR requests and rebill jobs are limited to @_testModeStatus.MaxScrapingJobs and @_testModeStatus.MaxRebillJobs respectively per orchestration run.
    </MudAlert>
}

<MudPaper Class="pa-4">
    <MudGrid Class="mb-4" Spacing="2">
        <MudItem xs="12" md="3">
            <MudTextField @bind-Value="_searchTerm" 
                          Label="Search by Account # or Interface Account ID" 
                          Placeholder="Enter account number or interface ID"
                          Variant="Variant.Outlined" 
                          Margin="Margin.Dense" 
                          Clearable="true"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          OnKeyDown="@OnSearchKeyDown" />
        </MudItem>
        <MudItem xs="12" md="2">
            <MudAutocomplete T="Client" 
                             Label="Filter by Client" 
                             @bind-Value="_selectedClient"
                             SearchFunc="SearchClients"
                             ToStringFunc="@(c => c?.ClientName ?? "All Clients")"
                             Variant="Variant.Outlined" 
                             Margin="Margin.Dense" 
                             Clearable="true"
                             ResetValueOnEmptyText="true"
                             CoerceText="false"
                             CoerceValue="true"
                             AdornmentIcon="@Icons.Material.Filled.Business"
                             AdornmentColor="Color.Primary" />
        </MudItem>
        <MudItem xs="12" md="2">
            <MudAutocomplete T="string" 
                             Label="Primary Vendor" 
                             @bind-Value="_selectedPrimaryVendorCode"
                             SearchFunc="SearchPrimaryVendors"
                             Variant="Variant.Outlined" 
                             Margin="Margin.Dense" 
                             Clearable="true"
                             ResetValueOnEmptyText="true"
                             CoerceText="false"
                             CoerceValue="true"
                             Placeholder="Type to search..."
                             AdornmentIcon="@Icons.Material.Filled.Store"
                             AdornmentColor="Color.Primary" />
        </MudItem>
        <MudItem xs="12" md="2">
            <MudAutocomplete T="string" 
                             Label="Master Vendor" 
                             @bind-Value="_selectedMasterVendorCode"
                             SearchFunc="SearchMasterVendors"
                             Variant="Variant.Outlined" 
                             Margin="Margin.Dense" 
                             Clearable="true"
                             ResetValueOnEmptyText="true"
                             CoerceText="false"
                             CoerceValue="true"
                             Placeholder="Type to search..."
                             AdornmentIcon="@Icons.Material.Filled.Business"
                             AdornmentColor="Color.Primary" />
        </MudItem>
        <MudItem xs="12" md="2">
            <MudSelect T="string" @bind-Value="_selectedNextRunStatus" Label="Next Run Status" Variant="Variant.Outlined" Margin="Margin.Dense" Clearable="true">
                <MudSelectItem Value="@("")">All</MudSelectItem>
                <MudSelectItem Value="@("Run Now")">Run Now</MudSelectItem>
                <MudSelectItem Value="@("Due Soon")">Due Soon</MudSelectItem>
                <MudSelectItem Value="@("Upcoming")">Upcoming</MudSelectItem>
                <MudSelectItem Value="@("Future")">Future</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" md="1">
            <MudSelect T="string" @bind-Value="_selectedOverrideFilter" Label="Override" Variant="Variant.Outlined" Margin="Margin.Dense" Clearable="true">
                <MudSelectItem Value="@("")">All</MudSelectItem>
                <MudSelectItem Value="@("true")">Overridden</MudSelectItem>
                <MudSelectItem Value="@("false")">Not Overridden</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" md="2">
            <MudSelect T="string" @bind-Value="_selectedHistoricalStatus" Label="Historical Status" Variant="Variant.Outlined" Margin="Margin.Dense" Clearable="true">
                <MudSelectItem Value="@("")">All</MudSelectItem>
                <MudSelectItem Value="@("Missing")">Missing</MudSelectItem>
                <MudSelectItem Value="@("Overdue")">Overdue</MudSelectItem>
                <MudSelectItem Value="@("Due Now")">Due Now</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" md="2">
            <MudSelect T="string" @bind-Value="_selectedJobStatus" Label="Job Status" Variant="Variant.Outlined" Margin="Margin.Dense" Clearable="true">
                <MudSelectItem Value="@("")">All</MudSelectItem>
                <MudSelectItem Value="@("NoJob")">No Job</MudSelectItem>
                <MudSelectItem Value="@("Pending")">Pending</MudSelectItem>
                <MudSelectItem Value="@("CredentialCheckInProgress")">Credential Check In Progress</MudSelectItem>
                <MudSelectItem Value="@("CredentialVerified")">Credential Verified</MudSelectItem>
                <MudSelectItem Value="@("CredentialFailed")">Credential Failed</MudSelectItem>
                <MudSelectItem Value="@("ScrapeInProgress")">ADR Request In Progress</MudSelectItem>
                <MudSelectItem Value="@("ScrapeRequested")">ADR Request Sent</MudSelectItem>
                <MudSelectItem Value="@("ScrapeFailed")">ADR Request Failed</MudSelectItem>
                <MudSelectItem Value="@("StatusCheckInProgress")">Status Check In Progress</MudSelectItem>
                <MudSelectItem Value="@("NoInvoiceFound")">No Invoice Found</MudSelectItem>
                <MudSelectItem Value="@("Failed")">Failed</MudSelectItem>
                <MudSelectItem Value="@("Completed")">Completed</MudSelectItem>
                <MudSelectItem Value="@("NeedsReview")">Needs Review</MudSelectItem>
                <MudSelectItem Value="@("Cancelled")">Cancelled</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" md="2">
            <MudSelect T="string" @bind-Value="_selectedBlacklistStatus" Label="Blacklist" Variant="Variant.Outlined" Margin="Margin.Dense" Clearable="true">
                <MudSelectItem Value="@("")">All</MudSelectItem>
                <MudSelectItem Value="@("current")">Currently Blacklisted</MudSelectItem>
                <MudSelectItem Value="@("future")">Future Blacklist</MudSelectItem>
                <MudSelectItem Value="@("any")">Any Blacklist</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" md="6" Class="d-flex align-center justify-end gap-2">
            <SchedulerPlatform.UI.Components.Shared.IconLegend ShowBlacklistIcons="true" ShowOverrideIcon="true" ShowWarningIcon="true" />
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ApplyFilters" StartIcon="@Icons.Material.Filled.FilterAlt">
                Apply
            </MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="ClearFilters" StartIcon="@Icons.Material.Filled.Clear">
                Clear
            </MudButton>
            @if (_isExporting)
            {
                <MudButton Variant="Variant.Outlined" Color="Color.Primary" Disabled="true">
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    Exporting...
                </MudButton>
            }
            else
            {
                <MudMenu AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.TopLeft">
                    <ActivatorContent>
                        <MudButton Variant="Variant.Outlined" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Download">
                            Export
                        </MudButton>
                    </ActivatorContent>
                    <ChildContent>
                        <MudMenuItem OnClick="@(() => ExportAccounts("excel"))">Excel</MudMenuItem>
                        <MudMenuItem OnClick="@(() => ExportAccounts("csv"))">CSV</MudMenuItem>
                    </ChildContent>
                </MudMenu>
            }
        </MudItem>
    </MudGrid>

    @if (_loading)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    }
    else
    {
        <MudTable T="AdrAccount" ServerData="@ServerReload" 
                  @ref="_table" Hover="true" Breakpoint="Breakpoint.Sm" Dense="true">
            <HeaderContent>
                <MudTh><MudTableSortLabel SortLabel="VMAccountNumber" T="AdrAccount">Account #</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortLabel="ClientName" T="AdrAccount">Client</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortLabel="MasterVendorCode" T="AdrAccount">Master Vendor</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortLabel="PrimaryVendorCode" T="AdrAccount">Primary Vendor</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortLabel="InterfaceAccountId" T="AdrAccount">Interface Account ID</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortLabel="PeriodType" T="AdrAccount">Period Type</MudTableSortLabel></MudTh>
                <MudTh>Last Completed</MudTh>
                <MudTh><MudTableSortLabel SortLabel="HistoricalBillingStatus" T="AdrAccount">Historical Status</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortLabel="NextRunDateTime" T="AdrAccount" InitialDirection="SortDirection.Ascending">Next Run</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortLabel="NextRunStatus" T="AdrAccount">Run Status</MudTableSortLabel></MudTh>
                <MudTh>Job Status</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Account #">
                    <div class="d-flex align-center gap-1">
                        <div>
                            <MudText Typo="Typo.body2"><strong>@context.VMAccountNumber</strong></MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">ID: @context.VMAccountId</MudText>
                        </div>
                        @if (context.RuleIsManuallyOverridden)
                        {
                            <MudTooltip Text="@($"Rule manually overridden by {context.RuleOverriddenBy} on {context.RuleOverriddenDateTime?.ToString("MM/dd/yyyy")}")">
                                <MudIcon Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Warning" />
                            </MudTooltip>
                        }
                        @if (context.HasCurrentBlacklist)
                        {
                            <MudTooltip Text="@GetBlacklistTooltip(context, true)">
                                <MudBadge Content="@context.CurrentBlacklistCount" Color="Color.Error" Overlap="true" Visible="@(context.CurrentBlacklistCount > 1)">
                                    <MudIcon Icon="@Icons.Material.Filled.Block" Size="Size.Small" Color="Color.Error" />
                                </MudBadge>
                            </MudTooltip>
                        }
                        else if (context.HasFutureBlacklist)
                        {
                            <MudTooltip Text="@GetBlacklistTooltip(context, false)">
                                <MudBadge Content="@context.FutureBlacklistCount" Color="Color.Warning" Overlap="true" Visible="@(context.FutureBlacklistCount > 1)">
                                    <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Small" Color="Color.Warning" />
                                </MudBadge>
                            </MudTooltip>
                        }
                    </div>
                </MudTd>
                <MudTd DataLabel="Client">@(context.ClientName ?? "N/A")</MudTd>
                <MudTd DataLabel="Master Vendor">@(context.MasterVendorCode ?? "N/A")</MudTd>
                <MudTd DataLabel="Primary Vendor">@(context.PrimaryVendorCode ?? "N/A")</MudTd>
                <MudTd DataLabel="Interface Account ID">@(context.InterfaceAccountId ?? "N/A")</MudTd>
                <MudTd DataLabel="Period Type">
                    @if (!string.IsNullOrEmpty(context.PeriodType))
                    {
                        <MudChip T="string" Size="Size.Small">@context.PeriodType</MudChip>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">N/A</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Last Completed">
                    @if (context.LastCompletedDateTime.HasValue)
                    {
                        <text>@context.LastCompletedDateTime.Value.ToString("MM/dd/yyyy")</text>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">N/A</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Historical Status">
                    @if (!string.IsNullOrEmpty(context.HistoricalBillingStatus))
                    {
                        <MudChip T="string" Size="Size.Small" Color="@GetHistoricalStatusColor(context.HistoricalBillingStatus)">
                            @context.HistoricalBillingStatus
                        </MudChip>
                    }
                </MudTd>
                <MudTd DataLabel="Next Run">
                    @if (context.NextRunDateTime.HasValue)
                    {
                        <div class="d-flex align-center gap-1">
                            <text>@context.NextRunDateTime.Value.ToString("MM/dd/yyyy")</text>
                            @if (context.LastInvoiceDateTime.HasValue && context.LastInvoiceDateTime.Value > DateTime.Today)
                            {
                                <MudTooltip Text="@($"Data Issue: Last Invoice Date ({context.LastInvoiceDateTime.Value:MM/dd/yyyy}) is in the future")">
                                    <MudIcon Icon="@Icons.Material.Filled.Warning" Size="Size.Small" Color="Color.Warning" />
                                </MudTooltip>
                            }
                        </div>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">N/A</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Run Status">
                    @if (!string.IsNullOrEmpty(context.NextRunStatus))
                    {
                        <MudChip T="string" Size="Size.Small" Color="@GetNextRunStatusColor(context.NextRunStatus)">
                            @context.NextRunStatus
                        </MudChip>
                    }
                </MudTd>
                <MudTd DataLabel="Job Status">
                    @if (!string.IsNullOrEmpty(context.CurrentJobStatus))
                    {
                        <MudChip T="string" Size="Size.Small" Color="@GetJobStatusColor(context.CurrentJobStatus)">
                            @GetJobStatusDisplayName(context.CurrentJobStatus)
                        </MudChip>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">No Job</MudText>
                    }
                </MudTd>
                                <MudTd DataLabel="Actions">
                                    <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small">
                                        <MudMenuItem Icon="@Icons.Material.Filled.Visibility" OnClick="() => ViewAccountDetails(context)">View Details</MudMenuItem>
                                        <MudMenuItem Icon="@Icons.Material.Filled.Work" OnClick="() => ViewJobs(context)">View Jobs</MudMenuItem>
                                        @if (_canEditBilling)
                                        {
                                            <MudMenuItem Icon="@Icons.Material.Filled.Edit" OnClick="() => EditBilling(context)">Edit Account Rules</MudMenuItem>
                                            @if (context.RuleIsManuallyOverridden)
                                            {
                                                <MudMenuItem Icon="@Icons.Material.Filled.Refresh" OnClick="() => ClearOverride(context)">Clear Override</MudMenuItem>
                                            }
                                        }
                                        @if (_canExecuteManualScrape)
                                        {
                                            <MudMenuItem Icon="@Icons.Material.Filled.CloudDownload" OnClick="() => OpenManualScrapeDialog(context)">Manual ADR Request</MudMenuItem>
                                            @if (CanCheckStatus(context.CurrentJobStatus))
                                            {
                                                <MudMenuItem Icon="@Icons.Material.Filled.Refresh" OnClick="() => CheckAccountJobStatus(context)">Check Status</MudMenuItem>
                                            }
                                        }
                                    </MudMenu>
                                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText Align="Align.Center" Class="my-8">
                    <MudIcon Icon="@Icons.Material.Filled.AccountBalance" Size="Size.Large" Class="mb-2" />
                    <MudText Typo="Typo.h6">No accounts found</MudText>
                    <MudText Typo="Typo.body2" Class="mb-4">
                        @if (!string.IsNullOrWhiteSpace(_searchTerm) || _selectedClientId.HasValue || !string.IsNullOrEmpty(_filterNextRunStatus) || !string.IsNullOrEmpty(_filterHistoricalStatus))
                        {
                            <span>Try adjusting your filters or search term.</span>
                        }
                        else
                        {
                            <span>No ADR accounts have been synced yet. Run the account sync to populate this list.</span>
                        }
                    </MudText>
                </MudText>
            </NoRecordsContent>
            <PagerContent>
                <MudTablePager PageSizeOptions="new int[] { 50, 100, 200 }" />
            </PagerContent>
        </MudTable>
    }
</MudPaper>

@code {
        private MudTable<AdrAccount> _table = null!;
        private List<Client> _clients = new();
        private bool _loading = true;
        private bool _isExporting = false;
        private bool _canEditBilling = false;
        private bool _canExecuteManualScrape = false;
        private string? _searchTerm;
    private Client? _selectedClient;
    private int? _selectedClientId => _selectedClient?.Id;
    private string _selectedNextRunStatus = "";
    private string _selectedHistoricalStatus = "";
    private string _selectedOverrideFilter = "";
    private string _selectedJobStatus = "";
    private string _selectedBlacklistStatus = "";
    private string? _selectedPrimaryVendorCode;
    private string? _selectedMasterVendorCode;
    private string? _filterNextRunStatus;
    private string? _filterHistoricalStatus;
    private bool? _filterIsOverridden;
    private string? _filterJobStatus;
    private string? _filterBlacklistStatus;
    private string? _filterPrimaryVendorCode;
    private string? _filterMasterVendorCode;
    private TestModeStatus? _testModeStatus;

    [Parameter]
    [SupplyParameterFromQuery(Name = "accountNumber")]
    public string? AccountNumberParam { get; set; }

    [Parameter]
    [SupplyParameterFromQuery(Name = "nextRunStatus")]
    public string? NextRunStatusParam { get; set; }

    [Parameter]
    [SupplyParameterFromQuery(Name = "blacklistStatus")]
    public string? BlacklistStatusParam { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Load test mode status for banner display
            _testModeStatus = await AdrService.GetTestModeStatusAsync();
            
            // Apply query parameters if provided (e.g., from "View Account" action on Jobs page or Dashboard chart click)
            if (!string.IsNullOrEmpty(AccountNumberParam))
            {
                _searchTerm = AccountNumberParam;
            }
            
            if (!string.IsNullOrEmpty(NextRunStatusParam))
            {
                _selectedNextRunStatus = NextRunStatusParam;
                _filterNextRunStatus = NextRunStatusParam;
            }
            
            if (!string.IsNullOrEmpty(BlacklistStatusParam))
            {
                _selectedBlacklistStatus = BlacklistStatusParam;
                _filterBlacklistStatus = BlacklistStatusParam;
            }
            
            _clients = await ClientService.GetClientsAsync();
            
                        // Check if user has permission to update ADR accounts (for editing billing data)
                        _canEditBilling = await PermissionService.CanUpdateAsync("adr");
                        // Check if user has permission to execute manual ADR requests (Editors, Admins, Super Admins)
                        _canExecuteManualScrape = await PermissionService.CanUpdateAsync("adr");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading clients: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task<TableData<AdrAccount>> ServerReload(TableState state, CancellationToken cancellationToken)
    {
        _loading = true;
        try
        {
            var pageNumber = state.Page + 1;
            var pageSize = state.PageSize;

            // Determine sort direction (default to ascending for NextRunDateTime)
            var sortDescending = state.SortDirection == SortDirection.Descending;
            var sortColumn = string.IsNullOrEmpty(state.SortLabel) ? "NextRunDateTime" : state.SortLabel;

            var result = await AdrService.GetAccountsPagedAsync(
                pageNumber,
                pageSize,
                _selectedClientId,
                _searchTerm,
                _filterNextRunStatus,
                _filterHistoricalStatus,
                _filterIsOverridden,
                _filterJobStatus,
                _filterBlacklistStatus,
                _filterPrimaryVendorCode,
                _filterMasterVendorCode,
                sortColumn,
                sortDescending);

            return new TableData<AdrAccount>
            {
                Items = result.Items,
                TotalItems = result.TotalCount
            };
        }
        catch (SessionExpiredException)
        {
            Snackbar.Add("Your session has expired. Redirecting to login...", Severity.Warning);
            Navigation.NavigateTo("/Account/Login", forceLoad: true);
            return new TableData<AdrAccount> { Items = new List<AdrAccount>(), TotalItems = 0 };
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading accounts: {ex.Message}", Severity.Error);
            return new TableData<AdrAccount> { Items = new List<AdrAccount>(), TotalItems = 0 };
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task<IEnumerable<Client>> SearchClients(string value, CancellationToken cancellationToken)
    {
        if (string.IsNullOrEmpty(value))
            return _clients;

        return _clients.Where(c => c.ClientName.Contains(value, StringComparison.OrdinalIgnoreCase));
    }

    private async Task OnSearchKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await ApplyFilters();
        }
    }

    private async Task ApplyFilters()
    {
        _filterNextRunStatus = string.IsNullOrEmpty(_selectedNextRunStatus) ? null : _selectedNextRunStatus;
        _filterHistoricalStatus = string.IsNullOrEmpty(_selectedHistoricalStatus) ? null : _selectedHistoricalStatus;
        _filterIsOverridden = string.IsNullOrEmpty(_selectedOverrideFilter) ? null : bool.Parse(_selectedOverrideFilter);
        _filterJobStatus = string.IsNullOrEmpty(_selectedJobStatus) ? null : _selectedJobStatus;
        _filterBlacklistStatus = string.IsNullOrEmpty(_selectedBlacklistStatus) ? null : _selectedBlacklistStatus;
        _filterPrimaryVendorCode = string.IsNullOrEmpty(_selectedPrimaryVendorCode) ? null : _selectedPrimaryVendorCode;
        _filterMasterVendorCode = string.IsNullOrEmpty(_selectedMasterVendorCode) ? null : _selectedMasterVendorCode;
        await _table.ReloadServerData();
    }

    private async Task ClearFilters()
    {
        _searchTerm = null;
        _selectedClient = null;
        _selectedNextRunStatus = "";
        _selectedHistoricalStatus = "";
        _selectedOverrideFilter = "";
        _selectedJobStatus = "";
        _selectedBlacklistStatus = "";
        _selectedPrimaryVendorCode = null;
        _selectedMasterVendorCode = null;
        _filterNextRunStatus = null;
        _filterHistoricalStatus = null;
        _filterIsOverridden = null;
        _filterJobStatus = null;
        _filterBlacklistStatus = null;
        _filterPrimaryVendorCode = null;
        _filterMasterVendorCode = null;
        await _table.ReloadServerData();
    }

    private async Task<IEnumerable<string>> SearchPrimaryVendors(string value, CancellationToken cancellationToken)
    {
        if (string.IsNullOrEmpty(value))
            return new List<string>();

        try
        {
            return await AdrService.GetPrimaryVendorCodesAsync(value, 50);
        }
        catch
        {
            return new List<string>();
        }
    }

    private async Task<IEnumerable<string>> SearchMasterVendors(string value, CancellationToken cancellationToken)
    {
        if (string.IsNullOrEmpty(value))
            return new List<string>();

        try
        {
            return await AdrService.GetMasterVendorCodesAsync(value, 50);
        }
        catch
        {
            return new List<string>();
        }
    }

    private Color GetNextRunStatusColor(string status) => status switch
    {
        "Run Now" => Color.Error,
        "Due Soon" => Color.Warning,
        "Upcoming" => Color.Info,
        "Future" => Color.Default,
        _ => Color.Default
    };

    private Color GetJobStatusColor(string status) => status switch
    {
        "Pending" => Color.Default,
        "CredentialCheckInProgress" => Color.Info,
        "CredentialVerified" => Color.Info,
        "CredentialFailed" => Color.Warning,
        "ScrapeInProgress" => Color.Info,
        "ScrapeRequested" => Color.Primary,
        "StatusCheckInProgress" => Color.Info,
        "Completed" => Color.Success,
        "Failed" => Color.Error,
        "NeedsReview" => Color.Warning,
        _ => Color.Default
    };

    private string GetJobStatusDisplayName(string status) => status switch
    {
        "ScrapeRequested" => "Request Sent",
        "CredentialVerified" => "Credential Verified",
        "CredentialFailed" => "Credential Failed",
        "NeedsReview" => "Needs Review",
        _ => status
    };

    private Color GetHistoricalStatusColor(string status) => status switch
    {
        "Missing" => Color.Error,
        "Overdue" => Color.Warning,
        "Due Now" => Color.Info,
        _ => Color.Default
    };

    private string GetBlacklistTooltip(AdrAccount account, bool isCurrent)
    {
        if (isCurrent)
        {
            var count = account.CurrentBlacklistCount;
            var baseText = count == 1 
                ? "Currently blacklisted - ADR requests will not be created automatically" 
                : $"{count} active blacklist entries - ADR requests will not be created automatically";
            
            if (account.CurrentBlacklists?.Any() == true)
            {
                var dateRanges = account.CurrentBlacklists
                    .Select(b => $"{b.EffectiveStartDate?.ToString("MM/dd/yyyy") ?? "N/A"} - {b.EffectiveEndDate?.ToString("MM/dd/yyyy") ?? "N/A"}: {b.Reason}")
                    .Take(3);
                baseText += "\n" + string.Join("\n", dateRanges);
                if (account.CurrentBlacklists.Count > 3)
                    baseText += $"\n...and {account.CurrentBlacklists.Count - 3} more";
            }
            return baseText;
        }
        else
        {
            var count = account.FutureBlacklistCount;
            var baseText = count == 1 
                ? "Future blacklist scheduled" 
                : $"{count} future blacklist entries scheduled";
            
            if (account.FutureBlacklists?.Any() == true)
            {
                var dateRanges = account.FutureBlacklists
                    .Select(b => $"Starts {b.EffectiveStartDate?.ToString("MM/dd/yyyy") ?? "N/A"}: {b.Reason}")
                    .Take(3);
                baseText += "\n" + string.Join("\n", dateRanges);
                if (account.FutureBlacklists.Count > 3)
                    baseText += $"\n...and {account.FutureBlacklists.Count - 3} more";
            }
            return baseText;
        }
    }

    private async Task ViewAccountDetails(AdrAccount account)
    {
        var parameters = new DialogParameters<AccountDetailsDialog>
        {
            { x => x.Account, account }
        };
        var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true };
        await DialogService.ShowAsync<AccountDetailsDialog>("Account Details", parameters, options);
    }

    private void ViewJobs(AdrAccount account)
    {
        // Navigate to Jobs page with account number filter and disable "Latest per Account" to show all jobs
        var url = $"/adr/jobs?accountNumber={Uri.EscapeDataString(account.VMAccountNumber ?? "")}";
        if (!string.IsNullOrWhiteSpace(account.PrimaryVendorCode))
        {
            url += $"&primaryVendorCode={Uri.EscapeDataString(account.PrimaryVendorCode)}";
        }
        url += "&latestPerAccount=false";
        Navigation.NavigateTo(url);
    }

    private async Task ExportAccounts(string format)
    {
        _isExporting = true;
        StateHasChanged();
        try
        {
            // Build filters dictionary from current filter state
            var filters = new Dictionary<string, string?>();
            if (_selectedClientId.HasValue)
                filters["clientId"] = _selectedClientId.Value.ToString();
            if (!string.IsNullOrWhiteSpace(_searchTerm))
                filters["searchTerm"] = _searchTerm;
            if (!string.IsNullOrWhiteSpace(_filterNextRunStatus))
                filters["nextRunStatus"] = _filterNextRunStatus;
            if (!string.IsNullOrWhiteSpace(_filterHistoricalStatus))
                filters["historicalBillingStatus"] = _filterHistoricalStatus;
            if (!string.IsNullOrWhiteSpace(_selectedPrimaryVendorCode))
                filters["primaryVendorCode"] = _selectedPrimaryVendorCode;
            if (!string.IsNullOrWhiteSpace(_selectedMasterVendorCode))
                filters["masterVendorCode"] = _selectedMasterVendorCode;
            if (!string.IsNullOrWhiteSpace(_selectedJobStatus))
                filters["jobStatus"] = _selectedJobStatus;
            if (!string.IsNullOrWhiteSpace(_selectedBlacklistStatus))
                filters["blacklistStatus"] = _selectedBlacklistStatus;

            // Start background export
            Snackbar.Add("Starting export... This may take a few minutes for large datasets.", Severity.Info);
            var startResult = await AdrService.StartBackgroundExportAsync("accounts", format, filters);
            
            if (string.IsNullOrEmpty(startResult.RequestId))
            {
                Snackbar.Add("Failed to start export", Severity.Error);
                return;
            }

            // Poll for completion
            var maxAttempts = 120; // 10 minutes max (5 second intervals)
            var attempt = 0;
            while (attempt < maxAttempts)
            {
                await Task.Delay(5000); // Wait 5 seconds between polls
                attempt++;

                var status = await AdrService.GetBackgroundExportStatusAsync(startResult.RequestId);
                if (status == null)
                {
                    Snackbar.Add("Export status not found", Severity.Error);
                    return;
                }

                if (status.Status == "Completed")
                {
                    // Download the file
                    var bytes = await AdrService.DownloadBackgroundExportAsync(startResult.RequestId);
                    if (bytes == null || bytes.Length == 0)
                    {
                        Snackbar.Add("Failed to download export file", Severity.Error);
                        return;
                    }

                    var contentType = status.ContentType ?? (format.Equals("excel", StringComparison.OrdinalIgnoreCase)
                        ? "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                        : "text/csv");

                    var filename = status.FileName ?? $"adr_accounts_{DateTime.UtcNow:yyyyMMddHHmmss}.{(format.Equals("excel", StringComparison.OrdinalIgnoreCase) ? "xlsx" : "csv")}";

                    var base64 = Convert.ToBase64String(bytes);
                    await JSRuntime.InvokeVoidAsync("downloadFile", filename, contentType, base64);

                    Snackbar.Add($"Export downloaded: {filename} ({status.TotalRecords:N0} records)", Severity.Success);
                    return;
                }
                else if (status.Status == "Failed")
                {
                    Snackbar.Add($"Export failed: {status.ErrorMessage}", Severity.Error);
                    return;
                }
                else if (status.Status == "Processing" && attempt % 6 == 0) // Update every 30 seconds
                {
                    Snackbar.Add($"Export in progress... {status.ProcessedRecords:N0} of {status.TotalRecords:N0} records processed", Severity.Info);
                    StateHasChanged();
                }
            }

            Snackbar.Add("Export timed out. Please try again later.", Severity.Warning);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Export failed: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isExporting = false;
            StateHasChanged();
        }
    }

    private async Task EditBilling(AdrAccount account)
    {
        // Get the rules for this account
        var rules = await AdrService.GetRulesByAccountAsync(account.Id);
        if (rules.Count == 0)
        {
            Snackbar.Add("No rules found for this account", Severity.Warning);
            return;
        }
        
        // Use the first (primary) rule - typically there's one rule per account
        var rule = rules.First();
        
        var parameters = new DialogParameters<EditRuleDialog>
        {
            { x => x.RuleId, rule.Id }
        };
        var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true, CloseOnEscapeKey = true };
        var dialog = await DialogService.ShowAsync<EditRuleDialog>("Edit Account Rules", parameters, options);
        var result = await dialog.Result;
        
        if (result != null && !result.Canceled)
        {
            await _table.ReloadServerData();
        }
    }

    private async Task ClearOverride(AdrAccount account)
    {
        // Get the rules for this account to clear rule override
        var rules = await AdrService.GetRulesByAccountAsync(account.Id);
        if (rules.Count == 0)
        {
            Snackbar.Add("No rules found for this account", Severity.Warning);
            return;
        }
        
        var rule = rules.First();
        
        var confirmed = await DialogService.ShowMessageBox(
            "Clear Override",
            $"Are you sure you want to clear the manual override for account {account.VMAccountNumber}? The next sync will update rule data from the external source.",
            yesText: "Clear Override",
            cancelText: "Cancel");
        
        if (confirmed == true)
        {
            try
            {
                await AdrService.ClearRuleOverrideAsync(rule.Id);
                await _table.ReloadServerData();
                Snackbar.Add("Override cleared successfully", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error clearing override: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task OpenManualScrapeDialog(AdrAccount account)
    {
        var parameters = new DialogParameters<ManualScrapeDialog>
        {
            { x => x.Account, account }
        };
        var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<ManualScrapeDialog>("Manual ADR Request", parameters, options);
        var result = await dialog.Result;
        
        if (result != null && !result.Canceled)
        {
            Snackbar.Add("Manual ADR request submitted successfully", Severity.Success);
        }
    }

    private bool CanCheckStatus(string? jobStatus)
    {
        if (string.IsNullOrEmpty(jobStatus)) return false;
        
        // Allow status check for jobs that are in progress or waiting for status
        return jobStatus is "ScrapeRequested" or "CredentialCheckRequested" or "CredentialCheckInProgress" 
            or "ScrapeInProgress" or "StatusCheckInProgress";
    }

    private async Task CheckAccountJobStatus(AdrAccount account)
    {
        try
        {
            // First, get the latest job for this account
            var jobs = await AdrService.GetJobsByAccountAsync(account.Id);
            var latestJob = jobs.OrderByDescending(j => j.CreatedDateTime).FirstOrDefault();
            
            if (latestJob == null)
            {
                Snackbar.Add("No job found for this account", Severity.Warning);
                return;
            }

            Snackbar.Add($"Checking status for job {latestJob.Id}...", Severity.Info);
            
            var result = await AdrService.CheckJobStatusAsync(latestJob.Id);
            
            if (result.IsSuccess)
            {
                var statusMessage = $"Status: {result.StatusDescription ?? "Unknown"}";
                if (result.IsFinal)
                {
                    statusMessage += " (Final)";
                }
                Snackbar.Add(statusMessage, result.IsFinal && result.StatusId == 11 ? Severity.Success : Severity.Info);
            }
            else
            {
                Snackbar.Add($"Status check failed: {result.ErrorMessage}", Severity.Error);
            }
            
            // Refresh the table to show updated status
            await _table.ReloadServerData();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error checking status: {ex.Message}", Severity.Error);
        }
    }
}
