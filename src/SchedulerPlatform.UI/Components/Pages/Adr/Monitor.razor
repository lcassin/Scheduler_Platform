@page "/adr/monitor"
@rendermode InteractiveServer
@attribute [Authorize]
@inject IAdrService AdrService
@inject IUserTimeZoneService TimeZoneService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@implements IDisposable

<PageTitle>ADR Job Monitor</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">ADR Job Monitor</MudText>

<MudGrid Style="align-items: stretch;">
    <MudItem xs="12" md="8" Class="d-flex">
        <MudPaper Class="pa-4 mb-4 flex-grow-1">
            <div class="d-flex justify-space-between align-center mb-4">
                <MudText Typo="Typo.h6">Current Orchestration Status</MudText>
                <div class="d-flex gap-2">
                    <MudButton Variant="Variant.Outlined" 
                               Color="Color.Primary" 
                               StartIcon="@Icons.Material.Filled.Refresh"
                               OnClick="RefreshStatus"
                               Disabled="_isRefreshing">
                        @if (_isRefreshing)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <text>Refreshing...</text>
                        }
                        else
                        {
                            <text>Refresh</text>
                        }
                    </MudButton>
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Success" 
                               StartIcon="@Icons.Material.Filled.PlayArrow"
                               OnClick="StartOrchestration"
                               Disabled="_isStarting || (_currentStatus?.IsRunning ?? false)">
                        @if (_isStarting)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <text>Starting...</text>
                        }
                        else
                        {
                            <text>Start Orchestration</text>
                        }
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" 
                               Color="Color.Info" 
                               StartIcon="@Icons.Material.Filled.CheckCircle"
                               OnClick="CheckStatusesOnly"
                               Disabled="_isCheckingStatuses || (_currentStatus?.IsRunning ?? false)">
                        @if (_isCheckingStatuses)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <text>Checking...</text>
                        }
                        else
                        {
                            <text>Check Statuses Only</text>
                        }
                    </MudButton>
                    @if (_currentStatus?.IsRunning == true && _currentStatus?.Status != null && 
                         (_currentStatus.Status.Status == "Running" || _currentStatus.Status.Status == "Queued" || _currentStatus.Status.Status == "Cancelling"))
                    {
                        <MudButton Variant="Variant.Outlined" 
                                   Color="Color.Error" 
                                   StartIcon="@Icons.Material.Filled.Cancel"
                                   OnClick="CancelOrchestration"
                                   Disabled="@(_isCancelling || _currentStatus.Status.Status == "Cancelling")">
                            @if (_isCancelling || _currentStatus.Status.Status == "Cancelling")
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                <text>Cancelling...</text>
                            }
                            else
                            {
                                <text>Cancel</text>
                            }
                        </MudButton>
                    }
                </div>
            </div>

            @* Manual Status Check Progress Panel *@
            @if (_isCheckingStatuses || _statusCheckResult != null)
            {
                <MudCard Outlined="true" Class="mb-4">
                    <MudCardContent>
                        <div class="d-flex align-center justify-space-between mb-3">
                            <MudText Typo="Typo.subtitle1">
                                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Class="mr-2" />
                                Manual Status Check
                            </MudText>
                            @if (!_isCheckingStatuses && _statusCheckResult != null)
                            {
                                <MudIconButton Icon="@Icons.Material.Filled.Close" 
                                               Size="Size.Small" 
                                               OnClick="ClearStatusCheckResult" />
                            }
                        </div>
                        
                        @if (_isCheckingStatuses)
                        {
                            <MudProgressLinear Color="Color.Info" Indeterminate="true" Class="mb-3" />
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                Checking status for all ADR requests... This may take several minutes for large datasets.
                            </MudText>
                        }
                        else if (_statusCheckResult != null)
                        {
                            <MudGrid>
                                <MudItem xs="6" sm="3">
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Jobs Checked</MudText>
                                    <MudText Typo="Typo.h6">@_statusCheckResult.JobsChecked.ToString("N0")</MudText>
                                </MudItem>
                                <MudItem xs="6" sm="3">
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Completed</MudText>
                                    <MudText Typo="Typo.h6" Color="Color.Success">@_statusCheckResult.JobsCompleted.ToString("N0")</MudText>
                                </MudItem>
                                <MudItem xs="6" sm="3">
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Need Review</MudText>
                                    <MudText Typo="Typo.h6" Color="Color.Warning">@_statusCheckResult.JobsNeedingReview.ToString("N0")</MudText>
                                </MudItem>
                                <MudItem xs="6" sm="3">
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Still Processing</MudText>
                                    <MudText Typo="Typo.h6" Color="Color.Info">@_statusCheckResult.JobsStillProcessing.ToString("N0")</MudText>
                                </MudItem>
                            </MudGrid>
                            @if (_statusCheckResult.Errors > 0)
                            {
                                <MudAlert Severity="Severity.Warning" Class="mt-3" Dense="true">
                                    @_statusCheckResult.Errors errors occurred during status check. Check logs for details.
                                </MudAlert>
                            }
                        }
                    </MudCardContent>
                </MudCard>
            }

            @if (_loading)
            {
                <div class="d-flex justify-center pa-8">
                    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                </div>
            }
            else if (_currentStatus == null)
            {
                <MudAlert Severity="Severity.Error">Unable to load orchestration status</MudAlert>
            }
            else if (!_currentStatus.IsRunning)
            {
                <MudAlert Severity="Severity.Info" Icon="@Icons.Material.Filled.Info" Class="mb-4">
                    No orchestration is currently running. Click "Start Orchestration" to begin a new run.
                </MudAlert>
                
                <MudGrid>
                    <MudItem xs="12" md="7">
                        @if (_lastCompletedRun != null)
                        {
                            <MudCard Outlined="true">
                                <MudCardContent>
                                    <MudText Typo="Typo.subtitle1" Class="mb-3">Last Completed Run</MudText>
                                    <MudGrid>
                                        <MudItem xs="12" md="6">
                                            <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Request ID</MudText>
                                            <MudText Typo="Typo.body1" Class="mb-3">@_lastCompletedRun.RequestId</MudText>
                                            
                                            <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Requested By</MudText>
                                            <MudText Typo="Typo.body1" Class="mb-3">@_lastCompletedRun.RequestedBy</MudText>
                                        </MudItem>
                                        <MudItem xs="12" md="6">
                                            <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Status</MudText>
                                            <MudChip T="string" Size="Size.Medium" Color="@GetStatusColor(_lastCompletedRun.Status)" Class="mb-3">
                                                @_lastCompletedRun.Status
                                            </MudChip>
                                            
                                            <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Completed At</MudText>
                                            <MudText Typo="Typo.body1" Class="mb-3">@FormatDateTime(_lastCompletedRun.CompletedAt, "MM/dd/yyyy hh:mm:ss tt")</MudText>
                                            
                                            @if (_lastCompletedRun.StartedAt.HasValue && _lastCompletedRun.CompletedAt.HasValue)
                                            {
                                                var duration = _lastCompletedRun.CompletedAt.Value - _lastCompletedRun.StartedAt.Value;
                                                <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Duration</MudText>
                                                <MudText Typo="Typo.body1">@duration.ToString(@"hh\:mm\:ss")</MudText>
                                            }
                                        </MudItem>
                                    </MudGrid>
                                    
                                    <MudDivider Class="my-4" />
                                    <MudText Typo="Typo.subtitle1" Class="mb-2">Step Results</MudText>
                                    <MudTimeline TimelinePosition="TimelinePosition.Start">
                                        <MudTimelineItem Color="@GetLastRunStepColor("Syncing accounts")" Icon="@Icons.Material.Filled.CheckCircle">
                                            <ItemContent>
                                                <MudText Typo="Typo.body2">
                                                    Sync Accounts
                                                    @if (_lastCompletedRun.SyncResult?.Duration.TotalSeconds > 0)
                                                    {
                                                        <MudChip T="string" Size="Size.Small" Color="Color.Default" Class="ml-2">@FormatDuration(_lastCompletedRun.SyncResult.Duration)</MudChip>
                                                    }
                                                </MudText>
                                                @if (_lastCompletedRun.SyncResult != null)
                                                {
                                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                        @_lastCompletedRun.SyncResult.AccountsInserted inserted, @_lastCompletedRun.SyncResult.AccountsUpdated updated
                                                    </MudText>
                                                }
                                                else
                                                {
                                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Completed</MudText>
                                                }
                                            </ItemContent>
                                        </MudTimelineItem>
                                        <MudTimelineItem Color="@GetLastRunStepColor("Creating jobs")" Icon="@Icons.Material.Filled.CheckCircle">
                                            <ItemContent>
                                                <MudText Typo="Typo.body2">
                                                    Create Jobs
                                                    @if (_lastCompletedRun.JobCreationResult?.Duration.TotalSeconds > 0)
                                                    {
                                                        <MudChip T="string" Size="Size.Small" Color="Color.Default" Class="ml-2">@FormatDuration(_lastCompletedRun.JobCreationResult.Duration)</MudChip>
                                                    }
                                                </MudText>
                                                @if (_lastCompletedRun.JobCreationResult != null)
                                                {
                                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                        @_lastCompletedRun.JobCreationResult.JobsCreated created, @_lastCompletedRun.JobCreationResult.JobsSkipped skipped
                                                    </MudText>
                                                }
                                                else
                                                {
                                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Completed</MudText>
                                                }
                                            </ItemContent>
                                        </MudTimelineItem>
                                        <MudTimelineItem Color="@GetLastRunStepColor("Verifying credentials")" Icon="@Icons.Material.Filled.CheckCircle">
                                            <ItemContent>
                                                <MudText Typo="Typo.body2">
                                                    Verify Credentials
                                                    @if (_lastCompletedRun.CredentialVerificationResult?.Duration.TotalSeconds > 0)
                                                    {
                                                        <MudChip T="string" Size="Size.Small" Color="Color.Default" Class="ml-2">@FormatDuration(_lastCompletedRun.CredentialVerificationResult.Duration)</MudChip>
                                                    }
                                                </MudText>
                                                @if (_lastCompletedRun.CredentialVerificationResult != null)
                                                {
                                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                        @_lastCompletedRun.CredentialVerificationResult.CredentialsVerified verified, @_lastCompletedRun.CredentialVerificationResult.CredentialsFailed failed
                                                    </MudText>
                                                }
                                                else
                                                {
                                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Completed</MudText>
                                                }
                                            </ItemContent>
                                        </MudTimelineItem>
                                        <MudTimelineItem Color="@GetLastRunStepColor("Checking statuses")" Icon="@Icons.Material.Filled.CheckCircle">
                                            <ItemContent>
                                                <MudText Typo="Typo.body2">
                                                    Check Statuses
                                                    @if (_lastCompletedRun.StatusCheckResult?.Duration.TotalSeconds > 0)
                                                    {
                                                        <MudChip T="string" Size="Size.Small" Color="Color.Default" Class="ml-2">@FormatDuration(_lastCompletedRun.StatusCheckResult.Duration)</MudChip>
                                                    }
                                                </MudText>
                                                @if (_lastCompletedRun.StatusCheckResult != null)
                                                {
                                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                        @_lastCompletedRun.StatusCheckResult.JobsCompleted completed, @_lastCompletedRun.StatusCheckResult.JobsNeedingReview need review
                                                    </MudText>
                                                }
                                                else
                                                {
                                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Completed</MudText>
                                                }
                                            </ItemContent>
                                        </MudTimelineItem>
                                        <MudTimelineItem Color="@GetLastRunStepColor("Processing scraping")" Icon="@Icons.Material.Filled.CheckCircle">
                                            <ItemContent>
                                                <MudText Typo="Typo.body2">
                                                    Send ADR Requests
                                                    @if (_lastCompletedRun.ScrapeResult?.Duration.TotalSeconds > 0)
                                                    {
                                                        <MudChip T="string" Size="Size.Small" Color="Color.Default" Class="ml-2">@FormatDuration(_lastCompletedRun.ScrapeResult.Duration)</MudChip>
                                                    }
                                                </MudText>
                                                @if (_lastCompletedRun.ScrapeResult != null)
                                                {
                                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                        @_lastCompletedRun.ScrapeResult.ScrapesRequested ADR requests sent, @_lastCompletedRun.ScrapeResult.ScrapesCompleted completed
                                                    </MudText>
                                                }
                                                else
                                                {
                                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Completed</MudText>
                                                }
                                            </ItemContent>
                                        </MudTimelineItem>
                                    </MudTimeline>
                                </MudCardContent>
                            </MudCard>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Color="Color.Secondary">No completed runs yet</MudText>
                        }
                    </MudItem>
                    <MudItem xs="12" md="5">
                        <MudCard Outlined="true" Style="height: 100%;">
                            <MudCardContent>
                                <MudText Typo="Typo.subtitle1" Class="mb-3">Recent Run Results</MudText>
                                @if (_recentHistory != null && _recentHistory.Any())
                                {
                                    <PlotlyDonutChart Values="@_orchestrationChartData"
                                                      Labels="@_orchestrationChartLabels"
                                                      Colors="@_orchestrationChartColors"
                                                      Height="340px"
                                                      ShowLegend="false" />
                                    <MudGrid Class="mt-3" Spacing="1">
                                        @foreach (var status in _orchestrationStatusCounts)
                                        {
                                            <MudItem xs="6">
                                                <MudText Typo="Typo.body2">
                                                    <MudIcon Icon="@Icons.Material.Filled.Circle" Size="Size.Small" Color="@GetStatusColor(status.Key)" Class="mr-1" />
                                                    @status.Key: @status.Value
                                                </MudText>
                                            </MudItem>
                                        }
                                    </MudGrid>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">Last 10 orchestration runs</MudText>
                                }
                                else
                                {
                                    <MudText Typo="Typo.body2" Color="Color.Secondary" Align="Align.Center" Class="pa-4">
                                        No recent runs to display
                                    </MudText>
                                }
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                </MudGrid>
            }
            else if (_currentStatus.Status != null)
            {
                <MudCard Outlined="true">
                    <MudCardContent>
                        <MudGrid>
                            <MudItem xs="12" md="6">
                                <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Request ID</MudText>
                                <MudText Typo="Typo.body1" Class="mb-3">@_currentStatus.Status.RequestId</MudText>
                                
                                <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Requested By</MudText>
                                <MudText Typo="Typo.body1" Class="mb-3">@_currentStatus.Status.RequestedBy</MudText>
                                
                                <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Started At</MudText>
                                <MudText Typo="Typo.body1">@(_currentStatus.Status.StartedAt.HasValue ? FormatDateTime(_currentStatus.Status.StartedAt, "MM/dd/yyyy hh:mm:ss tt") : "Not started")</MudText>
                            </MudItem>
                            <MudItem xs="12" md="6">
                                <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Status</MudText>
                                <MudChip T="string" Size="Size.Medium" Color="@GetStatusColor(_currentStatus.Status.Status)" Class="mb-3">
                                    @_currentStatus.Status.Status
                                </MudChip>
                                
                                <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Current Step</MudText>
                                <MudText Typo="Typo.body1" Class="mb-3">
                                    @(_currentStatus.Status.CurrentStep ?? "N/A")
                                    @if (!string.IsNullOrEmpty(_currentStatus.Status.CurrentStepPhase))
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="@(_currentStatus.Status.CurrentStepPhase == "Preparing" ? Color.Warning : Color.Info)" Class="ml-2">
                                            @_currentStatus.Status.CurrentStepPhase
                                        </MudChip>
                                    }
                                </MudText>
                                
                                @if (!string.IsNullOrEmpty(_currentStatus.Status.ErrorMessage))
                                {
                                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Error</MudText>
                                    <MudText Typo="Typo.body1" Color="Color.Error">@_currentStatus.Status.ErrorMessage</MudText>
                                }
                            </MudItem>
                        </MudGrid>

                        @if (_currentStatus.Status.Status == "Running" || _currentStatus.Status.Status == "Cancelling")
                        {
                            <MudDivider Class="my-4" />
                            <MudText Typo="Typo.subtitle1" Class="mb-2">Step Progress @(_currentStatus.Status.Status == "Cancelling" ? "(Cancelling...)" : "")</MudText>
                            <MudTimeline TimelinePosition="TimelinePosition.Start">
                                <MudTimelineItem Color="@GetStepColor("Syncing accounts", _currentStatus.Status)" Icon="@GetStepIcon("Syncing accounts", _currentStatus.Status)">
                                    <ItemContent>
                                        <MudText Typo="Typo.body2">Sync Accounts</MudText>
                                        @if (_currentStatus.Status.CurrentStep == "Syncing accounts")
                                        {
                                            @if (!string.IsNullOrEmpty(_currentStatus.Status.CurrentSubStep))
                                            {
                                                @* Sub-step progress (e.g., rule sync) *@
                                                <MudText Typo="Typo.caption" Color="Color.Warning">
                                                    @_currentStatus.Status.CurrentSubStep: @(_currentStatus.Status.SubStepProgress?.ToString("N0") ?? "0") / @(_currentStatus.Status.SubStepTotal?.ToString("N0") ?? "0")
                                                    @if (_currentStatus.Status.SubStepTotal > 0)
                                                    {
                                                        <text> (@((_currentStatus.Status.SubStepProgress.GetValueOrDefault() * 100.0 / _currentStatus.Status.SubStepTotal.GetValueOrDefault()).ToString("F1"))%)</text>
                                                    }
                                                </MudText>
                                                <MudProgressLinear Color="Color.Warning" 
                                                                   Value="@(_currentStatus.Status.SubStepTotal > 0 ? _currentStatus.Status.SubStepProgress.GetValueOrDefault() * 100.0 / _currentStatus.Status.SubStepTotal.GetValueOrDefault() : 0)" 
                                                                   Class="mt-1" />
                                            }
                                            else if (_currentStatus.Status.CurrentStepTotal > 0)
                                            {
                                                @* Main account sync progress *@
                                                <MudText Typo="Typo.caption" Color="Color.Info">
                                                    Syncing accounts: @_currentStatus.Status.CurrentStepProgress.ToString("N0") / @_currentStatus.Status.CurrentStepTotal.ToString("N0") (@((_currentStatus.Status.CurrentStepProgress * 100.0 / _currentStatus.Status.CurrentStepTotal).ToString("F1"))%)
                                                </MudText>
                                                <MudProgressLinear Color="Color.Info" Value="@(_currentStatus.Status.CurrentStepProgress * 100.0 / _currentStatus.Status.CurrentStepTotal)" Class="mt-1" />
                                            }
                                            else
                                            {
                                                <MudText Typo="Typo.caption" Color="Color.Info">Starting...</MudText>
                                                <MudProgressLinear Color="Color.Info" Indeterminate="true" Class="mt-1" />
                                            }
                                        }
                                        else if (_currentStatus.Status.SyncResult != null)
                                        {
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                @_currentStatus.Status.SyncResult.AccountsInserted inserted, @_currentStatus.Status.SyncResult.AccountsUpdated updated
                                                @if (_currentStatus.Status.SyncResult.Duration.TotalSeconds > 0)
                                                {
                                                    <MudChip T="string" Size="Size.Small" Color="Color.Default" Class="ml-2">@FormatDuration(_currentStatus.Status.SyncResult.Duration)</MudChip>
                                                }
                                            </MudText>
                                        }
                                    </ItemContent>
                                </MudTimelineItem>
                                <MudTimelineItem Color="@GetStepColor("Creating jobs", _currentStatus.Status)" Icon="@GetStepIcon("Creating jobs", _currentStatus.Status)">
                                    <ItemContent>
                                        <MudText Typo="Typo.body2">Create Jobs</MudText>
                                        @if (_currentStatus.Status.JobCreationResult != null)
                                        {
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                @_currentStatus.Status.JobCreationResult.JobsCreated created, @_currentStatus.Status.JobCreationResult.JobsSkipped skipped
                                                @if (_currentStatus.Status.JobCreationResult.Duration.TotalSeconds > 0)
                                                {
                                                    <MudChip T="string" Size="Size.Small" Color="Color.Default" Class="ml-2">@FormatDuration(_currentStatus.Status.JobCreationResult.Duration)</MudChip>
                                                }
                                            </MudText>
                                        }
                                    </ItemContent>
                                </MudTimelineItem>
                                    <MudTimelineItem Color="@GetStepColor("Verifying credentials", _currentStatus.Status)" Icon="@GetStepIcon("Verifying credentials", _currentStatus.Status)">
                                        <ItemContent>
                                            <MudText Typo="Typo.body2">Verify Credentials</MudText>
                                            @if (_currentStatus.Status.CurrentStep == "Verifying credentials" && _currentStatus.Status.CurrentStepTotal > 0)
                                            {
                                                @if (_currentStatus.Status.CurrentStepPhase == "Preparing")
                                                {
                                                    <MudText Typo="Typo.caption" Color="Color.Warning">
                                                        Preparing: @_currentStatus.Status.CurrentStepProgress / @_currentStatus.Status.CurrentStepTotal (@((_currentStatus.Status.CurrentStepProgress * 100.0 / _currentStatus.Status.CurrentStepTotal).ToString("F1"))%)
                                                    </MudText>
                                                    <MudProgressLinear Color="Color.Warning" Value="@(_currentStatus.Status.CurrentStepProgress * 100.0 / _currentStatus.Status.CurrentStepTotal)" Class="mt-1" />
                                                }
                                                else
                                                {
                                                    <MudText Typo="Typo.caption" Color="Color.Info">
                                                        @(_currentStatus.Status.CurrentStepPhase ?? "Calling API"): @_currentStatus.Status.CurrentStepProgress / @_currentStatus.Status.CurrentStepTotal (@((_currentStatus.Status.CurrentStepProgress * 100.0 / _currentStatus.Status.CurrentStepTotal).ToString("F1"))%)
                                                    </MudText>
                                                    <MudProgressLinear Color="Color.Info" Value="@(_currentStatus.Status.CurrentStepProgress * 100.0 / _currentStatus.Status.CurrentStepTotal)" Class="mt-1" />
                                                }
                                            }
                                            else if (_currentStatus.Status.CredentialVerificationResult != null)
                                            {
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                    @_currentStatus.Status.CredentialVerificationResult.CredentialsVerified verified, @_currentStatus.Status.CredentialVerificationResult.CredentialsFailed failed
                                                    @if (_currentStatus.Status.CredentialVerificationResult.Duration.TotalSeconds > 0)
                                                    {
                                                        <MudChip T="string" Size="Size.Small" Color="Color.Default" Class="ml-2">@FormatDuration(_currentStatus.Status.CredentialVerificationResult.Duration)</MudChip>
                                                    }
                                                </MudText>
                                            }
                                        </ItemContent>
                                    </MudTimelineItem>
                                    <MudTimelineItem Color="@GetStepColor("Checking statuses", _currentStatus.Status)" Icon="@GetStepIcon("Checking statuses", _currentStatus.Status)">
                                        <ItemContent>
                                            <MudText Typo="Typo.body2">Check Statuses</MudText>
                                            @if ((_currentStatus.Status.CurrentStep == "Checking statuses" || _currentStatus.Status.CurrentStep == "Checking all scraped statuses") && _currentStatus.Status.CurrentStepTotal > 0)
                                            {
                                                @if (_currentStatus.Status.CurrentStepPhase == "Preparing")
                                                {
                                                    <MudText Typo="Typo.caption" Color="Color.Warning">
                                                        Preparing: @_currentStatus.Status.CurrentStepProgress / @_currentStatus.Status.CurrentStepTotal (@((_currentStatus.Status.CurrentStepProgress * 100.0 / _currentStatus.Status.CurrentStepTotal).ToString("F1"))%)
                                                    </MudText>
                                                    <MudProgressLinear Color="Color.Warning" Value="@(_currentStatus.Status.CurrentStepProgress * 100.0 / _currentStatus.Status.CurrentStepTotal)" Class="mt-1" />
                                                }
                                                else if (_currentStatus.Status.CurrentStepPhase == "Updating database")
                                                {
                                                    <MudText Typo="Typo.caption" Color="Color.Success">
                                                        Updating database: @_currentStatus.Status.CurrentStepProgress.ToString("N0") / @_currentStatus.Status.CurrentStepTotal.ToString("N0") (@((_currentStatus.Status.CurrentStepProgress * 100.0 / _currentStatus.Status.CurrentStepTotal).ToString("F1"))%)
                                                    </MudText>
                                                    <MudProgressLinear Color="Color.Success" Value="@(_currentStatus.Status.CurrentStepProgress * 100.0 / _currentStatus.Status.CurrentStepTotal)" Class="mt-1" />
                                                }
                                                else
                                                {
                                                    <MudText Typo="Typo.caption" Color="Color.Info">
                                                        @(_currentStatus.Status.CurrentStepPhase ?? "Calling API"): @_currentStatus.Status.CurrentStepProgress / @_currentStatus.Status.CurrentStepTotal (@((_currentStatus.Status.CurrentStepProgress * 100.0 / _currentStatus.Status.CurrentStepTotal).ToString("F1"))%)
                                                    </MudText>
                                                    <MudProgressLinear Color="Color.Info" Value="@(_currentStatus.Status.CurrentStepProgress * 100.0 / _currentStatus.Status.CurrentStepTotal)" Class="mt-1" />
                                                }
                                                <MudText Typo="Typo.caption" Color="Color.Tertiary" Class="mt-1">
                                                    <em>Checks all ADR requests in database</em>
                                                </MudText>
                                            }
                                            else if (_currentStatus.Status.StatusCheckResult != null)
                                            {
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                    @_currentStatus.Status.StatusCheckResult.JobsCompleted completed, @_currentStatus.Status.StatusCheckResult.JobsNeedingReview need review
                                                    @if (_currentStatus.Status.StatusCheckResult.Duration.TotalSeconds > 0)
                                                    {
                                                        <MudChip T="string" Size="Size.Small" Color="Color.Default" Class="ml-2">@FormatDuration(_currentStatus.Status.StatusCheckResult.Duration)</MudChip>
                                                    }
                                                </MudText>
                                            }
                                        </ItemContent>
                                    </MudTimelineItem>
                                    <MudTimelineItem Color="@GetStepColor("Processing scraping", _currentStatus.Status)" Icon="@GetStepIcon("Processing scraping", _currentStatus.Status)">
                                        <ItemContent>
                                            <MudText Typo="Typo.body2">Send ADR Requests</MudText>
                                            @if (_currentStatus.Status.CurrentStep == "Processing scraping" && _currentStatus.Status.CurrentStepTotal > 0)
                                            {
                                                @if (_currentStatus.Status.CurrentStepPhase == "Preparing")
                                                {
                                                    <MudText Typo="Typo.caption" Color="Color.Warning">
                                                        Preparing: @_currentStatus.Status.CurrentStepProgress / @_currentStatus.Status.CurrentStepTotal (@((_currentStatus.Status.CurrentStepProgress * 100.0 / _currentStatus.Status.CurrentStepTotal).ToString("F1"))%)
                                                    </MudText>
                                                    <MudProgressLinear Color="Color.Warning" Value="@(_currentStatus.Status.CurrentStepProgress * 100.0 / _currentStatus.Status.CurrentStepTotal)" Class="mt-1" />
                                                }
                                                else
                                                {
                                                    <MudText Typo="Typo.caption" Color="Color.Info">
                                                        @(_currentStatus.Status.CurrentStepPhase ?? "Calling API"): @_currentStatus.Status.CurrentStepProgress / @_currentStatus.Status.CurrentStepTotal (@((_currentStatus.Status.CurrentStepProgress * 100.0 / _currentStatus.Status.CurrentStepTotal).ToString("F1"))%)
                                                    </MudText>
                                                    <MudProgressLinear Color="Color.Info" Value="@(_currentStatus.Status.CurrentStepProgress * 100.0 / _currentStatus.Status.CurrentStepTotal)" Class="mt-1" />
                                                }
                                            }
                                            else if (_currentStatus.Status.ScrapeResult != null)
                                            {
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                    @_currentStatus.Status.ScrapeResult.ScrapesRequested ADR requests sent, @_currentStatus.Status.ScrapeResult.ScrapesCompleted completed
                                                    @if (_currentStatus.Status.ScrapeResult.Duration.TotalSeconds > 0)
                                                    {
                                                        <MudChip T="string" Size="Size.Small" Color="Color.Default" Class="ml-2">@FormatDuration(_currentStatus.Status.ScrapeResult.Duration)</MudChip>
                                                    }
                                                </MudText>
                                            }
                                        </ItemContent>
                                    </MudTimelineItem>
                            </MudTimeline>
                        }
                    </MudCardContent>
                </MudCard>
            }

            <div class="d-flex justify-space-between align-center mt-4">
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    @if (_autoRefreshEnabled)
                    {
                        @if (_isProgressPolling)
                        {
                            <text>Auto-refresh: On (progress every 5 sec, full refresh every 60 sec)</text>
                        }
                        else
                        {
                            <text>Auto-refresh: On (every 60 seconds)</text>
                        }
                    }
                    else
                    {
                        <text>Auto-refresh: Off</text>
                    }
                </MudText>
                <MudSwitch @bind-Value="_autoRefreshEnabled" 
                           Color="Color.Primary" 
                           Label="Auto-refresh" 
                           T="bool" />
            </div>
            @if (_lastRefresh.HasValue)
            {
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    Last refreshed: @_lastRefresh.Value.ToString("hh:mm:ss tt")
                </MudText>
            }
        </MudPaper>
    </MudItem>

    <MudItem xs="12" md="4" Class="d-flex flex-column">
        <MudPaper Class="pa-4 mb-4">
            <MudText Typo="Typo.h6" Class="mb-4">Quick Links</MudText>
            <MudList T="string" Dense="true">
                <MudListItem Icon="@Icons.Material.Filled.AccountBalance" OnClick="@(() => Navigation.NavigateTo("/adr/accounts"))">
                    View Accounts
                </MudListItem>
                <MudListItem Icon="@Icons.Material.Filled.Work" OnClick="@(() => Navigation.NavigateTo("/adr/jobs"))">
                    View Jobs
                </MudListItem>
                <MudListItem Icon="@Icons.Material.Filled.Warning" OnClick="@(() => Navigation.NavigateTo("/adr/missing-accounts"))">
                    Missing Accounts
                </MudListItem>
            </MudList>
        </MudPaper>
        
        <MudPaper Class="pa-4 flex-grow-1">
            <MudText Typo="Typo.h6" Class="mb-3">Job Pipeline Status</MudText>
            @if (_jobStats != null)
            {
                <!-- Phase Breakdown Summary -->
                <div class="d-flex gap-4 mb-4">
                    <MudPaper Class="pa-3 d-flex flex-column align-center flex-grow-1" Elevation="0" Style="background-color: rgba(66, 165, 245, 0.1); border-left: 4px solid #42a5f5; border-radius: 8px;">
                        <MudText Typo="Typo.h5" Style="color: #42a5f5;">@_jobStats.CredentialPhaseCount.ToString("N0")</MudText>
                        <MudText Typo="Typo.caption">Credential Requests</MudText>
                    </MudPaper>
                    <MudPaper Class="pa-3 d-flex flex-column align-center flex-grow-1" Elevation="0" Style="background-color: rgba(38, 198, 218, 0.1); border-left: 4px solid #26c6da; border-radius: 8px;">
                        <MudText Typo="Typo.h5" Style="color: #26c6da;">@_jobStats.AdrDocumentPhaseCount.ToString("N0")</MudText>
                        <MudText Typo="Typo.caption">ADR Document Requests</MudText>
                    </MudPaper>
                </div>
                
                <MudSimpleTable Dense="true" Hover="true" Style="overflow-x: auto;">
                    <tbody>
                        <tr style="cursor: pointer;" @onclick="@(() => Navigation.NavigateTo("/adr/jobs"))">
                            <td><MudIcon Icon="@Icons.Material.Filled.Work" Size="Size.Small" Class="mr-2" />Total Jobs</td>
                            <td class="text-right"><strong>@_jobStats.TotalCount</strong></td>
                        </tr>
                        <tr style="background-color: rgba(var(--mud-palette-info-rgb), 0.05);">
                            <td colspan="2"><MudText Typo="Typo.caption" Color="Color.Info"><strong>Credential Phase</strong></MudText></td>
                        </tr>
                        <tr style="cursor: pointer;" @onclick="@(() => OnJobPipelineChartClick("Pending"))">
                            <td class="pl-6"><MudIcon Icon="@Icons.Material.Filled.HourglassEmpty" Size="Size.Small" Color="Color.Default" Class="mr-2" />Pending</td>
                            <td class="text-right">@_jobStats.PendingCount</td>
                        </tr>
                        <tr style="cursor: pointer;" @onclick="@(() => OnJobPipelineChartClick("CredentialVerified"))">
                            <td class="pl-6"><MudIcon Icon="@Icons.Material.Filled.VerifiedUser" Size="Size.Small" Color="Color.Info" Class="mr-2" />Credential Verified</td>
                            <td class="text-right"><strong style="color: var(--mud-palette-info);">@_jobStats.CredentialVerifiedCount</strong></td>
                        </tr>
                        <tr style="cursor: pointer;" @onclick="@(() => OnJobPipelineChartClick("CredentialFailed"))">
                            <td class="pl-6"><MudIcon Icon="@Icons.Material.Filled.GppBad" Size="Size.Small" Color="Color.Warning" Class="mr-2" />Credential Failed</td>
                            <td class="text-right"><strong style="color: var(--mud-palette-warning);">@_jobStats.CredentialFailedCount</strong></td>
                        </tr>
                        <tr style="background-color: rgba(var(--mud-palette-primary-rgb), 0.05);">
                            <td colspan="2"><MudText Typo="Typo.caption" Color="Color.Primary"><strong>ADR Document Phase</strong></MudText></td>
                        </tr>
                        <tr style="cursor: pointer;" @onclick="@(() => OnJobPipelineChartClick("ScrapeRequested"))">
                            <td class="pl-6"><MudIcon Icon="@Icons.Material.Filled.CloudDownload" Size="Size.Small" Color="Color.Primary" Class="mr-2" />ADR Request Sent</td>
                            <td class="text-right"><strong style="color: var(--mud-palette-primary);">@_jobStats.ScrapeRequestedCount</strong></td>
                        </tr>
                        <tr style="cursor: pointer;" @onclick="@(() => OnJobPipelineChartClick("Completed"))">
                            <td class="pl-6"><MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" Color="Color.Success" Class="mr-2" />Completed</td>
                            <td class="text-right"><strong style="color: var(--mud-palette-success);">@_jobStats.CompletedCount</strong></td>
                        </tr>
                        <tr style="cursor: pointer;" @onclick="@(() => OnJobPipelineChartClick("Failed"))">
                            <td class="pl-6"><MudIcon Icon="@Icons.Material.Filled.Cancel" Size="Size.Small" Color="Color.Error" Class="mr-2" />Failed</td>
                            <td class="text-right"><strong style="color: var(--mud-palette-error);">@_jobStats.FailedCount</strong></td>
                        </tr>
                        <tr style="cursor: pointer;" @onclick="@(() => OnJobPipelineChartClick("NeedsReview"))">
                            <td class="pl-6"><MudIcon Icon="@Icons.Material.Filled.RateReview" Size="Size.Small" Color="Color.Warning" Class="mr-2" />Needs Review</td>
                            <td class="text-right"><strong style="color: var(--mud-palette-warning);">@_jobStats.NeedsReviewCount</strong></td>
                        </tr>
                        @if (_blacklistCounts != null && _blacklistCounts.CurrentCount > 0)
                        {
                            <tr style="background-color: rgba(var(--mud-palette-error-rgb), 0.05);">
                                <td colspan="2"><MudText Typo="Typo.caption" Color="Color.Error"><strong>Blacklist</strong></MudText></td>
                            </tr>
                            <tr style="cursor: pointer;" @onclick="@(() => Navigation.NavigateTo("/admin/adr-blacklist?status=current"))">
                                <td class="pl-6"><MudIcon Icon="@Icons.Material.Filled.Block" Size="Size.Small" Color="Color.Error" Class="mr-2" />Currently Blacklisted</td>
                                <td class="text-right"><strong style="color: var(--mud-palette-error);">@_blacklistCounts.CurrentCount</strong></td>
                            </tr>
                        }
                    </tbody>
                </MudSimpleTable>
                <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-2">Current status of all jobs in database</MudText>
                
                @if (_jobPipelineChartData.Length > 0)
                {
                    <div class="mt-4">
                        <PlotlyPieChart Values="@_jobPipelineChartData"
                                        Labels="@_jobPipelineChartLabels"
                                        Colors="@_jobPipelineChartColors"
                                        CustomData="@_jobPipelineChartCustomData"
                                        Height="280px"
                                        ShowLegend="true"
                                        OnSliceClick="OnJobPipelineChartClick" />
                    </div>
                }
            }
            else
            {
                <MudText Typo="Typo.body2" Color="Color.Secondary" Align="Align.Center" Class="pa-4">
                    Loading job stats...
                </MudText>
            }
        </MudPaper>
    </MudItem>
</MudGrid>

<MudPaper Class="pa-4 mt-4">
    <div class="d-flex justify-space-between align-center mb-4">
        <MudText Typo="Typo.h6">@(_showAllHistory ? $"All Orchestration History ({_historyTotalCount} runs)" : "Recent Orchestration History")</MudText>
        <MudButton Variant="Variant.Text" 
                   Color="Color.Primary" 
                   StartIcon="@(_showAllHistory ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)"
                   OnClick="ToggleShowAllHistory"
                   Disabled="_historyLoading">
            @(_showAllHistory ? "Show Recent" : "Show All")
        </MudButton>
    </div>
    
    @if (_historyLoading)
    {
        <div class="d-flex justify-center pa-4">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Small" />
        </div>
    }
    else if (_history == null || !_history.Any())
    {
        <MudText Typo="Typo.body2" Color="Color.Secondary" Align="Align.Center" Class="pa-4">
            No orchestration history available
        </MudText>
    }
    else
    {
        <MudTable Items="_history" Hover="true" Dense="true" Breakpoint="Breakpoint.Sm" OnRowClick="@OnHistoryRowClick" T="AdrOrchestrationStatus" RowStyle="cursor: pointer;">
            <HeaderContent>
                <MudTh>Request ID</MudTh>
                <MudTh>Requested By</MudTh>
                <MudTh>Requested At</MudTh>
                <MudTh>Started At</MudTh>
                <MudTh>Completed At</MudTh>
                <MudTh>Status</MudTh>
                <MudTh>Duration</MudTh>
                <MudTh>Details</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Request ID">
                    <MudText Typo="Typo.caption">@context.RequestId[..8]...</MudText>
                </MudTd>
                <MudTd DataLabel="Requested By">@context.RequestedBy</MudTd>
                <MudTd DataLabel="Requested At">@FormatDateTime(context.RequestedAt, "MM/dd/yyyy hh:mm tt")</MudTd>
                <MudTd DataLabel="Started At">@(context.StartedAt.HasValue ? ConvertToUserTime(context.StartedAt.Value).ToString("hh:mm:ss tt") : "N/A")</MudTd>
                <MudTd DataLabel="Completed At">@(context.CompletedAt.HasValue ? ConvertToUserTime(context.CompletedAt.Value).ToString("hh:mm:ss tt") : "N/A")</MudTd>
                <MudTd DataLabel="Status">
                    <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context.Status)">@context.Status</MudChip>
                </MudTd>
                <MudTd DataLabel="Duration">
                    @if (context.StartedAt.HasValue && context.CompletedAt.HasValue)
                    {
                        var duration = context.CompletedAt.Value - context.StartedAt.Value;
                        <text>@duration.ToString(@"hh\:mm\:ss")</text>
                    }
                    else if (context.StartedAt.HasValue)
                    {
                        <text>In progress...</text>
                    }
                    else
                    {
                        <text>N/A</text>
                    }
                </MudTd>
                <MudTd DataLabel="Details">
                    <MudIconButton Icon="@Icons.Material.Filled.Visibility" Size="Size.Small" Color="Color.Primary" OnClick="@(() => ShowRunDetails(context))" />
                </MudTd>
            </RowTemplate>
        </MudTable>
        
        @if (_showAllHistory && _historyTotalPages > 1)
        {
            <div class="d-flex justify-center mt-4">
                <MudPagination Count="@_historyTotalPages" 
                               Selected="@_historyPageNumber" 
                               SelectedChanged="OnHistoryPageChanged"
                               Color="Color.Primary"
                               ShowFirstButton="true"
                               ShowLastButton="true" />
            </div>
        }
    }
</MudPaper>

<MudDialog @bind-Visible="_showRunDetailsDialog" Options="@_dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.History" Class="mr-2" />
            Orchestration Run Details
        </MudText>
    </TitleContent>
    <DialogContent>
        @if (_selectedRun != null)
        {
            <MudGrid>
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Request ID</MudText>
                    <MudText Typo="Typo.body1" Class="mb-3">@_selectedRun.RequestId</MudText>
                    
                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Requested By</MudText>
                    <MudText Typo="Typo.body1" Class="mb-3">@_selectedRun.RequestedBy</MudText>
                    
                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Requested At</MudText>
                    <MudText Typo="Typo.body1" Class="mb-3">@FormatDateTime(_selectedRun.RequestedAt, "MM/dd/yyyy hh:mm:ss tt")</MudText>
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Status</MudText>
                    <MudChip T="string" Size="Size.Medium" Color="@GetStatusColor(_selectedRun.Status)" Class="mb-3">
                        @_selectedRun.Status
                    </MudChip>
                    
                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Started At</MudText>
                    <MudText Typo="Typo.body1" Class="mb-3">@(_selectedRun.StartedAt.HasValue ? FormatDateTime(_selectedRun.StartedAt, "MM/dd/yyyy hh:mm:ss tt") : "N/A")</MudText>
                    
                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Completed At</MudText>
                    <MudText Typo="Typo.body1" Class="mb-3">@(_selectedRun.CompletedAt.HasValue ? FormatDateTime(_selectedRun.CompletedAt, "MM/dd/yyyy hh:mm:ss tt") : "N/A")</MudText>
                    
                    @if (_selectedRun.StartedAt.HasValue && _selectedRun.CompletedAt.HasValue)
                    {
                        var duration = _selectedRun.CompletedAt.Value - _selectedRun.StartedAt.Value;
                        <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Duration</MudText>
                        <MudText Typo="Typo.body1">@duration.ToString(@"hh\:mm\:ss")</MudText>
                    }
                </MudItem>
            </MudGrid>
            
            @if (!string.IsNullOrEmpty(_selectedRun.ErrorMessage))
            {
                <MudAlert Severity="Severity.Error" Class="my-3">@_selectedRun.ErrorMessage</MudAlert>
            }
            
            <MudDivider Class="my-4" />
            <MudText Typo="Typo.subtitle1" Class="mb-3">Step Results</MudText>
            
            <MudTimeline TimelinePosition="TimelinePosition.Start">
                <MudTimelineItem Color="@GetSelectedRunStepColor("Syncing accounts")" Icon="@Icons.Material.Filled.CheckCircle">
                    <ItemContent>
                        <MudText Typo="Typo.body2"><strong>Sync Accounts</strong></MudText>
                        @if (_selectedRun.SyncResult != null)
                        {
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                @_selectedRun.SyncResult.AccountsInserted inserted, @_selectedRun.SyncResult.AccountsUpdated updated
                            </MudText>
                            @if (_selectedRun.SyncResult.Errors > 0)
                            {
                                <MudText Typo="Typo.caption" Color="Color.Error">
                                    @_selectedRun.SyncResult.Errors errors
                                </MudText>
                            }
                        }
                        else
                        {
                            <MudText Typo="Typo.caption" Color="Color.Secondary">No data</MudText>
                        }
                    </ItemContent>
                </MudTimelineItem>
                <MudTimelineItem Color="@GetSelectedRunStepColor("Creating jobs")" Icon="@Icons.Material.Filled.CheckCircle">
                    <ItemContent>
                        <MudText Typo="Typo.body2"><strong>Create Jobs</strong></MudText>
                        @if (_selectedRun.JobCreationResult != null)
                        {
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                @_selectedRun.JobCreationResult.JobsCreated created, @_selectedRun.JobCreationResult.JobsSkipped skipped
                            </MudText>
                            @if (_selectedRun.JobCreationResult.Errors > 0)
                            {
                                <MudText Typo="Typo.caption" Color="Color.Error">
                                    @_selectedRun.JobCreationResult.Errors errors
                                </MudText>
                            }
                        }
                        else
                        {
                            <MudText Typo="Typo.caption" Color="Color.Secondary">No data</MudText>
                        }
                    </ItemContent>
                </MudTimelineItem>
                <MudTimelineItem Color="@GetSelectedRunStepColor("Verifying credentials")" Icon="@Icons.Material.Filled.CheckCircle">
                    <ItemContent>
                        <MudText Typo="Typo.body2"><strong>Verify Credentials</strong></MudText>
                        @if (_selectedRun.CredentialVerificationResult != null)
                        {
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                <span style="color: var(--mud-palette-success);">@_selectedRun.CredentialVerificationResult.CredentialsVerified verified</span>,
                                <span style="color: var(--mud-palette-error);">@_selectedRun.CredentialVerificationResult.CredentialsFailed failed</span>
                            </MudText>
                            @if (_selectedRun.CredentialVerificationResult.Errors > 0)
                            {
                                <MudText Typo="Typo.caption" Color="Color.Error">
                                    @_selectedRun.CredentialVerificationResult.Errors errors
                                </MudText>
                            }
                        }
                        else
                        {
                            <MudText Typo="Typo.caption" Color="Color.Secondary">No data</MudText>
                        }
                    </ItemContent>
                </MudTimelineItem>
                <MudTimelineItem Color="@GetSelectedRunStepColor("Checking statuses")" Icon="@Icons.Material.Filled.CheckCircle">
                    <ItemContent>
                        <MudText Typo="Typo.body2"><strong>Check Statuses</strong></MudText>
                        @if (_selectedRun.StatusCheckResult != null)
                        {
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                @_selectedRun.StatusCheckResult.JobsChecked checked,
                                <span style="color: var(--mud-palette-success);">@_selectedRun.StatusCheckResult.JobsCompleted completed</span>,
                                <span style="color: var(--mud-palette-warning);">@_selectedRun.StatusCheckResult.JobsNeedingReview need review</span>
                            </MudText>
                            @if (_selectedRun.StatusCheckResult.Errors > 0)
                            {
                                <MudText Typo="Typo.caption" Color="Color.Error">
                                    @_selectedRun.StatusCheckResult.Errors errors
                                </MudText>
                            }
                        }
                        else
                        {
                            <MudText Typo="Typo.caption" Color="Color.Secondary">No data</MudText>
                        }
                    </ItemContent>
                </MudTimelineItem>
                <MudTimelineItem Color="@GetSelectedRunStepColor("Processing scraping")" Icon="@Icons.Material.Filled.CheckCircle">
                    <ItemContent>
                        <MudText Typo="Typo.body2"><strong>Send ADR Requests</strong></MudText>
                        @if (_selectedRun.ScrapeResult != null)
                        {
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                @_selectedRun.ScrapeResult.ScrapesRequested ADR requests sent,
                                <span style="color: var(--mud-palette-success);">@_selectedRun.ScrapeResult.ScrapesCompleted completed</span>,
                                <span style="color: var(--mud-palette-error);">@_selectedRun.ScrapeResult.ScrapesFailed failed</span>
                            </MudText>
                            @if (_selectedRun.ScrapeResult.Errors > 0)
                            {
                                <MudText Typo="Typo.caption" Color="Color.Error">
                                    @_selectedRun.ScrapeResult.Errors errors
                                </MudText>
                            }
                        }
                        else
                        {
                            <MudText Typo="Typo.caption" Color="Color.Secondary">No data</MudText>
                        }
                    </ItemContent>
                </MudTimelineItem>
            </MudTimeline>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@(() => _showRunDetailsDialog = false)" Color="Color.Primary">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    private OrchestrationCurrentResponse? _currentStatus;
    private List<AdrOrchestrationStatus>? _history;
    private List<AdrOrchestrationStatus>? _recentHistory; // Separate list for chart (always last 10)
    private AdrOrchestrationStatus? _lastCompletedRun;
    private bool _loading = true;
    private bool _historyLoading = true;
    private bool _isRefreshing = false;
    private bool _isStarting = false;
    private bool _isCheckingStatuses = false;
    private bool _isCancelling = false;
    private StatusCheckResult? _statusCheckResult = null;
    private bool _autoRefreshEnabled = true;
    private bool _showAllHistory = false;
    private DateTime? _lastRefresh;
    private System.Threading.Timer? _refreshTimer;
    
    // Paging state for history
    private int _historyPageNumber = 1;
    private int _historyPageSize = 20;
    private int _historyTotalCount = 0;
    private int _historyTotalPages = 0;
    
    // Fast progress polling (every 5 seconds when orchestration is running)
    private PeriodicTimer? _progressTimer;
    private CancellationTokenSource? _progressTimerCts;
    private bool _isProgressPolling = false;
    
    // Cached timezone info for display
    private string _userTimeZoneAbbr = "";
    private string _userTimeZoneId = "";
    
    // Run details dialog state
    private bool _showRunDetailsDialog = false;
    private AdrOrchestrationStatus? _selectedRun;
    private DialogOptions _dialogOptions = new DialogOptions 
    { 
        MaxWidth = MaxWidth.Medium, 
        FullWidth = true,
        CloseOnEscapeKey = true
    };
    
    // Chart data for orchestration status distribution
    private double[] _orchestrationChartData = Array.Empty<double>();
    private string[] _orchestrationChartLabels = Array.Empty<string>();
    private string[] _orchestrationChartColors = Array.Empty<string>();
    private Dictionary<string, int> _orchestrationStatusCounts = new();
    
    // Job pipeline stats
    private AdrJobStats? _jobStats;
    
    // Blacklist counts
    private BlacklistCountsResult? _blacklistCounts;
    
    // Job pipeline chart data
    private double[] _jobPipelineChartData = Array.Empty<double>();
    private string[] _jobPipelineChartLabels = Array.Empty<string>();
    private string[] _jobPipelineChartColors = Array.Empty<string>();
    private string[] _jobPipelineChartCustomData = Array.Empty<string>(); // Internal status values for navigation

    protected override async Task OnInitializedAsync()
    {
        // Initialize timezone info
        _userTimeZoneId = await TimeZoneService.GetUserTimeZoneIdAsync();
        _userTimeZoneAbbr = await TimeZoneService.GetUserTimeZoneAbbreviationAsync();
        
        await LoadDataAsync();
        StartAutoRefresh();
        
        // Start fast progress polling if orchestration is already running
        if (_currentStatus?.IsRunning == true)
        {
            StartProgressPolling();
        }
    }

    private async Task LoadDataAsync()
    {
        try
        {
            _loading = true;
            _historyLoading = true;
            StateHasChanged();

            var statusTask = AdrService.GetCurrentOrchestrationAsync();
            var historyTask = AdrService.GetOrchestrationHistoryAsync(10);

            await Task.WhenAll(statusTask, historyTask);

            _currentStatus = await statusTask;
            _history = await historyTask;
            _recentHistory = _history; // Keep a copy for the chart (always last 10)
            _lastRefresh = DateTime.Now;
            
            // Get the most recent completed run from history for display when not running
            _lastCompletedRun = _history?.FirstOrDefault(h => h.Status == "Completed" || h.Status == "Failed");
            
            // Update chart data and load job stats (scoped to last 20 orchestration runs)
            UpdateChartData();
            // Show all jobs in the pipeline, not just last 20 runs
            _jobStats = await AdrService.GetJobStatsAsync();
            _blacklistCounts = await AdrService.GetBlacklistCountsAsync();
            UpdateJobPipelineChartData();
            
            // Start/stop fast progress polling based on orchestration state
            if (_currentStatus?.IsRunning == true && !_isProgressPolling)
            {
                StartProgressPolling();
            }
            else if (_currentStatus?.IsRunning != true && _isProgressPolling)
            {
                StopProgressPolling();
            }
        }
        catch (SessionExpiredException)
        {
            Snackbar.Add("Your session has expired. Redirecting to login...", Severity.Warning);
            Navigation.NavigateTo("/Account/Login", forceLoad: true);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading data: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
            _historyLoading = false;
            StateHasChanged();
        }
    }
    
    private void UpdateChartData()
    {
        if (_recentHistory == null || !_recentHistory.Any())
        {
            _orchestrationChartData = Array.Empty<double>();
            _orchestrationChartLabels = Array.Empty<string>();
            _orchestrationChartColors = Array.Empty<string>();
            _orchestrationStatusCounts = new Dictionary<string, int>();
            return;
        }
        
        // Status to color mapping for Plotly
        var statusColorMap = new Dictionary<string, string>
        {
            { "Completed", "#66bb6a" }, // Green
            { "Failed", "#f44336" },    // Red
            { "Cancelled", "#ff9800" }, // Orange
            { "Running", "#42a5f5" },   // Blue
            { "Queued", "#9e9e9e" }     // Gray
        };
        
        // Count runs by status - order matches the color palette
        var statusOrder = new[] { "Completed", "Failed", "Cancelled", "Running", "Queued" };
        _orchestrationStatusCounts = _recentHistory
            .GroupBy(h => h.Status)
            .ToDictionary(g => g.Key, g => g.Count());
        
        // Build chart data in the order of the color palette
        var dataList = new List<double>();
        var labelList = new List<string>();
        var colorList = new List<string>();
        
        foreach (var status in statusOrder)
        {
            if (_orchestrationStatusCounts.TryGetValue(status, out var count) && count > 0)
            {
                dataList.Add(count);
                labelList.Add(status);
                colorList.Add(statusColorMap.TryGetValue(status, out var color) ? color : "#9e9e9e");
            }
        }
        
        _orchestrationChartData = dataList.ToArray();
        _orchestrationChartLabels = labelList.ToArray();
        _orchestrationChartColors = colorList.ToArray();
    }
    
    private void UpdateJobPipelineChartData()
    {
        if (_jobStats == null)
        {
            _jobPipelineChartData = Array.Empty<double>();
            _jobPipelineChartLabels = Array.Empty<string>();
            _jobPipelineChartColors = Array.Empty<string>();
            _jobPipelineChartCustomData = Array.Empty<string>();
            return;
        }
        
        // Status to color mapping for Plotly
        var statusColorMap = new Dictionary<string, string>
        {
            { "Pending", "#9e9e9e" },           // Gray
            { "Credential Verified", "#42a5f5" }, // Blue/Info
            { "Credential Failed", "#ff9800" },  // Orange/Warning
            { "ADR Request Sent", "#7e57c2" },   // Purple/Primary
            { "Completed", "#66bb6a" },          // Green/Success
            { "Failed", "#f44336" },             // Red/Error
            { "Needs Review", "#ffa726" }        // Orange/Warning - slightly different shade
        };
        
        // Build chart data - order matches the color palette
        // Only include non-zero values to avoid empty slices
        var dataList = new List<double>();
        var labelList = new List<string>();
        var colorList = new List<string>();
        var customDataList = new List<string>(); // Internal status values for navigation
        
        if (_jobStats.PendingCount > 0)
        {
            dataList.Add(_jobStats.PendingCount);
            labelList.Add("Pending");
            colorList.Add(statusColorMap["Pending"]);
            customDataList.Add("Pending");
        }
        if (_jobStats.CredentialVerifiedCount > 0)
        {
            dataList.Add(_jobStats.CredentialVerifiedCount);
            labelList.Add("Credential Verified");
            colorList.Add(statusColorMap["Credential Verified"]);
            customDataList.Add("CredentialVerified");
        }
        if (_jobStats.CredentialFailedCount > 0)
        {
            dataList.Add(_jobStats.CredentialFailedCount);
            labelList.Add("Credential Failed");
            colorList.Add(statusColorMap["Credential Failed"]);
            customDataList.Add("CredentialFailed");
        }
        if (_jobStats.ScrapeRequestedCount > 0)
        {
            dataList.Add(_jobStats.ScrapeRequestedCount);
            labelList.Add("ADR Request Sent");
            colorList.Add(statusColorMap["ADR Request Sent"]);
            customDataList.Add("ScrapeRequested");
        }
        if (_jobStats.CompletedCount > 0)
        {
            dataList.Add(_jobStats.CompletedCount);
            labelList.Add("Completed");
            colorList.Add(statusColorMap["Completed"]);
            customDataList.Add("Completed");
        }
        if (_jobStats.FailedCount > 0)
        {
            dataList.Add(_jobStats.FailedCount);
            labelList.Add("Failed");
            colorList.Add(statusColorMap["Failed"]);
            customDataList.Add("Failed");
        }
        if (_jobStats.NeedsReviewCount > 0)
        {
            dataList.Add(_jobStats.NeedsReviewCount);
            labelList.Add("Needs Review");
            colorList.Add(statusColorMap["Needs Review"]);
            customDataList.Add("NeedsReview");
        }
        
        _jobPipelineChartData = dataList.ToArray();
        _jobPipelineChartLabels = labelList.ToArray();
        _jobPipelineChartColors = colorList.ToArray();
        _jobPipelineChartCustomData = customDataList.ToArray();
    }
    
    private void OnJobPipelineChartClick(string status)
    {
        // Navigate to ADR Jobs page with the clicked status as a filter
        // Status values are internal enum values: "Pending", "CredentialVerified", "ScrapeRequested", "Completed", "Failed", "NeedsReview"
        var encodedStatus = Uri.EscapeDataString(status);
        Navigation.NavigateTo($"/adr/jobs?status={encodedStatus}");
    }
    
    private async Task LoadCurrentStatusAsync()
    {
        try
        {
            _currentStatus = await AdrService.GetCurrentOrchestrationAsync();
            _lastRefresh = DateTime.Now;
            StateHasChanged();
            
            // Stop polling if orchestration completed
            if (_currentStatus?.IsRunning != true)
            {
                StopProgressPolling();
                // Refresh history to show completed run
                _history = await AdrService.GetOrchestrationHistoryAsync(10);
                _recentHistory = _history; // Update chart data source
                UpdateChartData();
                StateHasChanged();
            }
        }
        catch (SessionExpiredException)
        {
            StopProgressPolling();
            Snackbar.Add("Your session has expired. Redirecting to login...", Severity.Warning);
            Navigation.NavigateTo("/Account/Login", forceLoad: true);
        }
        catch
        {
            // Ignore errors during progress polling
        }
    }

    private async Task RefreshStatus()
    {
        _isRefreshing = true;
        StateHasChanged();

        try
        {
            await LoadDataAsync();
        }
        finally
        {
            _isRefreshing = false;
            StateHasChanged();
        }
    }

    private async Task ToggleShowAllHistory()
    {
        _showAllHistory = !_showAllHistory;
        _historyPageNumber = 1; // Reset to first page when toggling
        _historyLoading = true;
        StateHasChanged();

        try
        {
            if (_showAllHistory)
            {
                // Load paged history
                var pagedResult = await AdrService.GetOrchestrationHistoryPagedAsync(_historyPageNumber, _historyPageSize);
                _history = pagedResult.Items;
                _historyTotalCount = pagedResult.TotalCount;
                _historyTotalPages = pagedResult.TotalPages;
            }
            else
            {
                // Load just recent (10 records)
                _history = await AdrService.GetOrchestrationHistoryAsync(10);
                _historyTotalCount = 0;
                _historyTotalPages = 0;
            }
        }
        catch (SessionExpiredException)
        {
            Snackbar.Add("Your session has expired. Redirecting to login...", Severity.Warning);
            Navigation.NavigateTo("/Account/Login", forceLoad: true);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading history: {ex.Message}", Severity.Error);
        }
        finally
        {
            _historyLoading = false;
            StateHasChanged();
        }
    }

    private async Task OnHistoryPageChanged(int page)
    {
        _historyPageNumber = page;
        _historyLoading = true;
        StateHasChanged();

        try
        {
            var pagedResult = await AdrService.GetOrchestrationHistoryPagedAsync(_historyPageNumber, _historyPageSize);
            _history = pagedResult.Items;
            _historyTotalCount = pagedResult.TotalCount;
            _historyTotalPages = pagedResult.TotalPages;
        }
        catch (SessionExpiredException)
        {
            Snackbar.Add("Your session has expired. Redirecting to login...", Severity.Warning);
            Navigation.NavigateTo("/Account/Login", forceLoad: true);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading history: {ex.Message}", Severity.Error);
        }
        finally
        {
            _historyLoading = false;
            StateHasChanged();
        }
    }

    private async Task StartOrchestration()
    {
        _isStarting = true;
        StateHasChanged();

        try
        {
            var response = await AdrService.StartBackgroundOrchestrationAsync();
            Snackbar.Add($"Orchestration started! Request ID: {response.RequestId[..8]}...", Severity.Success);
            
            // Wait a moment then refresh to show the running status
            await Task.Delay(1000);
            await LoadDataAsync();
        }
        catch (SessionExpiredException)
        {
            Snackbar.Add("Your session has expired. Redirecting to login...", Severity.Warning);
            Navigation.NavigateTo("/Account/Login", forceLoad: true);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to start orchestration: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isStarting = false;
            StateHasChanged();
        }
    }

    private async Task CancelOrchestration()
    {
        if (_currentStatus?.Status?.RequestId == null) return;
        
        _isCancelling = true;
        StateHasChanged();

        try
        {
            var result = await AdrService.CancelOrchestrationAsync(_currentStatus.Status.RequestId);
            
            if (result.Success)
            {
                Snackbar.Add("Cancellation initiated. The orchestration will stop after the current operation completes.", Severity.Info);
                
                // Refresh to show the updated status
                await Task.Delay(500);
                await LoadDataAsync();
            }
            else
            {
                Snackbar.Add($"Failed to cancel: {result.Error ?? result.Message ?? "Unknown error"}", Severity.Error);
            }
        }
        catch (SessionExpiredException)
        {
            Snackbar.Add("Your session has expired. Redirecting to login...", Severity.Warning);
            Navigation.NavigateTo("/Account/Login", forceLoad: true);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to cancel orchestration: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isCancelling = false;
            StateHasChanged();
        }
    }

    private async Task CheckStatusesOnly()
    {
        _isCheckingStatuses = true;
        _statusCheckResult = null; // Clear previous result
        StateHasChanged();

        try
        {
            // Use background orchestration with only status check enabled
            // This runs CheckAllScrapedStatusesAsync which checks ALL jobs with ScrapeRequested status
            var response = await AdrService.StartBackgroundOrchestrationAsync(new BackgroundOrchestrationRequest
            {
                RunSync = false,
                RunCreateJobs = false,
                RunCredentialVerification = false,
                RunScraping = false,
                RunStatusCheck = true,
                CheckAllScrapedStatuses = true // Use CheckAllScrapedStatusesAsync instead of CheckPendingStatusesAsync
            });
            
            Snackbar.Add($"Status check started in background. Request ID: {response.RequestId}", Severity.Info);
            
            // Refresh to show the running orchestration
            await LoadDataAsync();
            
            // Start progress polling to show updates
            StartProgressPolling();
        }
        catch (SessionExpiredException)
        {
            Snackbar.Add("Your session has expired. Redirecting to login...", Severity.Warning);
            Navigation.NavigateTo("/Account/Login", forceLoad: true);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to start status check: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isCheckingStatuses = false;
            StateHasChanged();
        }
    }
    
    private void ClearStatusCheckResult()
    {
        _statusCheckResult = null;
        StateHasChanged();
    }

    private void StartAutoRefresh()
    {
        _refreshTimer = new System.Threading.Timer(async _ =>
        {
            if (_autoRefreshEnabled)
            {
                await InvokeAsync(async () =>
                {
                    try
                    {
                        await LoadDataAsync();
                    }
                    catch (SessionExpiredException)
                    {
                        Snackbar.Add("Your session has expired. Redirecting to login...", Severity.Warning);
                        Navigation.NavigateTo("/Account/Login", forceLoad: true);
                    }
                    catch
                    {
                        // Ignore other errors during auto-refresh
                    }
                });
            }
        }, null, TimeSpan.FromSeconds(60), TimeSpan.FromSeconds(60));
    }
    
    private void StartProgressPolling()
    {
        if (_isProgressPolling) return;
        
        // Capture locals to avoid race condition where StopProgressPolling sets fields to null
        // while the background task is still running
        var cts = new CancellationTokenSource();
        var timer = new PeriodicTimer(TimeSpan.FromSeconds(5));
        
        _progressTimerCts = cts;
        _progressTimer = timer;
        _isProgressPolling = true;
        
        _ = Task.Run(async () =>
        {
            try
            {
                // Use local variables (timer, cts) instead of fields to avoid NullReferenceException
                while (await timer.WaitForNextTickAsync(cts.Token))
                {
                    if (_autoRefreshEnabled && _currentStatus?.IsRunning == true)
                    {
                        await InvokeAsync(async () =>
                        {
                            await LoadCurrentStatusAsync();
                        });
                    }
                }
            }
            catch (SessionExpiredException)
            {
                await InvokeAsync(() =>
                {
                    Snackbar.Add("Your session has expired. Redirecting to login...", Severity.Warning);
                    Navigation.NavigateTo("/Account/Login", forceLoad: true);
                    return Task.CompletedTask;
                });
            }
            catch (OperationCanceledException)
            {
                // Timer was cancelled, this is expected
            }
            catch
            {
                // Ignore other errors during progress polling
            }
            finally
            {
                // Dispose in finally block to ensure cleanup happens in one place
                timer.Dispose();
                cts.Dispose();
                _isProgressPolling = false;
                _progressTimer = null;
                _progressTimerCts = null;
            }
        });
    }
    
    private void StopProgressPolling()
    {
        // Only cancel - the background task will handle disposal in its finally block
        _progressTimerCts?.Cancel();
    }

    private Color GetStatusColor(string status) => status switch
    {
        "Queued" => Color.Default,
        "Running" => Color.Info,
        "Completed" => Color.Success,
        "Failed" => Color.Error,
        "Cancelled" => Color.Warning,
        _ => Color.Default
    };

    private Color GetStepColor(string stepName, AdrOrchestrationStatus status)
    {
        // Step order: Sync  Create Jobs  Verify Credentials  Check Statuses  Process Scraping
        var steps = new[] { "Syncing accounts", "Creating jobs", "Verifying credentials", "Checking statuses", "Processing scraping" };
        // Normalize "Checking all scraped statuses" to "Checking statuses" for comparison
        var normalizedCurrentStep = status.CurrentStep == "Checking all scraped statuses" ? "Checking statuses" : status.CurrentStep;
        var currentIndex = Array.IndexOf(steps, normalizedCurrentStep);
        var stepIndex = Array.IndexOf(steps, stepName);

        // Handle cancelling/cancelled states
        if (status.Status == "Cancelling" || status.Status == "Cancelled")
        {
            if (normalizedCurrentStep == stepName)
                return Color.Warning; // Current step being cancelled
            else if (stepIndex < currentIndex)
                return Color.Success; // Completed before cancellation
            else
                return Color.Default; // Will not run (cancelled)
        }

        if (normalizedCurrentStep == stepName)
            return Color.Info; // Current step
        else if (stepIndex < currentIndex || (status.Status == "Completed" && stepIndex <= steps.Length))
            return Color.Success; // Completed step
        else
            return Color.Default; // Pending step
    }

    private string GetStepIcon(string stepName, AdrOrchestrationStatus status)
    {
        // Step order: Sync  Create Jobs  Verify Credentials  Check Statuses  Process Scraping
        var steps = new[] { "Syncing accounts", "Creating jobs", "Verifying credentials", "Checking statuses", "Processing scraping" };
        // Normalize "Checking all scraped statuses" to "Checking statuses" for comparison
        var normalizedCurrentStep = status.CurrentStep == "Checking all scraped statuses" ? "Checking statuses" : status.CurrentStep;
        var currentIndex = Array.IndexOf(steps, normalizedCurrentStep);
        var stepIndex = Array.IndexOf(steps, stepName);

        // Handle cancelling/cancelled states
        if (status.Status == "Cancelling" || status.Status == "Cancelled")
        {
            if (normalizedCurrentStep == stepName)
                return Icons.Material.Filled.Cancel; // Current step being cancelled
            else if (stepIndex < currentIndex)
                return Icons.Material.Filled.CheckCircle; // Completed before cancellation
            else
                return Icons.Material.Filled.Block; // Will not run (cancelled)
        }

        if (normalizedCurrentStep == stepName)
            return Icons.Material.Filled.PlayCircle;
        else if (stepIndex < currentIndex || status.Status == "Completed")
            return Icons.Material.Filled.CheckCircle;
        else
            return Icons.Material.Filled.Circle;
    }
    
    private Color GetLastRunStepColor(string stepName)
    {
        // For completed runs, show success for all steps (or error if the run failed)
        if (_lastCompletedRun?.Status == "Failed")
            return Color.Error;
        return Color.Success;
    }
    
    private Color GetSelectedRunStepColor(string stepName)
    {
        // For the selected run in the dialog, show success for all steps (or error if the run failed)
        if (_selectedRun?.Status == "Failed")
            return Color.Error;
        return Color.Success;
    }
    
    private void OnHistoryRowClick(TableRowClickEventArgs<AdrOrchestrationStatus> args)
    {
        ShowRunDetails(args.Item);
    }
    
    private void ShowRunDetails(AdrOrchestrationStatus run)
    {
        _selectedRun = run;
        _showRunDetailsDialog = true;
        StateHasChanged();
    }

    public void Dispose()
    {
        _refreshTimer?.Dispose();
        StopProgressPolling();
    }
    
    /// <summary>
    /// Converts a UTC DateTime to the user's preferred timezone.
    /// Uses the cached timezone ID from initialization.
    /// </summary>
    private DateTime ConvertToUserTime(DateTime utcDateTime)
    {
        if (string.IsNullOrEmpty(_userTimeZoneId))
            return utcDateTime;
        
        try
        {
            // Handle Unspecified kind by treating it as UTC
            if (utcDateTime.Kind == DateTimeKind.Unspecified)
                utcDateTime = DateTime.SpecifyKind(utcDateTime, DateTimeKind.Utc);
            
            var tz = TimeZoneInfo.FindSystemTimeZoneById(_userTimeZoneId);
            return TimeZoneInfo.ConvertTimeFromUtc(utcDateTime, tz);
        }
        catch
        {
            return utcDateTime;
        }
    }
    
    /// <summary>
    /// Formats a DateTime for display with the user's timezone abbreviation.
    /// </summary>
    private string FormatDateTime(DateTime? dateTime, string format = "g")
    {
        if (!dateTime.HasValue)
            return "N/A";
        
        var localTime = ConvertToUserTime(dateTime.Value);
        var abbr = !string.IsNullOrEmpty(_userTimeZoneAbbr) ? $" ({_userTimeZoneAbbr})" : "";
        return $"{localTime.ToString(format)}{abbr}";
    }
    
    /// <summary>
    /// Formats a TimeSpan duration for display (e.g., "2m 34s", "1h 5m 12s").
    /// </summary>
    private string FormatDuration(TimeSpan duration)
    {
        if (duration.TotalSeconds < 1)
            return "< 1s";
        
        if (duration.TotalMinutes < 1)
            return $"{duration.Seconds}s";
        
        if (duration.TotalHours < 1)
            return $"{duration.Minutes}m {duration.Seconds}s";
        
        return $"{(int)duration.TotalHours}h {duration.Minutes}m {duration.Seconds}s";
    }
}
