@page "/adr/missing-accounts"
@rendermode InteractiveServer
@attribute [Authorize]
@inject IAdrService AdrService
@inject IClientService ClientService
@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageTitle>Missing Accounts Report</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Missing Accounts Report</MudText>

<MudAlert Severity="Severity.Info" Class="mb-4">
    This report shows accounts with a Historical Billing Status of "Missing" - accounts that have not received invoices within their expected billing cycle.
</MudAlert>

<MudPaper Class="pa-4">
    <MudGrid Class="mb-4" Spacing="2">
        <MudItem xs="12" md="3">
            <MudTextField @bind-Value="_searchTerm" 
                          Label="Search by Account # or Interface Account ID" 
                          Placeholder="Enter account number or interface ID"
                          Variant="Variant.Outlined" 
                          Margin="Margin.Dense" 
                          Clearable="true"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search" />
        </MudItem>
        <MudItem xs="12" md="3">
            <MudAutocomplete T="Client" 
                             Label="Filter by Client" 
                             @bind-Value="_selectedClient"
                             SearchFunc="SearchClients"
                             ToStringFunc="@(c => c?.ClientName ?? "All Clients")"
                             Variant="Variant.Outlined" 
                             Margin="Margin.Dense" 
                             Clearable="true"
                             ResetValueOnEmptyText="true"
                             CoerceText="false"
                             AdornmentIcon="@Icons.Material.Filled.Business"
                             AdornmentColor="Color.Primary" />
        </MudItem>
        <MudItem xs="12" md="6" Class="d-flex align-center justify-end gap-2">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ApplyFilters" StartIcon="@Icons.Material.Filled.FilterAlt">
                Apply
            </MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="ClearFilters" StartIcon="@Icons.Material.Filled.Clear">
                Clear
            </MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="ExportReport" StartIcon="@Icons.Material.Filled.Download">
                Export
            </MudButton>
        </MudItem>
    </MudGrid>

    @if (_loading)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    }
    else
    {
        <MudTable T="AdrAccount" ServerData="@ServerReload" 
                  @ref="_table" Hover="true" Breakpoint="Breakpoint.Sm" Dense="true">
            <HeaderContent>
                <MudTh>Account #</MudTh>
                <MudTh>Interface Account ID</MudTh>
                <MudTh>Client</MudTh>
                <MudTh>Vendor Code</MudTh>
                <MudTh>Period Type</MudTh>
                <MudTh>Last Invoice</MudTh>
                <MudTh>Expected Next</MudTh>
                <MudTh>Days Overdue</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Account #">
                    <MudText Typo="Typo.body2"><strong>@context.VMAccountNumber</strong></MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">ID: @context.VMAccountId</MudText>
                </MudTd>
                <MudTd DataLabel="Interface Account ID">@(context.InterfaceAccountId ?? "N/A")</MudTd>
                <MudTd DataLabel="Client">@(context.ClientName ?? "N/A")</MudTd>
                <MudTd DataLabel="Vendor Code">@(context.VendorCode ?? "N/A")</MudTd>
                <MudTd DataLabel="Period Type">
                    @if (!string.IsNullOrEmpty(context.PeriodType))
                    {
                        <MudChip T="string" Size="Size.Small">@context.PeriodType</MudChip>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">N/A</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Last Invoice">
                    @if (context.LastInvoiceDateTime.HasValue)
                    {
                        <text>@context.LastInvoiceDateTime.Value.ToString("MM/dd/yyyy")</text>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Never</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Expected Next">
                    @if (context.ExpectedNextDateTime.HasValue)
                    {
                        <text>@context.ExpectedNextDateTime.Value.ToString("MM/dd/yyyy")</text>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">N/A</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Days Overdue">
                    @{
                        var daysOverdue = CalculateDaysOverdue(context);
                        if (daysOverdue > 0)
                        {
                            <MudChip T="string" Size="Size.Small" Color="@GetOverdueColor(daysOverdue)">
                                @daysOverdue days
                            </MudChip>
                        }
                        else
                        {
                            <MudText Typo="Typo.body2" Color="Color.Secondary">N/A</MudText>
                        }
                    }
                </MudTd>
                <MudTd DataLabel="Actions">
                    <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small">
                        <MudMenuItem Icon="@Icons.Material.Filled.Visibility" OnClick="() => ViewAccountDetails(context)">View Details</MudMenuItem>
                        <MudMenuItem Icon="@Icons.Material.Filled.Work" OnClick="() => ViewJobs(context.Id)">View Jobs</MudMenuItem>
                    </MudMenu>
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText Align="Align.Center" Class="my-8">
                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Large" Color="Color.Success" Class="mb-2" />
                    <MudText Typo="Typo.h6">No Missing Accounts</MudText>
                    <MudText Typo="Typo.body2" Class="mb-4">
                        All accounts are receiving invoices within their expected billing cycles.
                    </MudText>
                </MudText>
            </NoRecordsContent>
            <PagerContent>
                <MudTablePager PageSizeOptions="new int[] { 20, 50, 100 }" />
            </PagerContent>
        </MudTable>
    }
</MudPaper>

@code {
    private MudTable<AdrAccount> _table = null!;
    private List<Client> _clients = new();
    private bool _loading = true;
    private string? _searchTerm;
    private Client? _selectedClient;
    private int? _filterClientId;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _clients = await ClientService.GetClientsAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading clients: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task<TableData<AdrAccount>> ServerReload(TableState state, CancellationToken cancellationToken)
    {
        _loading = true;
        try
        {
            var pageNumber = state.Page + 1;
            var pageSize = state.PageSize;

            var result = await AdrService.GetAccountsPagedAsync(
                pageNumber,
                pageSize,
                _filterClientId,
                _searchTerm,
                null,
                "Missing");

            return new TableData<AdrAccount>
            {
                Items = result.Items,
                TotalItems = result.TotalCount
            };
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading missing accounts: {ex.Message}", Severity.Error);
            return new TableData<AdrAccount> { Items = new List<AdrAccount>(), TotalItems = 0 };
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task<IEnumerable<Client>> SearchClients(string value, CancellationToken cancellationToken)
    {
        if (string.IsNullOrEmpty(value))
            return _clients;

        return _clients.Where(c => c.ClientName.Contains(value, StringComparison.OrdinalIgnoreCase));
    }

    private async Task ApplyFilters()
    {
        _filterClientId = _selectedClient?.Id;
        await _table.ReloadServerData();
    }

    private async Task ClearFilters()
    {
        _searchTerm = null;
        _selectedClient = null;
        _filterClientId = null;
        await _table.ReloadServerData();
    }

    private async Task ExportReport()
    {
        Snackbar.Add("Export functionality coming soon", Severity.Info);
    }

    private int CalculateDaysOverdue(AdrAccount account)
    {
        if (!account.ExpectedNextDateTime.HasValue)
            return 0;

        var daysOverdue = (DateTime.UtcNow - account.ExpectedNextDateTime.Value).Days;
        return daysOverdue > 0 ? daysOverdue : 0;
    }

    private Color GetOverdueColor(int daysOverdue) => daysOverdue switch
    {
        > 60 => Color.Error,
        > 30 => Color.Warning,
        _ => Color.Info
    };

    private async Task ViewAccountDetails(AdrAccount account)
    {
        var parameters = new DialogParameters<AccountDetailsDialog>
        {
            { x => x.Account, account }
        };
        var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true };
        await DialogService.ShowAsync<AccountDetailsDialog>("Account Details", parameters, options);
    }

    private void ViewJobs(int accountId)
    {
        Navigation.NavigateTo($"/adr/jobs?accountId={accountId}");
    }
}
