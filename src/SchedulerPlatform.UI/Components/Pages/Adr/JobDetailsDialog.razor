@using SchedulerPlatform.UI.Models
@using SchedulerPlatform.UI.Services
@inject AuthenticatedHttpClientService HttpService

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Work" Class="mr-2" />
            Job Details
        </MudText>
    </TitleContent>
    <DialogContent>
        @if (Job != null)
        {
            <MudGrid>
                <MudItem xs="12">
                    <MudText Typo="Typo.subtitle1" Class="mb-2"><strong>Job Information</strong></MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Job ID</MudText>
                    <MudText Typo="Typo.body1">@Job.Id</MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Account ID</MudText>
                    <MudText Typo="Typo.body1">@Job.AdrAccountId</MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">VM Account ID</MudText>
                    <MudText Typo="Typo.body1">@Job.VMAccountId</MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Account Number</MudText>
                    <MudText Typo="Typo.body1">@Job.VMAccountNumber</MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Credential ID</MudText>
                    <MudText Typo="Typo.body1">@Job.CredentialId</MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Period Type</MudText>
                    <MudText Typo="Typo.body1">@(Job.PeriodType ?? "N/A")</MudText>
                </MudItem>

                <MudItem xs="12">
                    <MudDivider Class="my-2" />
                    <MudText Typo="Typo.subtitle1" Class="mb-2"><strong>Billing Period</strong></MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Start Date</MudText>
                    <MudText Typo="Typo.body1">@Job.BillingPeriodStartDateTime.ToString("MM/dd/yyyy")</MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">End Date</MudText>
                    <MudText Typo="Typo.body1">@Job.BillingPeriodEndDateTime.ToString("MM/dd/yyyy")</MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Next Run Date</MudText>
                    <MudText Typo="Typo.body1">@(Job.NextRunDateTime?.ToString("MM/dd/yyyy") ?? "N/A")</MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Is Missing</MudText>
                    <MudText Typo="Typo.body1">@(Job.IsMissing ? "Yes" : "No")</MudText>
                </MudItem>

                <MudItem xs="12">
                    <MudDivider Class="my-2" />
                    <MudText Typo="Typo.subtitle1" Class="mb-2"><strong>Status</strong></MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Job Status</MudText>
                    <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(Job.Status)">
                        @Job.Status
                    </MudChip>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Retry Count</MudText>
                    <MudText Typo="Typo.body1">@Job.RetryCount</MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">ADR Status ID</MudText>
                    <MudText Typo="Typo.body1">@(Job.AdrStatusId?.ToString() ?? "N/A")</MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">ADR Status Description</MudText>
                    <MudText Typo="Typo.body1">@(Job.AdrStatusDescription ?? "N/A")</MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">ADR Index ID</MudText>
                    <MudText Typo="Typo.body1">@(Job.AdrIndexId?.ToString() ?? "N/A")</MudText>
                </MudItem>

                <MudItem xs="12">
                    <MudDivider Class="my-2" />
                    <MudText Typo="Typo.subtitle1" Class="mb-2"><strong>Timestamps</strong></MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Credential Verified</MudText>
                    <MudText Typo="Typo.body1">@(Job.CredentialVerifiedDateTime?.ToString("MM/dd/yyyy HH:mm") ?? "N/A")</MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Scraping Completed</MudText>
                    <MudText Typo="Typo.body1">@(Job.ScrapingCompletedDateTime?.ToString("MM/dd/yyyy HH:mm") ?? "N/A")</MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Created</MudText>
                    <MudText Typo="Typo.body1">@Job.CreatedDateTime.ToString("MM/dd/yyyy HH:mm")</MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Modified</MudText>
                    <MudText Typo="Typo.body1">@(Job.ModifiedDateTime?.ToString("MM/dd/yyyy HH:mm") ?? "N/A")</MudText>
                </MudItem>

                @if (!string.IsNullOrEmpty(Job.ErrorMessage))
                {
                    <MudItem xs="12">
                        <MudDivider Class="my-2" />
                        <MudText Typo="Typo.subtitle1" Class="mb-2"><strong>Error</strong></MudText>
                    </MudItem>
                    <MudItem xs="12">
                        <MudAlert Severity="Severity.Error">@Job.ErrorMessage</MudAlert>
                    </MudItem>
                }

                <MudItem xs="12">
                    <MudDivider Class="my-2" />
                    <MudText Typo="Typo.subtitle1" Class="mb-2">
                        <strong>Latest Execution</strong>
                        @if (_loadingExecutions)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="ml-2" />
                        }
                    </MudText>
                </MudItem>

                @if (_latestExecution != null)
                {
                    <MudItem xs="6">
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Execution ID</MudText>
                        <MudText Typo="Typo.body1">@_latestExecution.Id</MudText>
                    </MudItem>
                    <MudItem xs="6">
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Request Type</MudText>
                        <MudText Typo="Typo.body1">@GetRequestTypeName(_latestExecution.AdrRequestTypeId)</MudText>
                    </MudItem>
                    <MudItem xs="6">
                        <MudText Typo="Typo.body2" Color="Color.Secondary">HTTP Status</MudText>
                        <MudText Typo="Typo.body1">@(_latestExecution.HttpStatusCode?.ToString() ?? "N/A")</MudText>
                    </MudItem>
                    <MudItem xs="6">
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Start Time</MudText>
                        <MudText Typo="Typo.body1">@_latestExecution.StartDateTime.ToString("MM/dd/yyyy HH:mm:ss")</MudText>
                    </MudItem>

                    @if (!string.IsNullOrEmpty(_latestExecution.RequestPayload))
                    {
                        <MudItem xs="12">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Request Payload</MudText>
                            <MudPaper Class="pa-2 mt-1" Style="background-color: #f5f5f5; max-height: 200px; overflow-y: auto;">
                                <MudText Typo="Typo.body2" Style="white-space: pre-wrap; font-family: monospace; font-size: 0.75rem;">@FormatJson(_latestExecution.RequestPayload)</MudText>
                            </MudPaper>
                        </MudItem>
                    }

                    @if (!string.IsNullOrEmpty(_latestExecution.ApiResponse))
                    {
                        <MudItem xs="12">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">API Response</MudText>
                            <MudPaper Class="pa-2 mt-1" Style="background-color: #f5f5f5; max-height: 200px; overflow-y: auto;">
                                <MudText Typo="Typo.body2" Style="white-space: pre-wrap; font-family: monospace; font-size: 0.75rem;">@FormatJson(_latestExecution.ApiResponse)</MudText>
                            </MudPaper>
                        </MudItem>
                    }

                    @if (!string.IsNullOrEmpty(_latestExecution.ErrorMessage))
                    {
                        <MudItem xs="12">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Execution Error</MudText>
                            <MudAlert Severity="Severity.Error" Dense="true">@_latestExecution.ErrorMessage</MudAlert>
                        </MudItem>
                    }
                }
                else if (!_loadingExecutions)
                {
                    <MudItem xs="12">
                        <MudText Typo="Typo.body2" Color="Color.Secondary">No executions found for this job.</MudText>
                    </MudItem>
                }
            </MudGrid>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] 
    private IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public AdrJob? Job { get; set; }

    private AdrJobExecution? _latestExecution;
    private bool _loadingExecutions = true;

    protected override async Task OnInitializedAsync()
    {
        if (Job != null)
        {
            await LoadLatestExecutionAsync();
        }
    }

    private async Task LoadLatestExecutionAsync()
    {
        try
        {
            _loadingExecutions = true;
            var response = await HttpService.GetAsync($"api/adr/executions/by-job/{Job!.Id}");
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                var executions = System.Text.Json.JsonSerializer.Deserialize<List<AdrJobExecution>>(content, new System.Text.Json.JsonSerializerOptions 
                { 
                    PropertyNameCaseInsensitive = true 
                });
                _latestExecution = executions?.OrderByDescending(e => e.StartDateTime).FirstOrDefault();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading executions: {ex.Message}");
        }
        finally
        {
            _loadingExecutions = false;
        }
    }

    private void Cancel() => MudDialog.Cancel();

    private Color GetStatusColor(string status) => status switch
    {
        "Pending" => Color.Default,
        "CredentialVerified" => Color.Info,
        "CredentialFailed" => Color.Error,
        "ScrapeRequested" => Color.Warning,
        "ScrapeFailed" => Color.Error,
        "Completed" => Color.Success,
        "NeedsReview" => Color.Warning,
        _ => Color.Default
    };

    private string GetRequestTypeName(int? requestTypeId) => requestTypeId switch
    {
        1 => "Credential Check",
        2 => "ADR Request",
        _ => requestTypeId?.ToString() ?? "Unknown"
    };

    private string FormatJson(string? json)
    {
        if (string.IsNullOrEmpty(json))
            return string.Empty;

        try
        {
            var obj = System.Text.Json.JsonSerializer.Deserialize<object>(json);
            return System.Text.Json.JsonSerializer.Serialize(obj, new System.Text.Json.JsonSerializerOptions 
            { 
                WriteIndented = true 
            });
        }
        catch
        {
            return json;
        }
    }
}
