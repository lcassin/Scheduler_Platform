@page "/adr/rules"
@using SchedulerPlatform.UI.Services
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject AuthenticatedHttpClientService HttpClientService
@inject IAdrService AdrService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IPermissionService PermissionService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<PageTitle>ADR Account Rules</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <div class="d-flex justify-space-between align-center mb-4">
        <MudText Typo="Typo.h4">ADR Account Rules</MudText>
    </div>

    <MudPaper Class="pa-4 mb-4">
        <MudGrid Spacing="2">
            <MudItem xs="12" md="2">
                <MudAutocomplete T="string" 
                                 Label="Master Vendor Code" 
                                 @bind-Value="_searchMasterVendorCode"
                                 SearchFunc="SearchMasterVendors"
                                 Variant="Variant.Outlined" 
                                 Margin="Margin.Dense" 
                                 Clearable="true"
                                 ResetValueOnEmptyText="true"
                                 CoerceValue="true"
                                 Placeholder="Type to search..."
                                 AdornmentIcon="@Icons.Material.Filled.Business"
                                 AdornmentColor="Color.Primary" />
            </MudItem>
            <MudItem xs="12" md="2">
                <MudAutocomplete T="string" 
                                 Label="Primary Vendor Code" 
                                 @bind-Value="_searchPrimaryVendorCode"
                                 SearchFunc="SearchPrimaryVendors"
                                 Variant="Variant.Outlined" 
                                 Margin="Margin.Dense" 
                                 Clearable="true"
                                 ResetValueOnEmptyText="true"
                                 CoerceValue="true"
                                 Placeholder="Type to search..."
                                 AdornmentIcon="@Icons.Material.Filled.Store"
                                 AdornmentColor="Color.Primary" />
            </MudItem>
            <MudItem xs="12" md="2">
                <MudTextField @bind-Value="_searchAccountNumber" 
                              Label="Account Number" 
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense"
                              Immediate="true"
                              Adornment="Adornment.End"
                              AdornmentIcon="@Icons.Material.Filled.Search" />
            </MudItem>
            <MudItem xs="12" md="1">
                <MudSelect @bind-Value="_filterEnabled" 
                           Label="Status" 
                           Variant="Variant.Outlined"
                           Margin="Margin.Dense">
                    <MudSelectItem Value="@((bool?)null)">All</MudSelectItem>
                    <MudSelectItem Value="@((bool?)true)">Enabled</MudSelectItem>
                    <MudSelectItem Value="@((bool?)false)">Disabled</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="1">
                <MudSelect @bind-Value="_filterOverridden" 
                           Label="Override" 
                           Variant="Variant.Outlined"
                           Margin="Margin.Dense">
                    <MudSelectItem Value="@((bool?)null)">All</MudSelectItem>
                    <MudSelectItem Value="@((bool?)true)">Overridden</MudSelectItem>
                    <MudSelectItem Value="@((bool?)false)">Not Overridden</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="4" Class="d-flex align-center justify-end gap-2">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ApplyFilters" StartIcon="@Icons.Material.Filled.FilterAlt">
                    Apply
                </MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="ClearFilters" StartIcon="@Icons.Material.Filled.Clear">
                    Clear
                </MudButton>
                @if (_isExporting)
                {
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary" Disabled="true">
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                        Exporting...
                    </MudButton>
                }
                else
                {
                    <MudMenu AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.TopLeft">
                        <ActivatorContent>
                            <MudButton Variant="Variant.Outlined" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Download">
                                Export
                            </MudButton>
                        </ActivatorContent>
                        <ChildContent>
                            <MudMenuItem OnClick="@(() => ExportRules("excel"))">Excel</MudMenuItem>
                            <MudMenuItem OnClick="@(() => ExportRules("csv"))">CSV</MudMenuItem>
                        </ChildContent>
                    </MudMenu>
                }
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (_loading && _table == null)
    {
        <MudProgressCircular Indeterminate="true" />
    }
    else
    {
        <MudTable T="AccountRuleModel" ServerData="@ServerReload" 
                  @ref="_table" Hover="true" Striped="true" Dense="true">
            <HeaderContent>
                <MudTh><MudTableSortLabel SortLabel="MasterVendorCode" T="AccountRuleModel">Master Vendor Code</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortLabel="PrimaryVendorCode" T="AccountRuleModel">Primary Vendor Code</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortLabel="VMAccountNumber" T="AccountRuleModel">Account Number</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortLabel="JobTypeId" T="AccountRuleModel">Job Type</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortLabel="PeriodType" T="AccountRuleModel">Period Type</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortLabel="NextRunDateTime" T="AccountRuleModel" InitialDirection="SortDirection.Ascending">Next Run</MudTableSortLabel></MudTh>
                <MudTh>Search Window</MudTh>
                <MudTh><MudTableSortLabel SortLabel="IsEnabled" T="AccountRuleModel">Status</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortLabel="IsManuallyOverridden" T="AccountRuleModel">Override</MudTableSortLabel></MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Master Vendor Code">@context.MasterVendorCode</MudTd>
                <MudTd DataLabel="Primary Vendor Code">@context.PrimaryVendorCode</MudTd>
                <MudTd DataLabel="Account Number">@context.VMAccountNumber</MudTd>
                <MudTd DataLabel="Job Type">
                    <MudChip T="string" Size="Size.Small" Color="@GetJobTypeColor(context.JobTypeId)">
                        @GetJobTypeName(context.JobTypeId)
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="Period Type">@context.PeriodType</MudTd>
                <MudTd DataLabel="Next Run">
                    @if (context.NextRunDateTime.HasValue)
                    {
                        <MudText Typo="Typo.body2">@context.NextRunDateTime.Value.ToLocalTime().ToString("MM/dd/yyyy")</MudText>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Default">Not scheduled</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Search Window">
                    @if (context.NextRangeStartDateTime.HasValue && context.NextRangeEndDateTime.HasValue)
                    {
                        <MudText Typo="Typo.body2">
                            @context.NextRangeStartDateTime.Value.ToLocalTime().ToString("MM/dd") - 
                            @context.NextRangeEndDateTime.Value.ToLocalTime().ToString("MM/dd")
                        </MudText>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Default">N/A</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Status">
                    @if (context.IsEnabled)
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Success">Enabled</MudChip>
                    }
                    else
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Default">Disabled</MudChip>
                    }
                </MudTd>
                <MudTd DataLabel="Override">
                    @if (context.IsManuallyOverridden)
                    {
                        <MudTooltip Text="@($"Overridden by {context.OverriddenBy} on {context.OverriddenDateTime?.ToLocalTime().ToString("g")}")">
                            <MudIcon Icon="@Icons.Material.Filled.Edit" Color="Color.Warning" Size="Size.Small" />
                        </MudTooltip>
                    }
                </MudTd>
                <MudTd DataLabel="Actions">
                    <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small" Dense="true">
                        <MudMenuItem Icon="@Icons.Material.Filled.Edit" 
                                     OnClick="@(() => EditRule(context))">
                            Edit Rule
                        </MudMenuItem>
                        @if (context.IsManuallyOverridden)
                        {
                            <MudMenuItem Icon="@Icons.Material.Filled.Refresh" 
                                         OnClick="@(() => ClearOverride(context))">
                                Clear Override
                            </MudMenuItem>
                        }
                        <MudMenuItem Icon="@Icons.Material.Filled.Visibility" 
                                     OnClick="@(() => ViewAccount(context.AdrAccountId))">
                            View Account
                        </MudMenuItem>
                    </MudMenu>
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText>No rules found matching your criteria.</MudText>
            </NoRecordsContent>
            <PagerContent>
                <MudTablePager PageSizeOptions="new int[] { 50, 100, 200 }" />
            </PagerContent>
        </MudTable>
    }
</MudContainer>

@code {
    private MudTable<AccountRuleModel>? _table;
    private bool _loading = true;
    private bool _isExporting = false;
    
    private string? _searchMasterVendorCode;
    private string? _searchPrimaryVendorCode;
    private string? _searchAccountNumber;
    private bool? _filterEnabled = true;
    private bool? _filterOverridden;

    protected override void OnInitialized()
    {
        _loading = false;
    }

    private async Task<TableData<AccountRuleModel>> ServerReload(TableState state, CancellationToken cancellationToken)
    {
        _loading = true;
        try
        {
            var pageNumber = state.Page + 1;
            var pageSize = state.PageSize;

            var sortDescending = state.SortDirection == SortDirection.Descending;
            var sortColumn = string.IsNullOrEmpty(state.SortLabel) ? "PrimaryVendorCode" : state.SortLabel;

            var queryParams = new List<string>
            {
                $"page={pageNumber}",
                $"pageSize={pageSize}",
                $"sortColumn={sortColumn}",
                $"sortDescending={sortDescending}"
            };
            
            if (!string.IsNullOrWhiteSpace(_searchMasterVendorCode))
                queryParams.Add($"masterVendorCode={Uri.EscapeDataString(_searchMasterVendorCode)}");
            if (!string.IsNullOrWhiteSpace(_searchPrimaryVendorCode))
                queryParams.Add($"vendorCode={Uri.EscapeDataString(_searchPrimaryVendorCode)}");
            if (!string.IsNullOrWhiteSpace(_searchAccountNumber))
                queryParams.Add($"accountNumber={Uri.EscapeDataString(_searchAccountNumber)}");
            if (_filterEnabled.HasValue)
                queryParams.Add($"isEnabled={_filterEnabled.Value}");
            if (_filterOverridden.HasValue)
                queryParams.Add($"isOverridden={_filterOverridden.Value}");
            
            var url = $"adr/rules?{string.Join("&", queryParams)}";
            var httpResponse = await HttpClientService.GetAsync(url);
            httpResponse.EnsureSuccessStatusCode();
            var response = await httpResponse.Content.ReadFromJsonAsync<RulesPagedResponse>(cancellationToken);
            
            if (response != null)
            {
                return new TableData<AccountRuleModel>
                {
                    Items = response.Items ?? new List<AccountRuleModel>(),
                    TotalItems = response.TotalCount
                };
            }
            
            return new TableData<AccountRuleModel> { Items = new List<AccountRuleModel>(), TotalItems = 0 };
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading rules: {ex.Message}", Severity.Error);
            return new TableData<AccountRuleModel> { Items = new List<AccountRuleModel>(), TotalItems = 0 };
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task ApplyFilters()
    {
        if (_table != null)
        {
            await _table.ReloadServerData();
        }
    }

    private async Task ClearFilters()
    {
        _searchMasterVendorCode = null;
        _searchPrimaryVendorCode = null;
        _searchAccountNumber = null;
        _filterEnabled = true;
        _filterOverridden = null;
        if (_table != null)
        {
            await _table.ReloadServerData();
        }
    }

    private void ViewAccount(int accountId)
    {
        NavigationManager.NavigateTo($"/adr/accounts?accountId={accountId}");
    }

    private async Task EditRule(AccountRuleModel rule)
    {
        var parameters = new DialogParameters<EditRuleDialog>
        {
            { x => x.RuleId, rule.Id }
        };
        var options = new DialogOptions 
        { 
            MaxWidth = MaxWidth.Medium, 
            FullWidth = true,
            CloseOnEscapeKey = true
        };
        var dialog = await DialogService.ShowAsync<EditRuleDialog>("Edit Rule", parameters, options);
        var result = await dialog.Result;
        
        if (result != null && !result.Canceled)
        {
            if (_table != null)
            {
                await _table.ReloadServerData();
            }
        }
    }

    private async Task ClearOverride(AccountRuleModel rule)
    {
        var confirmed = await DialogService.ShowMessageBox(
            "Clear Override",
            $"Are you sure you want to clear the manual override for this rule? The rule will be updated by the next account sync.",
            yesText: "Clear Override",
            cancelText: "Cancel");
        
        if (confirmed == true)
        {
            try
            {
                var response = await HttpClientService.PostAsync($"adr/rules/{rule.Id}/clear-override");
                response.EnsureSuccessStatusCode();
                Snackbar.Add("Override cleared successfully", Severity.Success);
                if (_table != null)
                {
                    await _table.ReloadServerData();
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error clearing override: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task ExportRules(string format)
    {
        _isExporting = true;
        StateHasChanged();
        try
        {
            // Build filters dictionary from current filter state
            var filters = new Dictionary<string, string?>();
            if (!string.IsNullOrWhiteSpace(_searchMasterVendorCode))
                filters["masterVendorCode"] = _searchMasterVendorCode;
            if (!string.IsNullOrWhiteSpace(_searchPrimaryVendorCode))
                filters["vendorCode"] = _searchPrimaryVendorCode;
            if (!string.IsNullOrWhiteSpace(_searchAccountNumber))
                filters["accountNumber"] = _searchAccountNumber;
            if (_filterEnabled.HasValue)
                filters["isEnabled"] = _filterEnabled.Value.ToString();
            if (_filterOverridden.HasValue)
                filters["isOverridden"] = _filterOverridden.Value.ToString();

            // Start background export
            Snackbar.Add("Starting export... This may take a few minutes for large datasets.", Severity.Info);
            var startResult = await AdrService.StartBackgroundExportAsync("rules", format, filters);
            
            if (string.IsNullOrEmpty(startResult.RequestId))
            {
                Snackbar.Add("Failed to start export", Severity.Error);
                return;
            }

            // Poll for completion
            var maxAttempts = 120; // 10 minutes max (5 second intervals)
            var attempt = 0;
            while (attempt < maxAttempts)
            {
                await Task.Delay(5000); // Wait 5 seconds between polls
                attempt++;

                var status = await AdrService.GetBackgroundExportStatusAsync(startResult.RequestId);
                if (status == null)
                {
                    Snackbar.Add("Export status not found", Severity.Error);
                    return;
                }

                if (status.Status == "Completed")
                {
                    // Download the file
                    var bytes = await AdrService.DownloadBackgroundExportAsync(startResult.RequestId);
                    if (bytes == null || bytes.Length == 0)
                    {
                        Snackbar.Add("Failed to download export file", Severity.Error);
                        return;
                    }

                    var contentType = status.ContentType ?? (format.Equals("excel", StringComparison.OrdinalIgnoreCase)
                        ? "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                        : "text/csv");

                    var filename = status.FileName ?? $"adr_rules_{DateTime.UtcNow:yyyyMMddHHmmss}.{(format.Equals("excel", StringComparison.OrdinalIgnoreCase) ? "xlsx" : "csv")}";

                    var base64 = Convert.ToBase64String(bytes);
                    await JSRuntime.InvokeVoidAsync("downloadFile", filename, contentType, base64);

                    Snackbar.Add($"Export downloaded: {filename} ({status.TotalRecords:N0} records)", Severity.Success);
                    return;
                }
                else if (status.Status == "Failed")
                {
                    Snackbar.Add($"Export failed: {status.ErrorMessage}", Severity.Error);
                    return;
                }
                else if (status.Status == "Processing" && attempt % 6 == 0) // Update every 30 seconds
                {
                    Snackbar.Add($"Export in progress... {status.ProcessedRecords:N0} of {status.TotalRecords:N0} records processed", Severity.Info);
                    StateHasChanged();
                }
            }

            Snackbar.Add("Export timed out. Please try again later.", Severity.Warning);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Export failed: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isExporting = false;
            StateHasChanged();
        }
    }

    private async Task<IEnumerable<string>> SearchPrimaryVendors(string value, CancellationToken cancellationToken)
    {
        if (string.IsNullOrEmpty(value))
            return new List<string>();

        try
        {
            return await AdrService.GetPrimaryVendorCodesAsync(value, 50);
        }
        catch
        {
            return new List<string>();
        }
    }

    private async Task<IEnumerable<string>> SearchMasterVendors(string value, CancellationToken cancellationToken)
    {
        if (string.IsNullOrEmpty(value))
            return new List<string>();

        try
        {
            return await AdrService.GetMasterVendorCodesAsync(value, 50);
        }
        catch
        {
            return new List<string>();
        }
    }

    private string GetJobTypeName(int jobTypeId)
    {
        return jobTypeId switch
        {
            1 => "Credential Check",
            2 => "Download Invoice",
            3 => "Rebill Check",
            _ => $"Type {jobTypeId}"
        };
    }

    private Color GetJobTypeColor(int jobTypeId)
    {
        return jobTypeId switch
        {
            1 => Color.Info,
            2 => Color.Primary,
            3 => Color.Tertiary,
            _ => Color.Default
        };
    }

    private class AccountRuleModel
    {
        public int Id { get; set; }
        public int AdrAccountId { get; set; }
        public string? MasterVendorCode { get; set; }
        public string? PrimaryVendorCode { get; set; }
        public string? VMAccountNumber { get; set; }
        public int JobTypeId { get; set; }
        public string? PeriodType { get; set; }
        public int? PeriodDays { get; set; }
        public DateTime? NextRunDateTime { get; set; }
        public DateTime? NextRangeStartDateTime { get; set; }
        public DateTime? NextRangeEndDateTime { get; set; }
        public bool IsEnabled { get; set; }
        public bool IsManuallyOverridden { get; set; }
        public string? OverriddenBy { get; set; }
        public DateTime? OverriddenDateTime { get; set; }
    }

    private class RulesPagedResponse
    {
        public List<AccountRuleModel>? Items { get; set; }
        public int TotalCount { get; set; }
        public int Page { get; set; }
        public int PageSize { get; set; }
    }
}
