@page "/adr/rules"
@using SchedulerPlatform.UI.Services
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject IHttpClientFactory HttpClientFactory
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IPermissionService PermissionService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<PageTitle>ADR Account Rules</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <div class="d-flex justify-space-between align-center mb-4">
        <MudText Typo="Typo.h4">ADR Account Rules</MudText>
    </div>

    <MudPaper Class="pa-4 mb-4">
        <MudGrid Spacing="2">
            <MudItem xs="12" md="2">
                <MudTextField @bind-Value="_searchVendorCode" 
                              Label="Vendor Code" 
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense"
                              Immediate="true"
                              Adornment="Adornment.End"
                              AdornmentIcon="@Icons.Material.Filled.Search" />
            </MudItem>
            <MudItem xs="12" md="2">
                <MudTextField @bind-Value="_searchAccountNumber" 
                              Label="Account Number" 
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense"
                              Immediate="true"
                              Adornment="Adornment.End"
                              AdornmentIcon="@Icons.Material.Filled.Search" />
            </MudItem>
            <MudItem xs="12" md="2">
                <MudSelect @bind-Value="_filterEnabled" 
                           Label="Status" 
                           Variant="Variant.Outlined"
                           Margin="Margin.Dense">
                    <MudSelectItem Value="@((bool?)null)">All</MudSelectItem>
                    <MudSelectItem Value="@((bool?)true)">Enabled</MudSelectItem>
                    <MudSelectItem Value="@((bool?)false)">Disabled</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="2">
                <MudSelect @bind-Value="_filterOverridden" 
                           Label="Override" 
                           Variant="Variant.Outlined"
                           Margin="Margin.Dense">
                    <MudSelectItem Value="@((bool?)null)">All</MudSelectItem>
                    <MudSelectItem Value="@((bool?)true)">Overridden</MudSelectItem>
                    <MudSelectItem Value="@((bool?)false)">Not Overridden</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="4" Class="d-flex align-center justify-end gap-2">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadRules" StartIcon="@Icons.Material.Filled.FilterAlt">
                    Apply
                </MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="@(() => ExportRules("excel"))" StartIcon="@Icons.Material.Filled.Download" Disabled="@_isExporting">
                    Export
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (_loading)
    {
        <MudProgressCircular Indeterminate="true" />
    }
    else
    {
        <MudTable Items="@_rules" 
                  Hover="true" 
                  Striped="true"
                  Dense="true"
                  Loading="@_loading"
                  LoadingProgressColor="Color.Primary">
            <HeaderContent>
                <MudTh>Vendor Code</MudTh>
                <MudTh>Account Number</MudTh>
                <MudTh>Job Type</MudTh>
                <MudTh>Period Type</MudTh>
                <MudTh>Next Run</MudTh>
                <MudTh>Search Window</MudTh>
                <MudTh>Status</MudTh>
                <MudTh>Override</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Vendor Code">@context.VendorCode</MudTd>
                <MudTd DataLabel="Account Number">@context.VMAccountNumber</MudTd>
                <MudTd DataLabel="Job Type">
                    <MudChip T="string" Size="Size.Small" Color="@GetJobTypeColor(context.JobTypeId)">
                        @GetJobTypeName(context.JobTypeId)
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="Period Type">@context.PeriodType</MudTd>
                <MudTd DataLabel="Next Run">
                    @if (context.NextRunDateTime.HasValue)
                    {
                        <MudText Typo="Typo.body2">@context.NextRunDateTime.Value.ToLocalTime().ToString("MM/dd/yyyy")</MudText>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Default">Not scheduled</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Search Window">
                    @if (context.NextRangeStartDateTime.HasValue && context.NextRangeEndDateTime.HasValue)
                    {
                        <MudText Typo="Typo.body2">
                            @context.NextRangeStartDateTime.Value.ToLocalTime().ToString("MM/dd") - 
                            @context.NextRangeEndDateTime.Value.ToLocalTime().ToString("MM/dd")
                        </MudText>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Default">N/A</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Status">
                    @if (context.IsEnabled)
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Success">Enabled</MudChip>
                    }
                    else
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Default">Disabled</MudChip>
                    }
                </MudTd>
                <MudTd DataLabel="Override">
                    @if (context.IsManuallyOverridden)
                    {
                        <MudTooltip Text="@($"Overridden by {context.OverriddenBy} on {context.OverriddenDateTime?.ToLocalTime().ToString("g")}")">
                            <MudIcon Icon="@Icons.Material.Filled.Edit" Color="Color.Warning" Size="Size.Small" />
                        </MudTooltip>
                    }
                </MudTd>
                <MudTd DataLabel="Actions">
                    <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small" Dense="true">
                        <MudMenuItem Icon="@Icons.Material.Filled.Edit" 
                                     OnClick="@(() => EditRule(context))">
                            Edit Rule
                        </MudMenuItem>
                        @if (context.IsManuallyOverridden)
                        {
                            <MudMenuItem Icon="@Icons.Material.Filled.Refresh" 
                                         OnClick="@(() => ClearOverride(context))">
                                Clear Override
                            </MudMenuItem>
                        }
                        <MudMenuItem Icon="@Icons.Material.Filled.Visibility" 
                                     OnClick="@(() => ViewAccount(context.AdrAccountId))">
                            View Account
                        </MudMenuItem>
                    </MudMenu>
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText>No rules found matching your criteria.</MudText>
            </NoRecordsContent>
        </MudTable>
        
        <div class="d-flex justify-center mt-4">
            <MudPagination Count="@_totalPages" 
                           Selected="@_currentPage" 
                           SelectedChanged="OnPageChanged"
                           Color="Color.Primary" />
        </div>
    }
</MudContainer>

@code {
    private List<AccountRuleModel> _rules = new();
    private bool _loading = true;
    private bool _isExporting = false;
    
    private string? _searchVendorCode;
    private string? _searchAccountNumber;
    private bool? _filterEnabled = true;
    private bool? _filterOverridden;
    
    private int _currentPage = 1;
    private int _totalPages = 1;
    private int _pageSize = 20;

    protected override async Task OnInitializedAsync()
    {
        await LoadRules();
    }

    private HttpClient CreateClient() => HttpClientFactory.CreateClient("SchedulerAPI");

    private async Task LoadRules()
    {
        _loading = true;
        try
        {
            var queryParams = new List<string>
            {
                $"page={_currentPage}",
                $"pageSize={_pageSize}"
            };
            
            if (!string.IsNullOrWhiteSpace(_searchVendorCode))
                queryParams.Add($"vendorCode={Uri.EscapeDataString(_searchVendorCode)}");
            if (!string.IsNullOrWhiteSpace(_searchAccountNumber))
                queryParams.Add($"accountNumber={Uri.EscapeDataString(_searchAccountNumber)}");
            if (_filterEnabled.HasValue)
                queryParams.Add($"isEnabled={_filterEnabled.Value}");
            if (_filterOverridden.HasValue)
                queryParams.Add($"isOverridden={_filterOverridden.Value}");
            
            var url = $"adr/rules?{string.Join("&", queryParams)}";
            var client = CreateClient();
            var response = await client.GetFromJsonAsync<RulesPagedResponse>(url);
            
            if (response != null)
            {
                _rules = response.Items ?? new List<AccountRuleModel>();
                _totalPages = (int)Math.Ceiling((double)response.TotalCount / _pageSize);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading rules: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task ClearFilters()
    {
        _searchVendorCode = null;
        _searchAccountNumber = null;
        _filterEnabled = true;
        _filterOverridden = null;
        _currentPage = 1;
        await LoadRules();
    }

    private async Task OnPageChanged(int page)
    {
        _currentPage = page;
        await LoadRules();
    }

    private void ViewAccount(int accountId)
    {
        NavigationManager.NavigateTo($"/adr/accounts?accountId={accountId}");
    }

    private async Task EditRule(AccountRuleModel rule)
    {
        var parameters = new DialogParameters<EditRuleDialog>
        {
            { x => x.RuleId, rule.Id }
        };
        var options = new DialogOptions 
        { 
            MaxWidth = MaxWidth.Medium, 
            FullWidth = true,
            CloseOnEscapeKey = true
        };
        var dialog = await DialogService.ShowAsync<EditRuleDialog>("Edit Rule", parameters, options);
        var result = await dialog.Result;
        
        if (result != null && !result.Canceled)
        {
            await LoadRules();
        }
    }

    private async Task ClearOverride(AccountRuleModel rule)
    {
        var confirmed = await DialogService.ShowMessageBox(
            "Clear Override",
            $"Are you sure you want to clear the manual override for this rule? The rule will be updated by the next account sync.",
            yesText: "Clear Override",
            cancelText: "Cancel");
        
        if (confirmed == true)
        {
            try
            {
                var client = CreateClient();
                var response = await client.PostAsync($"adr/rules/{rule.Id}/clear-override", null);
                response.EnsureSuccessStatusCode();
                Snackbar.Add("Override cleared successfully", Severity.Success);
                await LoadRules();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error clearing override: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task ExportRules(string format)
    {
        _isExporting = true;
        StateHasChanged();
        try
        {
            var client = CreateClient();
            var queryParams = new List<string> { $"format={format}" };
            
            if (!string.IsNullOrWhiteSpace(_searchVendorCode))
                queryParams.Add($"vendorCode={Uri.EscapeDataString(_searchVendorCode)}");
            if (!string.IsNullOrWhiteSpace(_searchAccountNumber))
                queryParams.Add($"accountNumber={Uri.EscapeDataString(_searchAccountNumber)}");
            if (_filterEnabled.HasValue)
                queryParams.Add($"isEnabled={_filterEnabled.Value}");
            if (_filterOverridden.HasValue)
                queryParams.Add($"isOverridden={_filterOverridden.Value}");
            
            var url = $"adr/rules/export?{string.Join("&", queryParams)}";
            var response = await client.GetAsync(url);
            response.EnsureSuccessStatusCode();
            var bytes = await response.Content.ReadAsByteArrayAsync();

            var contentType = format.Equals("excel", StringComparison.OrdinalIgnoreCase)
                ? "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                : "text/csv";

            var filename = $"adr_rules_{DateTime.UtcNow:yyyyMMddHHmmss}.{(format.Equals("excel", StringComparison.OrdinalIgnoreCase) ? "xlsx" : "csv")}";

            var base64 = Convert.ToBase64String(bytes);
            await JSRuntime.InvokeVoidAsync("downloadFile", filename, contentType, base64);

            Snackbar.Add($"Export downloaded: {filename}", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Export failed: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isExporting = false;
        }
    }

    private string GetJobTypeName(int jobTypeId)
    {
        return jobTypeId switch
        {
            1 => "Credential Check",
            2 => "Download Invoice",
            _ => $"Type {jobTypeId}"
        };
    }

    private Color GetJobTypeColor(int jobTypeId)
    {
        return jobTypeId switch
        {
            1 => Color.Info,
            2 => Color.Primary,
            _ => Color.Default
        };
    }

    private class AccountRuleModel
    {
        public int Id { get; set; }
        public int AdrAccountId { get; set; }
        public string? VendorCode { get; set; }
        public string? VMAccountNumber { get; set; }
        public int JobTypeId { get; set; }
        public string? PeriodType { get; set; }
        public int? PeriodDays { get; set; }
        public DateTime? NextRunDateTime { get; set; }
        public DateTime? NextRangeStartDateTime { get; set; }
        public DateTime? NextRangeEndDateTime { get; set; }
        public bool IsEnabled { get; set; }
        public bool IsManuallyOverridden { get; set; }
        public string? OverriddenBy { get; set; }
        public DateTime? OverriddenDateTime { get; set; }
    }

    private class RulesPagedResponse
    {
        public List<AccountRuleModel>? Items { get; set; }
        public int TotalCount { get; set; }
        public int Page { get; set; }
        public int PageSize { get; set; }
    }
}
