@page "/adr/jobs"
@rendermode InteractiveServer
@attribute [Authorize]
@inject IAdrService AdrService
@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime

<PageTitle>ADR Jobs</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">ADR Jobs</MudText>

<MudPaper Class="pa-4">
        <MudGrid Class="mb-4" Spacing="2">
            <MudItem xs="12" md="2">
                <MudTextField @bind-Value="_searchVendorCode" 
                              Label="Vendor Code" 
                              Placeholder="Enter vendor code"
                              Variant="Variant.Outlined" 
                              Margin="Margin.Dense" 
                              Clearable="true"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Business" />
            </MudItem>
            <MudItem xs="12" md="2">
                <MudTextField @bind-Value="_searchAccountNumber" 
                              Label="Account Number" 
                              Placeholder="Enter account #"
                              Variant="Variant.Outlined" 
                              Margin="Margin.Dense" 
                              Clearable="true"
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Search" />
            </MudItem>
            <MudItem xs="12" md="2">
                <MudSelect T="string" @bind-Value="_selectedStatus" Label="Status" Variant="Variant.Outlined" Margin="Margin.Dense" Clearable="true">
                    <MudSelectItem Value="@("")">All</MudSelectItem>
                    <MudSelectItem Value="@("Pending")">Pending</MudSelectItem>
                    <MudSelectItem Value="@("CredentialVerified")">Credential Verified</MudSelectItem>
                    <MudSelectItem Value="@("CredentialFailed")">Credential Failed</MudSelectItem>
                    <MudSelectItem Value="@("ScrapeRequested")">Scrape Requested</MudSelectItem>
                    <MudSelectItem Value="@("ScrapeFailed")">Scrape Failed</MudSelectItem>
                    <MudSelectItem Value="@("Completed")">Completed</MudSelectItem>
                    <MudSelectItem Value="@("NeedsReview")">Needs Review</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="2" Class="d-flex align-center">
                <MudSwitch @bind-Value="_showLatestPerAccount" Color="Color.Primary" Label="Latest per Account" />
            </MudItem>
            <MudItem xs="12" md="4" Class="d-flex align-center justify-end gap-2">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ApplyFilters" StartIcon="@Icons.Material.Filled.FilterAlt">
                    Apply
                </MudButton>
                <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="ClearFilters" StartIcon="@Icons.Material.Filled.Clear">
                    Clear
                </MudButton>
                @if (_isExporting)
                {
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary" Disabled="true">
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                        Exporting...
                    </MudButton>
                }
                else
                {
                    <MudMenu AnchorOrigin="Origin.BottomLeft" TransformOrigin="Origin.TopLeft">
                        <ActivatorContent>
                            <MudButton Variant="Variant.Outlined" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Download">
                                Export
                            </MudButton>
                        </ActivatorContent>
                        <ChildContent>
                            <MudMenuItem OnClick="@(() => ExportJobs("excel"))">Excel</MudMenuItem>
                            <MudMenuItem OnClick="@(() => ExportJobs("csv"))">CSV</MudMenuItem>
                        </ChildContent>
                    </MudMenu>
                }
            </MudItem>
        </MudGrid>

        <MudTable T="AdrJob" ServerData="@ServerReload" 
                  @ref="_table" Hover="true" Breakpoint="Breakpoint.Sm" Dense="true"
                  Loading="@_loading" LoadingProgressColor="Color.Primary">
                        <HeaderContent>
                            <MudTh><MudTableSortLabel SortLabel="Id" T="AdrJob" InitialDirection="SortDirection.Descending">Job ID</MudTableSortLabel></MudTh>
                            <MudTh><MudTableSortLabel SortLabel="VendorCode" T="AdrJob">Vendor</MudTableSortLabel></MudTh>
                            <MudTh><MudTableSortLabel SortLabel="VMAccountNumber" T="AdrJob">Account #</MudTableSortLabel></MudTh>
                            <MudTh><MudTableSortLabel SortLabel="BillingPeriodStartDateTime" T="AdrJob">Billing Period</MudTableSortLabel></MudTh>
                            <MudTh><MudTableSortLabel SortLabel="PeriodType" T="AdrJob">Period Type</MudTableSortLabel></MudTh>
                            <MudTh><MudTableSortLabel SortLabel="NextRunDateTime" T="AdrJob">Next Run</MudTableSortLabel></MudTh>
                            <MudTh><MudTableSortLabel SortLabel="Status" T="AdrJob">Status</MudTableSortLabel></MudTh>
                            <MudTh><MudTableSortLabel SortLabel="AdrStatusId" T="AdrJob">ADR Status</MudTableSortLabel></MudTh>
                            <MudTh><MudTableSortLabel SortLabel="RetryCount" T="AdrJob">Retry Count</MudTableSortLabel></MudTh>
                            <MudTh>Actions</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Job ID">@context.Id</MudTd>
                            <MudTd DataLabel="Vendor">
                                @if (!string.IsNullOrEmpty(context.VendorCode))
                                {
                                    <MudChip T="string" Size="Size.Small" Color="Color.Primary">@context.VendorCode</MudChip>
                                }
                                else
                                {
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">N/A</MudText>
                                }
                            </MudTd>
                            <MudTd DataLabel="Account #">
                                <MudText Typo="Typo.body2"><strong>@context.VMAccountNumber</strong></MudText>
                            </MudTd>
                <MudTd DataLabel="Billing Period">
                    <MudText Typo="Typo.body2">@context.BillingPeriodStartDateTime.ToString("MM/dd/yy") - @context.BillingPeriodEndDateTime.ToString("MM/dd/yy")</MudText>
                </MudTd>
                <MudTd DataLabel="Period Type">
                    @if (!string.IsNullOrEmpty(context.PeriodType))
                    {
                        <MudChip T="string" Size="Size.Small">@context.PeriodType</MudChip>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">N/A</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Next Run">
                    @if (context.NextRunDateTime.HasValue)
                    {
                        <text>@context.NextRunDateTime.Value.ToString("MM/dd/yyyy")</text>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">N/A</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Status">
                    <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context.Status)">
                        @context.Status
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="ADR Status">
                    @if (context.AdrStatusId.HasValue)
                    {
                        <MudTooltip Text="@(context.AdrStatusDescription ?? "")">
                            <MudChip T="string" Size="Size.Small" Color="@GetAdrStatusColor(context.AdrStatusId.Value)">
                                @context.AdrStatusId
                            </MudChip>
                        </MudTooltip>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">N/A</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Retry Count">@context.RetryCount</MudTd>
                                <MudTd DataLabel="Actions">
                                    <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small">
                                        <MudMenuItem Icon="@Icons.Material.Filled.Visibility" OnClick="() => ViewJobDetails(context)">View Details</MudMenuItem>
                                        @if (_showLatestPerAccount)
                                        {
                                            <MudMenuItem Icon="@Icons.Material.Filled.List" OnClick="() => ViewJobHistory(context)">View Job History</MudMenuItem>
                                        }
                                        <MudMenuItem Icon="@Icons.Material.Filled.AccountBalance" OnClick="() => ViewAccount(context)">View Account</MudMenuItem>
                                    </MudMenu>
                                </MudTd>
            </RowTemplate>
                        <NoRecordsContent>
                            <MudText Align="Align.Center" Class="my-8">
                                <MudIcon Icon="@Icons.Material.Filled.Work" Size="Size.Large" Class="mb-2" />
                                <MudText Typo="Typo.h6">No jobs found</MudText>
                                <MudText Typo="Typo.body2" Class="mb-4">
                                    @if (!string.IsNullOrEmpty(_filterVendorCode) || !string.IsNullOrEmpty(_filterAccountNumber) || !string.IsNullOrEmpty(_filterStatus))
                                    {
                                        <span>Try adjusting your filters.</span>
                                    }
                                    else
                                    {
                                        <span>No ADR jobs have been created yet. Jobs are created automatically when accounts are due for processing.</span>
                                    }
                                </MudText>
                            </MudText>
                        </NoRecordsContent>
            <PagerContent>
                <MudTablePager PageSizeOptions="new int[] { 20, 50, 100 }" />
            </PagerContent>
        </MudTable>
</MudPaper>

@code {
    private MudTable<AdrJob> _table = null!;
    private bool _loading = true;
    private bool _isExporting = false;
    private string? _searchVendorCode;
    private string? _searchAccountNumber;
    private string _selectedStatus = "";
    private string? _filterVendorCode;
    private string? _filterAccountNumber;
    private string? _filterStatus;
    private bool _showLatestPerAccount = true;

    [Parameter]
    [SupplyParameterFromQuery(Name = "vendorCode")]
    public string? VendorCodeParam { get; set; }

    [Parameter]
    [SupplyParameterFromQuery(Name = "accountNumber")]
    public string? AccountNumberParam { get; set; }

    protected override void OnInitialized()
    {
        if (!string.IsNullOrEmpty(VendorCodeParam))
        {
            _searchVendorCode = VendorCodeParam;
            _filterVendorCode = VendorCodeParam;
        }
        if (!string.IsNullOrEmpty(AccountNumberParam))
        {
            _searchAccountNumber = AccountNumberParam;
            _filterAccountNumber = AccountNumberParam;
        }
        _loading = false;
    }

    private async Task<TableData<AdrJob>> ServerReload(TableState state, CancellationToken cancellationToken)
    {
        _loading = true;
        try
        {
            var pageNumber = state.Page + 1;
            var pageSize = state.PageSize;

            var result = await AdrService.GetJobsPagedAsync(
                pageNumber,
                pageSize,
                null, // adrAccountId - no longer used for filtering
                _filterStatus,
                _filterVendorCode,
                _filterAccountNumber,
                _showLatestPerAccount);

            // Apply sorting
            var sortedItems = ApplySorting(result.Items, state.SortLabel, state.SortDirection);

            return new TableData<AdrJob>
            {
                Items = sortedItems,
                TotalItems = result.TotalCount
            };
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading jobs: {ex.Message}", Severity.Error);
            return new TableData<AdrJob> { Items = new List<AdrJob>(), TotalItems = 0 };
        }
        finally
        {
            _loading = false;
        }
    }

    private List<AdrJob> ApplySorting(List<AdrJob> items, string? sortLabel, SortDirection sortDirection)
    {
        if (string.IsNullOrEmpty(sortLabel))
        {
            // Default sort: Job ID descending (most recent first)
            return items.OrderByDescending(j => j.Id).ToList();
        }

        var isDescending = sortDirection == SortDirection.Descending;

        return sortLabel switch
        {
            "Id" => isDescending 
                ? items.OrderByDescending(j => j.Id).ToList() 
                : items.OrderBy(j => j.Id).ToList(),
            "VendorCode" => isDescending 
                ? items.OrderByDescending(j => j.VendorCode ?? "").ToList() 
                : items.OrderBy(j => j.VendorCode ?? "").ToList(),
            "VMAccountNumber" => isDescending 
                ? items.OrderByDescending(j => j.VMAccountNumber ?? "").ToList() 
                : items.OrderBy(j => j.VMAccountNumber ?? "").ToList(),
            "BillingPeriodStartDateTime" => isDescending 
                ? items.OrderByDescending(j => j.BillingPeriodStartDateTime).ToList() 
                : items.OrderBy(j => j.BillingPeriodStartDateTime).ToList(),
            "PeriodType" => isDescending 
                ? items.OrderByDescending(j => j.PeriodType ?? "").ToList() 
                : items.OrderBy(j => j.PeriodType ?? "").ToList(),
            "NextRunDateTime" => isDescending 
                ? items.OrderByDescending(j => j.NextRunDateTime ?? DateTime.MinValue).ToList() 
                : items.OrderBy(j => j.NextRunDateTime ?? DateTime.MaxValue).ToList(),
            "Status" => isDescending 
                ? items.OrderByDescending(j => j.Status ?? "").ToList() 
                : items.OrderBy(j => j.Status ?? "").ToList(),
            "AdrStatusId" => isDescending 
                ? items.OrderByDescending(j => j.AdrStatusId ?? 0).ToList() 
                : items.OrderBy(j => j.AdrStatusId ?? int.MaxValue).ToList(),
            "RetryCount" => isDescending 
                ? items.OrderByDescending(j => j.RetryCount).ToList() 
                : items.OrderBy(j => j.RetryCount).ToList(),
            _ => items.OrderByDescending(j => j.Id).ToList()
        };
    }

    private async Task ApplyFilters()
    {
        _filterVendorCode = string.IsNullOrWhiteSpace(_searchVendorCode) ? null : _searchVendorCode;
        _filterAccountNumber = string.IsNullOrWhiteSpace(_searchAccountNumber) ? null : _searchAccountNumber;
        _filterStatus = string.IsNullOrEmpty(_selectedStatus) ? null : _selectedStatus;
        await _table.ReloadServerData();
    }

    private async Task ClearFilters()
    {
        _searchVendorCode = null;
        _searchAccountNumber = null;
        _selectedStatus = "";
        _filterVendorCode = null;
        _filterAccountNumber = null;
        _filterStatus = null;
        Navigation.NavigateTo("/adr/jobs");
        await _table.ReloadServerData();
    }

    private Color GetStatusColor(string status) => status switch
    {
        "Pending" => Color.Default,
        "CredentialVerified" => Color.Info,
        "CredentialFailed" => Color.Error,
        "ScrapeRequested" => Color.Warning,
        "ScrapeFailed" => Color.Error,
        "Completed" => Color.Success,
        "NeedsReview" => Color.Warning,
        _ => Color.Default
    };

    private Color GetAdrStatusColor(int statusId) => statusId switch
    {
        11 => Color.Success, // Complete
        9 => Color.Warning,  // Needs Human Review
        3 or 4 or 5 or 7 or 8 => Color.Error, // Error statuses
        _ => Color.Info
    };

    private async Task ViewJobDetails(AdrJob job)
    {
        var parameters = new DialogParameters<JobDetailsDialog>
        {
            { x => x.Job, job }
        };
        var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true };
        await DialogService.ShowAsync<JobDetailsDialog>("Job Details", parameters, options);
    }

    private void ViewAccount(AdrJob job)
    {
        // Navigate to Accounts page with account number filter (searchTerm searches by account number)
        Navigation.NavigateTo($"/adr/accounts?accountNumber={Uri.EscapeDataString(job.VMAccountNumber ?? "")}");
    }

    private void ViewJobHistory(AdrJob job)
    {
        // Turn off "Latest per Account" mode and filter by the specific account's account number
        // VendorCode filter is only applied if it's not null/empty to avoid filtering issues
        _showLatestPerAccount = false;
        _searchAccountNumber = job.VMAccountNumber;
        _filterAccountNumber = job.VMAccountNumber;
        
        if (!string.IsNullOrWhiteSpace(job.VendorCode))
        {
            _searchVendorCode = job.VendorCode;
            _filterVendorCode = job.VendorCode;
        }
        else
        {
            _searchVendorCode = null;
            _filterVendorCode = null;
        }
        
        _table.ReloadServerData();
    }

    private async Task ExportJobs(string format)
    {
        _isExporting = true;
        StateHasChanged();
        try
        {
            var bytes = await AdrService.DownloadJobsExportAsync(
                _filterStatus,
                _filterVendorCode,
                _filterAccountNumber,
                _showLatestPerAccount,
                format);

            var contentType = format.Equals("excel", StringComparison.OrdinalIgnoreCase)
                ? "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                : "text/csv";

            var filename = $"adr_jobs_{DateTime.UtcNow:yyyyMMddHHmmss}.{(format.Equals("excel", StringComparison.OrdinalIgnoreCase) ? "xlsx" : "csv")}";

            var base64 = Convert.ToBase64String(bytes);
            await JSRuntime.InvokeVoidAsync("downloadFile", filename, contentType, base64);

            Snackbar.Add($"Export downloaded: {filename}", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Export failed: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isExporting = false;
        }
    }
}
