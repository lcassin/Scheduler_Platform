@using SchedulerPlatform.UI.Models
@using SchedulerPlatform.UI.Services
@inject IAdrService AdrService

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.AccountBalance" Class="mr-2" />
            Account Details
        </MudText>
    </TitleContent>
    <DialogContent>
        @if (Account != null)
        {
            <MudGrid>
                <MudItem xs="12">
                    <MudText Typo="Typo.subtitle1" Class="mb-2"><strong>Account Information</strong></MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">VM Account ID</MudText>
                    <MudText Typo="Typo.body1">@Account.VMAccountId</MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Account Number</MudText>
                    <MudText Typo="Typo.body1">@Account.VMAccountNumber</MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Interface Account ID</MudText>
                    <MudText Typo="Typo.body1">@(Account.InterfaceAccountId ?? "N/A")</MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Credential ID</MudText>
                    <MudText Typo="Typo.body1">@Account.CredentialId</MudText>
                </MudItem>

                <MudItem xs="12">
                    <MudDivider Class="my-2" />
                    <MudText Typo="Typo.subtitle1" Class="mb-2"><strong>Client & Vendor</strong></MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Client</MudText>
                    <MudText Typo="Typo.body1">@(Account.ClientName ?? "N/A")</MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Vendor Code</MudText>
                    <MudText Typo="Typo.body1">@(Account.VendorCode ?? "N/A")</MudText>
                </MudItem>

                <MudItem xs="12">
                    <MudDivider Class="my-2" />
                    <MudText Typo="Typo.subtitle1" Class="mb-2"><strong>Billing Pattern</strong></MudText>
                </MudItem>
                <MudItem xs="4">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Period Type</MudText>
                    <MudText Typo="Typo.body1">@(Account.PeriodType ?? "N/A")</MudText>
                </MudItem>
                <MudItem xs="4">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Period Days</MudText>
                    <MudText Typo="Typo.body1">@(Account.PeriodDays?.ToString() ?? "N/A")</MudText>
                </MudItem>
                <MudItem xs="4">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Median Days</MudText>
                    <MudText Typo="Typo.body1">@(Account.MedianDays?.ToString("F1") ?? "N/A")</MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Invoice Count</MudText>
                    <MudText Typo="Typo.body1">@(Account.InvoiceCount?.ToString() ?? "N/A")</MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Last Invoice Date</MudText>
                    <MudText Typo="Typo.body1">@(Account.LastInvoiceDateTime?.ToString("MM/dd/yyyy") ?? "N/A")</MudText>
                </MudItem>

                <MudItem xs="12">
                    <MudDivider Class="my-2" />
                    <MudText Typo="Typo.subtitle1" Class="mb-2"><strong>Schedule Information</strong></MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Next Run Date</MudText>
                    <MudText Typo="Typo.body1">@(Account.NextRunDateTime?.ToString("MM/dd/yyyy") ?? "N/A")</MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Days Until Next Run</MudText>
                    <MudText Typo="Typo.body1">@(Account.DaysUntilNextRun?.ToString() ?? "N/A")</MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Next Range Start</MudText>
                    <MudText Typo="Typo.body1">@(Account.NextRangeStartDateTime?.ToString("MM/dd/yyyy") ?? "N/A")</MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Next Range End</MudText>
                    <MudText Typo="Typo.body1">@(Account.NextRangeEndDateTime?.ToString("MM/dd/yyyy") ?? "N/A")</MudText>
                </MudItem>

                <MudItem xs="12">
                    <MudDivider Class="my-2" />
                    <MudText Typo="Typo.subtitle1" Class="mb-2"><strong>Status</strong></MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Next Run Status</MudText>
                    @if (!string.IsNullOrEmpty(Account.NextRunStatus))
                    {
                        <MudChip T="string" Size="Size.Small" Color="@GetNextRunStatusColor(Account.NextRunStatus)">
                            @Account.NextRunStatus
                        </MudChip>
                    }
                    else
                    {
                        <MudText Typo="Typo.body1">N/A</MudText>
                    }
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Historical Billing Status</MudText>
                    @if (!string.IsNullOrEmpty(Account.HistoricalBillingStatus))
                    {
                        <MudChip T="string" Size="Size.Small" Color="@GetHistoricalStatusColor(Account.HistoricalBillingStatus)">
                            @Account.HistoricalBillingStatus
                        </MudChip>
                    }
                    else
                    {
                        <MudText Typo="Typo.body1">N/A</MudText>
                    }
                </MudItem>

                <MudItem xs="12">
                    <MudDivider Class="my-2" />
                    <MudText Typo="Typo.subtitle1" Class="mb-2"><strong>Account Rules</strong></MudText>
                </MudItem>
                @if (_loadingRules)
                {
                    <MudItem xs="12">
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                        <MudText Typo="Typo.body2" Style="display: inline;">Loading rules...</MudText>
                    </MudItem>
                }
                else if (_rules != null && _rules.Any())
                {
                    @foreach (var rule in _rules)
                    {
                        <MudItem xs="6">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Next Run Date</MudText>
                            <MudText Typo="Typo.body1">@(rule.NextRunDateTime?.ToString("MM/dd/yyyy") ?? "N/A")</MudText>
                        </MudItem>
                        <MudItem xs="6">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Period Type / Days</MudText>
                            <MudText Typo="Typo.body1">@(rule.PeriodType ?? "N/A") / @(rule.PeriodDays?.ToString() ?? "N/A")</MudText>
                        </MudItem>
                        <MudItem xs="6">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Search Window</MudText>
                            <MudText Typo="Typo.body1">@(rule.NextRangeStartDateTime?.ToString("MM/dd/yyyy") ?? "N/A") - @(rule.NextRangeEndDateTime?.ToString("MM/dd/yyyy") ?? "N/A")</MudText>
                        </MudItem>
                        <MudItem xs="6">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Enabled</MudText>
                            <MudChip T="string" Size="Size.Small" Color="@(rule.IsEnabled ? Color.Success : Color.Default)">
                                @(rule.IsEnabled ? "Yes" : "No")
                            </MudChip>
                        </MudItem>
                        @if (rule.IsManuallyOverridden)
                        {
                            <MudItem xs="12">
                                <MudAlert Severity="Severity.Warning" Dense="true" Class="mt-1">
                                    Rule manually overridden by @rule.OverriddenBy on @(rule.OverriddenDateTime?.ToString("MM/dd/yyyy HH:mm") ?? "N/A")
                                </MudAlert>
                            </MudItem>
                        }
                    }
                }
                else
                {
                    <MudItem xs="12">
                        <MudText Typo="Typo.body2" Color="Color.Secondary">No rules found for this account</MudText>
                    </MudItem>
                }

                <MudItem xs="12">
                    <MudDivider Class="my-2" />
                    <MudText Typo="Typo.subtitle1" Class="mb-2"><strong>Current Job Status</strong></MudText>
                </MudItem>
                @if (_loadingJob)
                {
                    <MudItem xs="12">
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                        <MudText Typo="Typo.body2" Style="display: inline;">Loading job information...</MudText>
                    </MudItem>
                }
                else if (_latestJob != null)
                {
                    <MudItem xs="6">
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Job Status</MudText>
                        <MudChip T="string" Size="Size.Small" Color="@GetJobStatusColor(_latestJob.Status)">
                            @GetJobStatusDisplayName(_latestJob.Status)
                        </MudChip>
                    </MudItem>
                    <MudItem xs="6">
                        <MudText Typo="Typo.body2" Color="Color.Secondary">ADR Status</MudText>
                        <MudText Typo="Typo.body1">@(_latestJob.AdrStatusDescription ?? "Awaiting insert")</MudText>
                    </MudItem>
                    <MudItem xs="6">
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Billing Period</MudText>
                        <MudText Typo="Typo.body1">@_latestJob.BillingPeriodStartDateTime.ToString("MM/dd/yyyy") - @_latestJob.BillingPeriodEndDateTime.ToString("MM/dd/yyyy")</MudText>
                    </MudItem>
                    <MudItem xs="6">
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Last Completed</MudText>
                        <MudText Typo="Typo.body1">@(_latestJob.ScrapingCompletedDateTime?.ToString("MM/dd/yyyy HH:mm") ?? "N/A")</MudText>
                    </MudItem>
                    @if (!string.IsNullOrEmpty(_latestJob.ErrorMessage))
                    {
                        <MudItem xs="12">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Error/Failure Reason</MudText>
                            <MudAlert Severity="Severity.Error" Dense="true" Class="mt-1">@_latestJob.ErrorMessage</MudAlert>
                        </MudItem>
                    }
                    else if (_latestJob.Status == "Failed" || _latestJob.Status == "NeedsReview")
                    {
                        <MudItem xs="12">
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Failure Reason</MudText>
                            <MudAlert Severity="@(_latestJob.Status == "Failed" ? Severity.Error : Severity.Warning)" Dense="true" Class="mt-1">
                                @(_latestJob.AdrStatusDescription ?? "Unknown reason")
                            </MudAlert>
                        </MudItem>
                    }
                }
                else
                {
                    <MudItem xs="12">
                        <MudText Typo="Typo.body2" Color="Color.Secondary">No jobs found for this account</MudText>
                    </MudItem>
                }

                <MudItem xs="12">
                    <MudDivider Class="my-2" />
                    <MudText Typo="Typo.subtitle1" Class="mb-2"><strong>Sync Information</strong></MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Last Synced</MudText>
                    <MudText Typo="Typo.body1">@(Account.LastSyncedDateTime?.ToString("MM/dd/yyyy HH:mm") ?? "N/A")</MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Created</MudText>
                    <MudText Typo="Typo.body1">@Account.CreatedDateTime.ToString("MM/dd/yyyy HH:mm")</MudText>
                </MudItem>
            </MudGrid>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] 
    private IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public AdrAccount? Account { get; set; }

    private AdrJob? _latestJob;
    private bool _loadingJob = true;
    private List<AccountRuleDto>? _rules;
    private bool _loadingRules = true;

    protected override async Task OnInitializedAsync()
    {
        if (Account != null)
        {
            // Load jobs and rules in parallel
            var jobsTask = LoadJobsAsync();
            var rulesTask = LoadRulesAsync();
            await Task.WhenAll(jobsTask, rulesTask);
        }
        _loadingJob = false;
        _loadingRules = false;
    }

    private async Task LoadJobsAsync()
    {
        try
        {
            var jobs = await AdrService.GetJobsByAccountAsync(Account!.Id);
            _latestJob = jobs.OrderByDescending(j => j.BillingPeriodStartDateTime).FirstOrDefault();
        }
        catch
        {
            _latestJob = null;
        }
    }

    private async Task LoadRulesAsync()
    {
        try
        {
            _rules = await AdrService.GetRulesByAccountAsync(Account!.Id);
        }
        catch
        {
            _rules = null;
        }
    }

    private void Cancel() => MudDialog.Cancel();

    private Color GetNextRunStatusColor(string status) => status switch
    {
        "Run Now" => Color.Error,
        "Due Soon" => Color.Warning,
        "Upcoming" => Color.Info,
        "Future" => Color.Default,
        _ => Color.Default
    };

    private Color GetHistoricalStatusColor(string status) => status switch
    {
        "Missing" => Color.Error,
        "Overdue" => Color.Warning,
        "Due Now" => Color.Info,
        _ => Color.Default
    };

    private Color GetJobStatusColor(string status) => status switch
    {
        "Completed" => Color.Success,
        "Failed" => Color.Error,
        "NeedsReview" => Color.Warning,
        "ScrapeRequested" => Color.Info,
        "CredentialVerified" => Color.Primary,
        "CredentialFailed" => Color.Error,
        "Pending" => Color.Default,
        _ => Color.Default
    };

    private string GetJobStatusDisplayName(string status) => status switch
    {
        "ScrapeRequested" => "Request Sent",
        "CredentialVerified" => "Credential Verified",
        "CredentialFailed" => "Credential Failed",
        "NeedsReview" => "Needs Review",
        _ => status
    };
}
