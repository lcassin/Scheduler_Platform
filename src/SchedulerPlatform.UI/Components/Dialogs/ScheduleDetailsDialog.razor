@using MudBlazor
@using SchedulerPlatform.Core.Domain.Enums
@using SchedulerPlatform.UI.Models
@using SchedulerPlatform.UI.Services
@inject IUserTimeZoneService TimeZoneService

<MudDialog>
    <DialogContent>
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudText Typo="Typo.subtitle2" Class="mb-1">Schedule ID</MudText>
                <MudText Typo="Typo.body2">@Schedule.Id</MudText>
            </MudItem>
            
            <MudItem xs="12" md="6">
                <MudText Typo="Typo.subtitle2" Class="mb-1">Name</MudText>
                <MudText Typo="Typo.body2"><strong>@Schedule.Name</strong></MudText>
            </MudItem>
            
            <MudItem xs="12">
                <MudText Typo="Typo.subtitle2" Class="mb-1">Description</MudText>
                <MudText Typo="Typo.body2">@(Schedule.Description ?? "N/A")</MudText>
            </MudItem>
            
            <MudItem xs="12" md="6">
                <MudText Typo="Typo.subtitle2" Class="mb-1">Job Type</MudText>
                <MudChip T="string" Size="Size.Small">@Schedule.JobType.ToString()</MudChip>
            </MudItem>
            
            <MudItem xs="12" md="6">
                <MudText Typo="Typo.subtitle2" Class="mb-1">Frequency</MudText>
                <MudText Typo="Typo.body2">@Schedule.Frequency.ToString()</MudText>
            </MudItem>
            
            <MudItem xs="12" md="6">
                <MudText Typo="Typo.subtitle2" Class="mb-1">CRON Expression</MudText>
                <MudText Typo="Typo.body2" Style="font-family: monospace;">@(Schedule.CronExpression ?? "N/A")</MudText>
            </MudItem>
            
            <MudItem xs="12" md="6">
                <MudText Typo="Typo.subtitle2" Class="mb-1">Time Zone</MudText>
                <MudText Typo="Typo.body2">@(Schedule.TimeZone ?? "N/A")</MudText>
            </MudItem>
            
                        <MudItem xs="12" md="6">
                            <MudText Typo="Typo.subtitle2" Class="mb-1">Next Run Time</MudText>
                            <MudText Typo="Typo.body2">
                                @if (Schedule.NextRunDateTime.HasValue)
                                {
                                    <text>@_nextRunFormatted</text>
                                }
                                else
                                {
                                    <text>N/A</text>
                                }
                            </MudText>
                        </MudItem>
            
                        <MudItem xs="12" md="6">
                            <MudText Typo="Typo.subtitle2" Class="mb-1">Last Run Time</MudText>
                            <MudText Typo="Typo.body2">
                                @(Schedule.LastRunDateTime.HasValue ? _lastRunFormatted : "N/A")
                            </MudText>
                        </MudItem>
            
            <MudItem xs="12" md="6">
                <MudText Typo="Typo.subtitle2" Class="mb-1">Status</MudText>
                <MudChip T="string" Size="Size.Small" Color="@(Schedule.IsEnabled ? Color.Success : Color.Default)">
                    @(Schedule.IsEnabled ? "Enabled" : "Disabled")
                </MudChip>
            </MudItem>
            
            <MudItem xs="12" md="6">
                <MudText Typo="Typo.subtitle2" Class="mb-1">Last Run Status</MudText>
                @if (Schedule.LastRunStatus.HasValue)
                {
                    <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(Schedule.LastRunStatus.Value)">
                        @Schedule.LastRunStatus.Value.ToString()
                    </MudChip>
                }
                else
                {
                    <MudText Typo="Typo.body2">N/A</MudText>
                }
            </MudItem>
            
            <MudItem xs="12" md="4">
                <MudText Typo="Typo.subtitle2" Class="mb-1">Max Retries</MudText>
                <MudText Typo="Typo.body2">@Schedule.MaxRetries</MudText>
            </MudItem>
            
            <MudItem xs="12" md="4">
                <MudText Typo="Typo.subtitle2" Class="mb-1">Retry Delay (minutes)</MudText>
                <MudText Typo="Typo.body2">@Schedule.RetryDelayMinutes</MudText>
            </MudItem>
            
            <MudItem xs="12" md="4">
                <MudText Typo="Typo.subtitle2" Class="mb-1">Timeout (minutes)</MudText>
                <MudText Typo="Typo.body2">@(Schedule.TimeoutMinutes?.ToString() ?? "Default (5)")</MudText>
            </MudItem>
            
            @if (!string.IsNullOrWhiteSpace(Schedule.JobDataJson))
            {
                <MudItem xs="12">
                    <MudText Typo="Typo.subtitle2" Class="mb-1">Job Configuration</MudText>
                    <MudPaper Class="pa-2" Style="background-color: #f5f5f5; max-height: 200px; overflow-y: auto;">
                        <MudText Typo="Typo.body2" Style="white-space: pre-wrap; font-family: monospace; font-size: 0.75rem;">@Schedule.JobDataJson</MudText>
                    </MudPaper>
                </MudItem>
            }
            
                        <MudItem xs="12" md="6">
                            <MudText Typo="Typo.subtitle2" Class="mb-1">Created At</MudText>
                            <MudText Typo="Typo.body2">@_createdAtFormatted</MudText>
                        </MudItem>
            
            <MudItem xs="12" md="6">
                <MudText Typo="Typo.subtitle2" Class="mb-1">Created By</MudText>
                <MudText Typo="Typo.body2">@(Schedule.CreatedBy ?? "System")</MudText>
            </MudItem>
            
                        @if (Schedule.ModifiedDateTime.HasValue)
                        {
                            <MudItem xs="12" md="6">
                                <MudText Typo="Typo.subtitle2" Class="mb-1">Updated At</MudText>
                                <MudText Typo="Typo.body2">@_updatedAtFormatted</MudText>
                            </MudItem>
                
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.subtitle2" Class="mb-1">Updated By</MudText>
                    <MudText Typo="Typo.body2">@(Schedule.ModifiedBy ?? "System")</MudText>
                </MudItem>
            }
        </MudGrid>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Close" Color="Color.Primary">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = null!;
    
    [Parameter] public Schedule Schedule { get; set; } = null!;
    
    private string _nextRunFormatted = "";
    private string _lastRunFormatted = "";
    private string _createdAtFormatted = "";
    private string _updatedAtFormatted = "";
    
    protected override async Task OnInitializedAsync()
    {
        if (Schedule.NextRunDateTime.HasValue)
            _nextRunFormatted = await TimeZoneService.FormatDateTimeAsync(Schedule.NextRunDateTime.Value);
        if (Schedule.LastRunDateTime.HasValue)
            _lastRunFormatted = await TimeZoneService.FormatDateTimeAsync(Schedule.LastRunDateTime.Value);
        _createdAtFormatted = await TimeZoneService.FormatDateTimeAsync(Schedule.CreatedDateTime);
        if (Schedule.ModifiedDateTime.HasValue)
            _updatedAtFormatted = await TimeZoneService.FormatDateTimeAsync(Schedule.ModifiedDateTime.Value);
    }
    
    private void Close() => MudDialog.Close();
    
    private Color GetStatusColor(JobStatus status)
    {
        return status switch
        {
            JobStatus.Completed => Color.Success,
            JobStatus.Failed => Color.Error,
            JobStatus.Running => Color.Info,
            JobStatus.Retrying => Color.Warning,
            JobStatus.Cancelled => Color.Default,
            _ => Color.Default
        };
    }
}
