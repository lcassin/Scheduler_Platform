@using SchedulerPlatform.UI.Services
@using SchedulerPlatform.UI.Models
@inject IUserManagementService UserManagementService
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        @if (_loading)
        {
            <MudProgressCircular Indeterminate="true" />
        }
        else if (_user != null)
        {
            @if (_user.IsSystemAdmin)
            {
                <MudAlert Severity="Severity.Warning" Class="mb-4">
                    <strong>Super Administrator</strong><br />
                    This user is a system administrator. Permissions cannot be modified.
                </MudAlert>
            }

            <MudText Typo="Typo.h6" Class="mb-2">@_user.Email</MudText>
            <MudText Typo="Typo.body2" Class="mb-4">@_user.FullName</MudText>

            @if (!_user.IsSystemAdmin)
            {
                <MudAlert Severity="Severity.Info" Class="mb-4">
                    <strong>Current Template:</strong> @GetCurrentTemplate()
                </MudAlert>

                <MudPaper Class="pa-4 mb-4">
                    <MudText Typo="Typo.subtitle1" Class="mb-2">Quick Apply Template</MudText>
                    <MudSelect T="string"
                               Label="Permission Template"
                               @bind-Value="_selectedTemplate"
                               Placeholder="Select a template">
                        @foreach (var template in _templates)
                        {
                            <MudSelectItem Value="@template.Name">
                                <MudText>@template.Name</MudText>
                                <MudText Typo="Typo.caption">@template.Description</MudText>
                            </MudSelectItem>
                        }
                    </MudSelect>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Secondary"
                               Class="mt-2"
                               Disabled="@(string.IsNullOrEmpty(_selectedTemplate))"
                               OnClick="ApplyTemplate">
                        Apply Template
                    </MudButton>
                </MudPaper>

                <MudDivider Class="my-4" />

                <MudText Typo="Typo.subtitle1" Class="mb-3">Custom Permissions</MudText>

                @foreach (var group in _permissionGroupList)
                {
                    <MudPaper Class="pa-3 mb-3" @key="@group.PermissionName">
                        <MudText Typo="Typo.subtitle2" Class="mb-2">@group.PermissionName</MudText>
                        <MudGrid>
                            <MudItem xs="12" sm="2">
                                <MudCheckBox T="bool"
                                             Checked="@group.CanCreate"
                                             CheckedChanged="@((bool b) => group.CanCreate = b)"
                                             Label="Create"
                                             Dense="true" />
                            </MudItem>
                            <MudItem xs="12" sm="2">
                                <MudCheckBox T="bool"
                                             Checked="@group.CanRead"
                                             CheckedChanged="@((bool b) => group.CanRead = b)"
                                             Label="Read"
                                             Dense="true" />
                            </MudItem>
                            <MudItem xs="12" sm="2">
                                <MudCheckBox T="bool"
                                             Checked="@group.CanUpdate"
                                             CheckedChanged="@((bool b) => group.CanUpdate = b)"
                                             Label="Update"
                                             Dense="true" />
                            </MudItem>
                            <MudItem xs="12" sm="2">
                                <MudCheckBox T="bool"
                                             Checked="@group.CanDelete"
                                             CheckedChanged="@((bool b) => group.CanDelete = b)"
                                             Label="Delete"
                                             Dense="true" />
                            </MudItem>
                            <MudItem xs="12" sm="2">
                                <MudCheckBox T="bool"
                                             Checked="@group.CanExecute"
                                             CheckedChanged="@((bool b) => group.CanExecute = b)"
                                             Label="Execute"
                                             Dense="true" />
                            </MudItem>
                        </MudGrid>
                    </MudPaper>
                }
            }
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        @if (_user != null && !_user.IsSystemAdmin)
        {
            <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="SavePermissions">Save</MudButton>
        }
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance? MudDialog { get; set; }
    [Parameter] public int UserId { get; set; }

    private UserDetail? _user;
    private List<PermissionTemplate> _templates = new();
    private string? _selectedTemplate;
    private bool _loading = true;
    private Dictionary<string, PermissionGroup> _permissionGroups = new(StringComparer.OrdinalIgnoreCase);
    private List<PermissionGroup> _permissionGroupList = new();
    private readonly string[] _permissionNames = new[] { "scheduler", "schedules", "jobs", "users", "users:manage" };

    protected override async Task OnInitializedAsync()
    {
        await LoadUser();
        await LoadTemplates();
        _selectedTemplate = GetCurrentTemplate();
        StateHasChanged();
    }

    private async Task LoadUser()
    {
        try
        {
            _loading = true;
            _user = await UserManagementService.GetUserAsync(UserId);

            if (_user != null && !_user.IsSystemAdmin)
            {
                InitializePermissionGroups();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading user: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task LoadTemplates()
    {
        try
        {
            _templates = await UserManagementService.GetPermissionTemplatesAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading templates: {ex.Message}", Severity.Error);
        }
    }

    private void InitializePermissionGroups()
    {
        _permissionGroups.Clear();
        _permissionGroupList.Clear();

        foreach (var name in _permissionNames)
        {
            var existing = _user!.Permissions.FirstOrDefault(p => 
                string.Equals(p.PermissionName, name, StringComparison.OrdinalIgnoreCase));
            
            var group = new PermissionGroup
            {
                PermissionName = name,
                CanCreate = existing?.CanCreate ?? false,
                CanRead = existing?.CanRead ?? false,
                CanUpdate = existing?.CanUpdate ?? false,
                CanDelete = existing?.CanDelete ?? false,
                CanExecute = existing?.CanExecute ?? false
            };
            
            _permissionGroups[name] = group;
            _permissionGroupList.Add(group);
        }

        var debugInfo = string.Join("; ", _permissionGroupList.Select(g => 
            $"{g.PermissionName}: R={g.CanRead} C={g.CanCreate} U={g.CanUpdate} D={g.CanDelete} E={g.CanExecute}"));
        Console.WriteLine($"[DEBUG] Initialized permissions: {debugInfo}");
    }

    private async Task ApplyTemplate()
    {
        if (string.IsNullOrEmpty(_selectedTemplate))
            return;

        var template = _templates.FirstOrDefault(t => t.Name == _selectedTemplate);
        if (template == null)
        {
            Snackbar.Add($"Template '{_selectedTemplate}' not found", Severity.Error);
            return;
        }

        if (template.Permissions == null || !template.Permissions.Any())
        {
            Snackbar.Add($"Template '{_selectedTemplate}' has no permissions defined", Severity.Warning);
            return;
        }

        foreach (var group in _permissionGroups.Values)
        {
            group.CanCreate = false;
            group.CanRead = false;
            group.CanUpdate = false;
            group.CanDelete = false;
            group.CanExecute = false;
        }

        var appliedCount = 0;
        foreach (var perm in template.Permissions)
        {
            if (_permissionGroups.TryGetValue(perm.PermissionName, out var group))
            {
                group.CanCreate = perm.CanCreate;
                group.CanRead = perm.CanRead;
                group.CanUpdate = perm.CanUpdate;
                group.CanDelete = perm.CanDelete;
                group.CanExecute = perm.CanExecute;
                appliedCount++;
            }
        }

        _permissionGroupList = _permissionNames.Select(name => 
        {
            var g = _permissionGroups[name];
            return new PermissionGroup
            {
                PermissionName = g.PermissionName,
                CanCreate = g.CanCreate,
                CanRead = g.CanRead,
                CanUpdate = g.CanUpdate,
                CanDelete = g.CanDelete,
                CanExecute = g.CanExecute
            };
        }).ToList();

        Snackbar.Add($"Template '{_selectedTemplate}' applied ({appliedCount} permissions). Click Save to persist changes.", Severity.Info);
        await InvokeAsync(StateHasChanged);
    }

    private string GetCurrentTemplate()
    {
        if (_user == null || _templates == null || !_templates.Any())
            return "Loading...";

        foreach (var template in _templates)
        {
            if (MatchesTemplate(template))
                return template.Name;
        }

        return "Custom";
    }

    private bool MatchesTemplate(PermissionTemplate template)
    {
        var userPermissions = _user!.Permissions.ToList();
        
        if (userPermissions.Count != template.Permissions.Count)
            return false;

        foreach (var templatePerm in template.Permissions)
        {
            var userPerm = userPermissions.FirstOrDefault(p => p.PermissionName == templatePerm.PermissionName);
            if (userPerm == null)
                return false;

            if (userPerm.CanCreate != templatePerm.CanCreate ||
                userPerm.CanRead != templatePerm.CanRead ||
                userPerm.CanUpdate != templatePerm.CanUpdate ||
                userPerm.CanDelete != templatePerm.CanDelete ||
                userPerm.CanExecute != templatePerm.CanExecute)
                return false;
        }

        return true;
    }

    private async Task SavePermissions()
    {
        try
        {
            var permissions = _permissionGroupList
                .Where(g => g.HasAnyPermission())
                .Select(g => new UserPermissionDto
                {
                    PermissionName = g.PermissionName,
                    CanCreate = g.CanCreate,
                    CanRead = g.CanRead,
                    CanUpdate = g.CanUpdate,
                    CanDelete = g.CanDelete,
                    CanExecute = g.CanExecute
                })
                .ToList();

            await UserManagementService.UpdateUserPermissionsAsync(UserId, permissions);
            Snackbar.Add("Permissions updated successfully", Severity.Success);
            MudDialog?.Close(DialogResult.Ok(true));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving permissions: {ex.Message}", Severity.Error);
        }
    }

    private void Cancel()
    {
        MudDialog?.Cancel();
    }

    private class PermissionGroup
    {
        public string PermissionName { get; set; } = string.Empty;
        public bool CanCreate { get; set; }
        public bool CanRead { get; set; }
        public bool CanUpdate { get; set; }
        public bool CanDelete { get; set; }
        public bool CanExecute { get; set; }

        public bool HasAnyPermission() =>
            CanCreate || CanRead || CanUpdate || CanDelete || CanExecute;
    }
}
