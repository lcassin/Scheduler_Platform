@using SchedulerPlatform.UI.Services
@using SchedulerPlatform.UI.Models
@inject IUserManagementService UserManagementService
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        @if (_loading)
        {
            <MudProgressCircular Indeterminate="true" Class="d-block mx-auto my-4" />
        }
        else
        {
            <MudForm @ref="_form" @bind-IsValid="@_isValid">
                <MudTextField @bind-Value="_email"
                              Label="Email"
                              Required="true"
                              RequiredError="Email is required"
                              Validation="@(new Func<string, string?>(ValidateEmail))"
                              Immediate="true" />

                <MudTextField @bind-Value="_firstName"
                              Label="First Name"
                              Required="true"
                              RequiredError="First name is required"
                              Class="mt-3" />

                <MudTextField @bind-Value="_lastName"
                              Label="Last Name"
                              Required="true"
                              RequiredError="Last name is required"
                              Class="mt-3" />

                <MudSelect T="string" 
                           @bind-Value="_preferredTimeZone"
                           Label="Timezone"
                           Class="mt-3"
                           Placeholder="Select timezone">
                    <MudSelectItem T="string" Value="@((string?)null)">Browser Default</MudSelectItem>
                    @foreach (var tz in _availableTimezones)
                    {
                        <MudSelectItem T="string" Value="@tz.Id">@tz.DisplayName</MudSelectItem>
                    }
                </MudSelect>
            </MudForm>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary"
                   Variant="Variant.Filled"
                   OnClick="SaveChanges"
                   Disabled="@(!_isValid || _saving || _loading)">
            @if (_saving)
            {
                <MudProgressCircular Class="mr-2" Size="Size.Small" Indeterminate="true" />
                <span>Saving...</span>
            }
            else
            {
                <span>Save Changes</span>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    IMudDialogInstance? MudDialog { get; set; }

    [Parameter]
    public int UserId { get; set; }

    private MudForm? _form;
    private bool _isValid;
    private bool _saving;
    private bool _loading = true;

    private string _email = string.Empty;
    private string _firstName = string.Empty;
    private string _lastName = string.Empty;
    private string? _preferredTimeZone;

    private string _originalEmail = string.Empty;
    private string _originalFirstName = string.Empty;
    private string _originalLastName = string.Empty;
    private string? _originalTimeZone;

    private static readonly List<(string Id, string DisplayName)> _availableTimezones = new()
    {
        ("Eastern Standard Time", "Eastern Time (ET)"),
        ("Central Standard Time", "Central Time (CT)"),
        ("Mountain Standard Time", "Mountain Time (MT)"),
        ("US Mountain Standard Time", "Arizona (MST)"),
        ("Pacific Standard Time", "Pacific Time (PT)"),
        ("Alaskan Standard Time", "Alaska Time (AKT)"),
        ("Hawaiian Standard Time", "Hawaii Time (HST)"),
        ("UTC", "UTC")
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadUser();
    }

    private async Task LoadUser()
    {
        try
        {
            _loading = true;
            var user = await UserManagementService.GetUserAsync(UserId);
            if (user != null)
            {
                _email = user.Email;
                _firstName = user.FirstName;
                _lastName = user.LastName;
                _preferredTimeZone = user.PreferredTimeZone;

                _originalEmail = user.Email;
                _originalFirstName = user.FirstName;
                _originalLastName = user.LastName;
                _originalTimeZone = user.PreferredTimeZone;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading user: {ex.Message}", Severity.Error);
            MudDialog?.Cancel();
        }
        finally
        {
            _loading = false;
        }
    }

    private string? ValidateEmail(string email)
    {
        if (string.IsNullOrWhiteSpace(email))
            return "Email is required";

        if (!email.Contains("@") || !email.Contains("."))
            return "Please enter a valid email address";

        return null;
    }

    private async Task SaveChanges()
    {
        if (_form == null || !_isValid)
            return;

        _saving = true;
        try
        {
            // Determine if timezone should be cleared
            bool clearTimezone = _originalTimeZone != null && _preferredTimeZone == null;

            await UserManagementService.UpdateUserDetailsAsync(
                UserId,
                _email.Trim(),
                _firstName.Trim(),
                _lastName.Trim(),
                _preferredTimeZone,
                clearTimezone);
            
            Snackbar.Add("User details updated successfully", Severity.Success);
            MudDialog?.Close(DialogResult.Ok(true));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error updating user: {ex.Message}", Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    private void Cancel()
    {
        MudDialog?.Cancel();
    }
}
