@using Plotly.Blazor
@using Plotly.Blazor.LayoutLib
@using Plotly.Blazor.ConfigLib
@using Plotly.Blazor.Traces
@using Plotly.Blazor.Interop
@inject IJSRuntime JSRuntime

<PlotlyChart @ref="_chart" Data="_data" Layout="_layout" Config="_config" 
             ClickAction="OnChartClick"
             style="@($"width: 100%; height: {Height}; cursor: {(OnSliceClick.HasDelegate ? "pointer" : "default")};")" />

@code {
    [Parameter]
    public double[] Values { get; set; } = Array.Empty<double>();
    
    [Parameter]
    public string[] Labels { get; set; } = Array.Empty<string>();
    
    [Parameter]
    public string[] Colors { get; set; } = Array.Empty<string>();
    
    [Parameter]
    public string[] CustomData { get; set; } = Array.Empty<string>();
    
    [Parameter]
    public string Height { get; set; } = "200px";
    
    [Parameter]
    public bool ShowLegend { get; set; } = true;
    
    [Parameter]
    public string? Title { get; set; }
    
    [Parameter]
    public EventCallback<string> OnSliceClick { get; set; }

    private PlotlyChart? _chart;
    private IList<ITrace> _data = new List<ITrace>();
    private Plotly.Blazor.Layout _layout = new Plotly.Blazor.Layout();
    private Plotly.Blazor.Config _config = new Plotly.Blazor.Config();

    protected override void OnParametersSet()
    {
        Console.WriteLine($"[PlotlyPieChart] OnParametersSet - OnSliceClick.HasDelegate={OnSliceClick.HasDelegate}, Labels={Labels?.Length ?? 0}, Values={Values?.Length ?? 0}");
        BuildChart();
    }

    private void BuildChart()
    {
        var pieTrace = new Pie
        {
            Values = Values.Cast<object>().ToList(),
            Labels = Labels.Cast<object>().ToList(),
            CustomData = CustomData.Any() ? CustomData.Cast<object>().ToList() : null,
            TextInfo = Plotly.Blazor.Traces.PieLib.TextInfoFlag.Percent,
            HoverInfo = Plotly.Blazor.Traces.PieLib.HoverInfoFlag.Label | Plotly.Blazor.Traces.PieLib.HoverInfoFlag.Value | Plotly.Blazor.Traces.PieLib.HoverInfoFlag.Percent,
            Hole = 0m,
            Marker = new Plotly.Blazor.Traces.PieLib.Marker
            {
                Colors = Colors.Any() ? Colors.Cast<object>().ToList() : null
            }
        };

        _data = new List<ITrace> { pieTrace };

        _layout = new Plotly.Blazor.Layout
        {
            Title = !string.IsNullOrEmpty(Title) ? new Plotly.Blazor.LayoutLib.Title { Text = Title } : null,
            ShowLegend = ShowLegend,
            Legend = new List<Legend>
            {
                new Legend
                {
                    Orientation = Plotly.Blazor.LayoutLib.LegendLib.OrientationEnum.V,
                    X = 1.02m,
                    XAnchor = Plotly.Blazor.LayoutLib.LegendLib.XAnchorEnum.Left,
                    Y = 0.5m,
                    YAnchor = Plotly.Blazor.LayoutLib.LegendLib.YAnchorEnum.Middle
                }
            },
            Margin = new Plotly.Blazor.LayoutLib.Margin
            {
                L = 10,
                R = 120,
                T = 10,
                B = 10
            },
            PaperBgColor = "transparent",
            PlotBgColor = "transparent"
        };

        _config = new Plotly.Blazor.Config
        {
            Responsive = true,
            DisplayModeBar = DisplayModeBarEnum.False
        };
    }

    public async Task UpdateAsync()
    {
        if (_chart != null)
        {
            BuildChart();
            await _chart.React();
        }
    }

    private void OnChartClick(IEnumerable<EventDataPoint> eventData)
    {
        Console.WriteLine($"[PlotlyPieChart] OnChartClick FIRED! HasDelegate={OnSliceClick.HasDelegate}, EventData count={eventData?.Count() ?? 0}");
        
        if (!OnSliceClick.HasDelegate)
        {
            Console.WriteLine("[PlotlyPieChart] No delegate attached, returning early");
            return;
        }

        var point = eventData.FirstOrDefault();
        if (point == null)
        {
            Console.WriteLine("[PlotlyPieChart] No point data in event, returning early");
            return;
        }

        // Log all available properties from the EventDataPoint
        Console.WriteLine($"[PlotlyPieChart] Point data - PointNumber: {point.PointNumber} (type: {point.PointNumber?.GetType().Name ?? "null"}), PointIndex: {point.PointIndex} (type: {point.PointIndex?.GetType().Name ?? "null"})");
        Console.WriteLine($"[PlotlyPieChart] Point data - X: {point.X}, Y: {point.Y}, Text: {point.Text}, CurveNumber: {point.CurveNumber}");

        // Get the point index to look up the value from our arrays
        // Handle multiple numeric types that Plotly.Blazor might return (int, long, double, decimal)
        var pointIndex = GetPointIndex(point.PointNumber) ?? GetPointIndex(point.PointIndex) ?? -1;
        Console.WriteLine($"[PlotlyPieChart] Calculated pointIndex: {pointIndex}");
        
        if (pointIndex < 0)
        {
            Console.WriteLine("[PlotlyPieChart] Invalid point index, returning early");
            return;
        }

        // Try to get the custom data first (internal status key), fall back to label
        string clickedValue;
        if (CustomData.Any() && pointIndex < CustomData.Length)
        {
            clickedValue = CustomData[pointIndex];
            Console.WriteLine($"[PlotlyPieChart] Using CustomData value: {clickedValue}");
        }
        else if (pointIndex < Labels.Length)
        {
            clickedValue = Labels[pointIndex];
            Console.WriteLine($"[PlotlyPieChart] Using Labels value: {clickedValue}");
        }
        else
        {
            Console.WriteLine($"[PlotlyPieChart] Index {pointIndex} out of range (CustomData: {CustomData.Length}, Labels: {Labels.Length})");
            return;
        }

        if (!string.IsNullOrEmpty(clickedValue))
        {
            Console.WriteLine($"[PlotlyPieChart] Invoking OnSliceClick with value: {clickedValue}");
            OnSliceClick.InvokeAsync(clickedValue);
        }
    }

    private int? GetPointIndex(object? value)
    {
        if (value == null)
            return null;
        
        // Handle various numeric types that Plotly.Blazor might return
        return value switch
        {
            int i => i,
            long l => (int)l,
            double d => (int)d,
            decimal dec => (int)dec,
            float f => (int)f,
            _ => null
        };
    }
}
