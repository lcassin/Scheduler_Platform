flowchart TB
    subgraph "Daily Orchestration - What Happens Each Day"
        Start([Orchestration Starts]) --> Step1
        
        Step1[1. Sync Accounts<br/>Import updates from source system] --> Step2
        
        Step2[2. Create Jobs<br/>For accounts where NextRunDate is due] --> Step2Q{Account due?}
        Step2Q -->|Yes| Step2A[Create job for billing period]
        Step2Q -->|No| Step2B[Skip - not due yet]
        
        Step2A --> Step3
        Step2B --> Step3
        
        Step3[3. Process Rebill<br/>Weekly check for updated/partial invoices] --> Step3Q{Rebill day matches today?}
        Step3Q -->|Yes| Step3A[Send rebill request<br/>IsLastAttempt flag set if final try]
        Step3Q -->|No| Step3B[Skip - not this account's rebill day]
        
        Step3A --> Step4
        Step3B --> Step4
        
        Step4[4. Check Statuses<br/>Check results from yesterday's ADR requests] --> Step4Q{Invoice Found?}
        Step4Q -->|Yes| Step4A[Mark Job Complete<br/>Advance to next billing cycle]
        Step4Q -->|No| Step4B[Job stays in queue<br/>Will retry today]
        
        Step4A --> Step5
        Step4B --> Step5
        
        Step5[5. Send ADR Requests<br/>For jobs where today >= Next Run Date] --> Step5Q{Within billing window?}
        Step5Q -->|Yes| Step5A[Send request to retrieve invoice]
        Step5Q -->|No - Past window| Step5B[Mark as Needs Review]
        
        Step5A --> End([Orchestration Complete])
        Step5B --> End
    end
    
    style Start fill:#4CAF50,color:white
    style End fill:#4CAF50,color:white
    style Step1 fill:#e3f2fd
    style Step2 fill:#fff3e0
    style Step3 fill:#f3e5f5
    style Step4 fill:#fce4ec
    style Step5 fill:#e8f5e9
