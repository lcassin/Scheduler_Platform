flowchart TB
    subgraph "ADR Orchestration Process"
        Start([Start Orchestration]) --> Step1
        
        subgraph Step1["Step 1: Sync Accounts"]
            S1A[Query VendorCredNewUAT Database] --> S1B[Analyze Billing Patterns]
            S1B --> S1C{Account Exists?}
            S1C -->|No| S1D[Insert New AdrAccount]
            S1C -->|Yes| S1E{Manually Overridden?}
            S1E -->|Yes| S1F[Skip Protected Fields]
            S1E -->|No| S1G[Update All Fields]
            S1D --> S1H[Calculate NextRunDateTime]
            S1F --> S1H
            S1G --> S1H
        end
        
        Step1 --> Step2
        
        subgraph Step2["Step 2: Create Jobs"]
            S2A[Find Accounts with NextRunStatus = Run Now or Due Soon] --> S2B{HistoricalBillingStatus = Missing?}
            S2B -->|Yes| S2C[Skip - Needs Research]
            S2B -->|No| S2D{Job Already Exists for Period?}
            S2D -->|Yes| S2E[Skip - Duplicate Prevention]
            S2D -->|No| S2F[Create AdrJob with Status = Pending]
        end
        
        Step2 --> Step3
        
        subgraph Step3["Step 3: Process Rebill"]
            S3A[Find Accounts where ExpectedBillingDayOfWeek = Today] --> S3B{Account has CredentialId?}
            S3B -->|No| S3C[Skip]
            S3B -->|Yes| S3D{Already Processed This Week?}
            S3D -->|Yes| S3E[Skip - Idempotency]
            S3D -->|No| S3F[Call ADR API: Rebill Request with IsLastAttempt flag]
            S3F --> S3G{API Response}
            S3G -->|Success| S3H[Rebill Request Sent]
            S3G -->|Failed| S3I[Rebill Request Failed]
            S3H --> S3J[Record Result]
            S3I --> S3J
        end
        
        Step3 --> Step4
        
        subgraph Step4["Step 4: Check Statuses"]
            S4A[Find Jobs with ADR Request Sent status] --> S4B[Call ADR API: Get Status]
            S4B --> S4C{Status Response}
            S4C -->|Complete| S4D[Status = Completed<br/>Advance rule to next cycle]
            S4C -->|No Documents Found| S4E[Keep status - retry today]
            S4C -->|Failed| S4F[Status = Failed or NeedsReview]
        end
        
        Step4 --> Step5
        
        subgraph Step5["Step 5: Send ADR Requests"]
            S5A[Find Jobs where NextRunDateTime <= Today] --> S5B{Status = Pending?}
            S5B -->|No| S5C[Skip]
            S5B -->|Yes| S5D{Already Requested This Period?}
            S5D -->|Yes| S5E[Skip - Idempotency]
            S5D -->|No| S5F{NextRangeEndDateTime Passed?}
            S5F -->|Yes| S5G[Status = NeedsReview]
            S5F -->|No| S5H[Call ADR API: Download Invoice]
            S5H --> S5I{API Response}
            S5I -->|Success| S5J[Status = ADR Request Sent]
            S5I -->|Failed| S5K[Record error, retry tomorrow]
        end
        
        Step5 --> End([Orchestration Complete])
    end
    
    style Start fill:#4CAF50,color:white
    style End fill:#4CAF50,color:white
    style Step1 fill:#e3f2fd
    style Step2 fill:#fff3e0
    style Step3 fill:#f3e5f5
    style Step4 fill:#e8f5e9
    style Step5 fill:#fce4ec
